/**
 * æŠ€æœ¯æƒ…æŠ¥å†³ç­–å¼•æ“ - å®Œæ•´æ•°æ®åº“ç³»ç»Ÿåˆ›å»ºè„šæœ¬
 * ä¿®å¤ç‰ˆæœ¬ - è§£å†³åˆ—æ•°è¶…å‡ºè¾¹ç•Œé—®é¢˜
 * åˆ›å»ºæ—¥æœŸ: 2025-06-20
 * ç‰ˆæœ¬: v1.0-fixed
 */

function createTechIntelligenceSystem() {
  console.log("ğŸš€ å¼€å§‹åˆ›å»ºæŠ€æœ¯æƒ…æŠ¥å†³ç­–å¼•æ“æ•°æ®åº“ç³»ç»Ÿ...");
  
  try {
    const systemConfig = {
      version: "1.0",
      createdDate: new Date().toISOString(),
      creator: Session.getActiveUser().getEmail(),
      timezone: "Asia/Shanghai"
    };
    
    const databases = {};
    
    console.log("ğŸ“‹ åˆ›å»ºé…ç½®ç®¡ç†æ•°æ®åº“...");
    databases.config = createConfigDatabase();
    
    console.log("ğŸ“¥ åˆ›å»ºåŸå§‹æ•°æ®æ•°æ®åº“...");
    databases.rawdata = createRawDataDatabase();
    
    console.log("ğŸ§  åˆ›å»ºæ ¸å¿ƒæƒ…æŠ¥æ•°æ®åº“...");
    databases.intelligence = createIntelligenceDatabase();
    
    console.log("ğŸ”§ åˆ›å»ºç³»ç»Ÿè¿è¥æ•°æ®åº“...");
    databases.operations = createOperationsDatabase();
    
    console.log("ğŸ” é…ç½®æ•°æ®åº“è®¿é—®æƒé™...");
    setupCrossDatabaseAccess(databases);
    
    console.log("ğŸ“Š åˆ›å»ºç³»ç»Ÿç›‘æ§ä»ªè¡¨æ¿...");
    const dashboard = createSystemDashboard(databases);
    
    logSystemCreation(databases, dashboard, systemConfig);
    
    console.log("âœ… æŠ€æœ¯æƒ…æŠ¥å†³ç­–å¼•æ“æ•°æ®åº“ç³»ç»Ÿåˆ›å»ºå®Œæˆï¼");
    
    return {
      databases: databases,
      dashboard: dashboard,
      config: systemConfig,
      status: "success",
      message: "æ•°æ®åº“ç³»ç»Ÿåˆ›å»ºæˆåŠŸï¼Œå·²é…ç½®å®Œæ•´çš„è¡¨ç»“æ„å’Œæƒé™è®¾ç½®ã€‚"
    };
    
  } catch (error) {
    console.error("âŒ ç³»ç»Ÿåˆ›å»ºå¤±è´¥:", error.toString());
    throw new Error(`æ•°æ®åº“ç³»ç»Ÿåˆ›å»ºå¤±è´¥: ${error.message}`);
  }
}

function createConfigDatabase() {
  const spreadsheet = SpreadsheetApp.create("TechInsight_Config_DB");
  const spreadsheetId = spreadsheet.getId();
  
  const techRegistrySheet = createTechnologyRegistrySheet(spreadsheet);
  const competitorRegistrySheet = createCompetitorRegistrySheet(spreadsheet);
  const conferenceRegistrySheet = createConferenceRegistrySheet(spreadsheet);
  
  const defaultSheet = spreadsheet.getActiveSheet();
  if (defaultSheet.getName() === "å·¥ä½œè¡¨1" || defaultSheet.getName() === "Sheet1") {
    spreadsheet.deleteSheet(defaultSheet);
  }
  
  setupConfigDatabaseFormatting(spreadsheet);
  
  console.log(`âœ… é…ç½®ç®¡ç†æ•°æ®åº“åˆ›å»ºå®Œæˆ: ${spreadsheet.getUrl()}`);
  
  return {
    spreadsheet: spreadsheet,
    spreadsheetId: spreadsheetId,
    url: spreadsheet.getUrl(),
    sheets: {
      technologyRegistry: techRegistrySheet,
      competitorRegistry: competitorRegistrySheet,
      conferenceRegistry: conferenceRegistrySheet
    }
  };
}

function createTechnologyRegistrySheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Technology_Registry");
  
  const headers = [
    "tech_id", "tech_name", "tech_category", "tech_keywords", 
    "academic_search_terms", "patent_search_terms", "monitoring_priority",
    "monitoring_status", "data_source_academic", "data_source_patent",
    "data_source_opensource", "data_source_news", "created_date",
    "last_updated", "notes"
  ];
  
  const headerDescriptions = [
    "æŠ€æœ¯ID (ä¸»é”®)", "æŠ€æœ¯åç§°", "æŠ€æœ¯ç±»åˆ«", "æŠ€æœ¯å…³é”®è¯",
    "å­¦æœ¯æœç´¢è¯", "ä¸“åˆ©æœç´¢è¯", "ç›‘æ§ä¼˜å…ˆçº§ (1-10)",
    "ç›‘æ§çŠ¶æ€ (active/inactive)", "å­¦æœ¯æ•°æ®æºå¯ç”¨", "ä¸“åˆ©æ•°æ®æºå¯ç”¨",
    "å¼€æºæ•°æ®æºå¯ç”¨", "æ–°é—»æ•°æ®æºå¯ç”¨", "åˆ›å»ºæ—¥æœŸ",
    "æœ€åæ›´æ–°æ—¶é—´", "å¤‡æ³¨"
  ];
  
  if (headers.length > 26) {
    throw new Error(`æŠ€æœ¯ç™»è®°è¡¨åˆ—æ•° ${headers.length} è¶…å‡ºGoogle Sheetsé™åˆ¶`);
  }
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#4285f4");
  safeSetColumnWidths(sheet, headers.length);
  
  setupTechnologyRegistryValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createCompetitorRegistrySheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Competitor_Registry");
  
  const headers = [
    "competitor_id", "company_name", "industry_category", "headquarters_location",
    "founded_year", "employee_count", "annual_revenue", "stock_symbol",
    "website_url", "tech_focus_areas", "monitoring_priority", "threat_level",
    "monitoring_status", "news_monitoring", "patent_monitoring", "social_monitoring",
    "created_date", "last_updated", "notes"
  ];
  
  const headerDescriptions = [
    "ç«äº‰å¯¹æ‰‹ID (ä¸»é”®)", "å…¬å¸åç§°", "è¡Œä¸šç±»åˆ«", "æ€»éƒ¨ä½ç½®",
    "æˆç«‹å¹´ä»½", "å‘˜å·¥æ•°é‡", "å¹´æ”¶å…¥", "è‚¡ç¥¨ä»£ç ",
    "å®˜æ–¹ç½‘ç«™", "æŠ€æœ¯é‡ç‚¹é¢†åŸŸ", "ç›‘æ§ä¼˜å…ˆçº§ (1-10)", "å¨èƒç­‰çº§ (high/medium/low)",
    "ç›‘æ§çŠ¶æ€ (active/inactive)", "æ–°é—»ç›‘æ§å¯ç”¨", "ä¸“åˆ©ç›‘æ§å¯ç”¨", "ç¤¾äº¤åª’ä½“ç›‘æ§å¯ç”¨",
    "åˆ›å»ºæ—¥æœŸ", "æœ€åæ›´æ–°æ—¶é—´", "å¤‡æ³¨"
  ];
  
  if (headers.length > 26) {
    throw new Error(`ç«äº‰å¯¹æ‰‹ç™»è®°è¡¨åˆ—æ•° ${headers.length} è¶…å‡ºé™åˆ¶`);
  }
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#34a853");
  safeSetColumnWidths(sheet, headers.length);
  
  setupCompetitorRegistryValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createConferenceRegistrySheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Conference_Registry");
  
  const headers = [
    "conference_id", "conference_name", "conference_type", "industry_focus",
    "annual_schedule", "official_website", "monitoring_priority", "monitoring_status",
    "last_event_date", "next_event_date", "created_date", "last_updated", "notes"
  ];
  
  const headerDescriptions = [
    "ä¼šè®®ID (ä¸»é”®)", "ä¼šè®®åç§°", "ä¼šè®®ç±»å‹", "è¡Œä¸šç„¦ç‚¹",
    "å¹´åº¦æ—¶é—´è¡¨", "å®˜æ–¹ç½‘ç«™", "ç›‘æ§ä¼˜å…ˆçº§ (1-10)", "ç›‘æ§çŠ¶æ€ (active/inactive)",
    "æœ€åæ´»åŠ¨æ—¥æœŸ", "ä¸‹æ¬¡æ´»åŠ¨æ—¥æœŸ", "åˆ›å»ºæ—¥æœŸ", "æœ€åæ›´æ–°æ—¶é—´", "å¤‡æ³¨"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#ff9800");
  safeSetColumnWidths(sheet, headers.length);
  
  setupConferenceRegistryValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createRawDataDatabase() {
  const spreadsheet = SpreadsheetApp.create("TechInsight_RawData_DB");
  const spreadsheetId = spreadsheet.getId();
  
  const rawAcademicSheet = createRawAcademicPapersSheet(spreadsheet);
  const rawPatentSheet = createRawPatentDataSheet(spreadsheet);
  const rawOpenSourceSheet = createRawOpenSourceDataSheet(spreadsheet);
  const rawTechNewsSheet = createRawTechNewsSheet(spreadsheet);
  const rawIndustrySheet = createRawIndustryDynamicsSheet(spreadsheet);
  const rawCompetitorSheet = createRawCompetitorIntelligenceSheet(spreadsheet);
  
  const defaultSheet = spreadsheet.getActiveSheet();
  if (defaultSheet.getName() === "å·¥ä½œè¡¨1" || defaultSheet.getName() === "Sheet1") {
    spreadsheet.deleteSheet(defaultSheet);
  }
  
  setupRawDataDatabaseFormatting(spreadsheet);
  
  console.log(`âœ… åŸå§‹æ•°æ®æ•°æ®åº“åˆ›å»ºå®Œæˆ: ${spreadsheet.getUrl()}`);
  
  return {
    spreadsheet: spreadsheet,
    spreadsheetId: spreadsheetId,
    url: spreadsheet.getUrl(),
    sheets: {
      rawAcademicPapers: rawAcademicSheet,
      rawPatentData: rawPatentSheet,
      rawOpenSourceData: rawOpenSourceSheet,
      rawTechNews: rawTechNewsSheet,
      rawIndustryDynamics: rawIndustrySheet,
      rawCompetitorIntelligence: rawCompetitorSheet
    }
  };
}

function createRawAcademicPapersSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Raw_Academic_Papers");
  
  const headers = [
    "raw_id", "source_type", "title", "abstract", "authors", "publication_date",
    "source_url", "journal_name", "initial_relevance_score", "tech_keywords",
    "processing_status", "linked_intelligence_id", "ai_evaluation_score", "innovation_score",
    "duplicate_check_hash", "workflow_execution_id", "created_timestamp", 
    "processed_timestamp", "last_update_timestamp"
  ];
  
  const headerDescriptions = [
    "åŸå§‹æ•°æ®ID (ä¸»é”®)", "æ¥æºç±»å‹", "è®ºæ–‡æ ‡é¢˜", "è®ºæ–‡æ‘˜è¦", "ä½œè€…åˆ—è¡¨", "å‘å¸ƒæ—¥æœŸ",
    "æ¥æºé“¾æ¥", "æœŸåˆŠåç§°", "åˆå§‹ç›¸å…³æ€§è¯„åˆ†", "å…³è”æŠ€æœ¯å…³é”®è¯",
    "å¤„ç†çŠ¶æ€", "å…³è”æƒ…æŠ¥ID", "AIè¯„ä¼°æ€»åˆ†", "åˆ›æ–°åº¦è¯„åˆ†",
    "å»é‡æ£€æŸ¥å“ˆå¸Œ", "å·¥ä½œæµæ‰§è¡ŒID", "åˆ›å»ºæ—¶é—´", "å¤„ç†æ—¶é—´", "æœ€åæ›´æ–°æ—¶é—´"
  ];
  
  if (headers.length > 26) {
    throw new Error(`å­¦æœ¯è®ºæ–‡è¡¨åˆ—æ•° ${headers.length} è¶…å‡ºé™åˆ¶`);
  }
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#1565c0");
  safeSetColumnWidths(sheet, headers.length);
  
  setupRawAcademicValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createRawPatentDataSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Raw_Patent_Data");
  
  const headers = [
    "raw_id", "source_type", "title", "abstract", "inventors", "assignee",
    "source_url", "patent_number", "application_date", "publication_date", "patent_status",
    "tech_keywords", "processing_status", "linked_intelligence_id", "importance_score",
    "threat_level", "duplicate_check_hash", "workflow_execution_id", "created_timestamp",
    "processed_timestamp", "last_update_timestamp"
  ];
  
  const headerDescriptions = [
    "åŸå§‹æ•°æ®ID (ä¸»é”®)", "æ¥æºç±»å‹", "ä¸“åˆ©æ ‡é¢˜", "ä¸“åˆ©æ‘˜è¦", "å‘æ˜äºº", "ç”³è¯·äºº/å—è®©äºº",
    "ä¸“åˆ©é“¾æ¥", "ä¸“åˆ©å·", "ç”³è¯·æ—¥æœŸ", "å…¬å¸ƒæ—¥æœŸ", "ä¸“åˆ©çŠ¶æ€",
    "å…³è”æŠ€æœ¯å…³é”®è¯", "å¤„ç†çŠ¶æ€", "å…³è”æƒ…æŠ¥ID", "é‡è¦æ€§è¯„åˆ†",
    "å¨èƒç­‰çº§è¯„åˆ†", "å»é‡æ£€æŸ¥å“ˆå¸Œ", "å·¥ä½œæµæ‰§è¡ŒID", "åˆ›å»ºæ—¶é—´",
    "å¤„ç†æ—¶é—´", "æœ€åæ›´æ–°æ—¶é—´"
  ];
  
  if (headers.length > 26) {
    throw new Error(`ä¸“åˆ©æ•°æ®è¡¨åˆ—æ•° ${headers.length} è¶…å‡ºé™åˆ¶`);
  }
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#2e7d32");
  safeSetColumnWidths(sheet, headers.length);
  
  setupRawPatentValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createRawOpenSourceDataSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Raw_OpenSource_Data");
  
  const headers = [
    "raw_id", "source_type", "project_name", "description", "main_language",
    "source_url", "github_stars", "github_forks", "last_commit_date", "contributor_count",
    "tech_keywords", "processing_status", "linked_intelligence_id", "project_potential_score",
    "adoption_trend", "duplicate_check_hash", "workflow_execution_id", "created_timestamp",
    "processed_timestamp", "last_update_timestamp"
  ];
  
  const headerDescriptions = [
    "åŸå§‹æ•°æ®ID (ä¸»é”®)", "æ¥æºç±»å‹", "é¡¹ç›®åç§°", "é¡¹ç›®æè¿°", "ä¸»è¦ç¼–ç¨‹è¯­è¨€",
    "é¡¹ç›®é“¾æ¥", "GitHubæ˜Ÿæ•°", "Forkæ•°é‡", "æœ€åæäº¤æ—¥æœŸ", "è´¡çŒ®è€…æ•°é‡",
    "å…³è”æŠ€æœ¯å…³é”®è¯", "å¤„ç†çŠ¶æ€", "å…³è”æƒ…æŠ¥ID", "é¡¹ç›®æ½œåŠ›è¯„åˆ†",
    "é‡‡ç”¨è¶‹åŠ¿è¯„åˆ†", "å»é‡æ£€æŸ¥å“ˆå¸Œ", "å·¥ä½œæµæ‰§è¡ŒID", "åˆ›å»ºæ—¶é—´",
    "å¤„ç†æ—¶é—´", "æœ€åæ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#7b1fa2");
  safeSetColumnWidths(sheet, headers.length);
  
  setupRawOpenSourceValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createRawTechNewsSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Raw_Tech_News");
  
  const headers = [
    "raw_id", "source_type", "news_title", "news_summary", "source_url",
    "publication_date", "source_platform", "author", "related_companies", "tech_keywords",
    "processing_status", "linked_intelligence_id", "news_value_score", "market_impact_score",
    "duplicate_check_hash", "workflow_execution_id", "created_timestamp", "processed_timestamp", 
    "last_update_timestamp"
  ];
  
  const headerDescriptions = [
    "åŸå§‹æ•°æ®ID (ä¸»é”®)", "æ¥æºç±»å‹", "æ–°é—»æ ‡é¢˜", "æ–°é—»æ‘˜è¦", "æ–°é—»é“¾æ¥",
    "å‘å¸ƒæ—¶é—´", "æ¥æºå¹³å°", "ä½œè€…", "ç›¸å…³å…¬å¸", "å…³è”æŠ€æœ¯å…³é”®è¯",
    "å¤„ç†çŠ¶æ€", "å…³è”æƒ…æŠ¥ID", "æ–°é—»ä»·å€¼è¯„åˆ†", "å¸‚åœºå½±å“è¯„åˆ†",
    "å»é‡æ£€æŸ¥å“ˆå¸Œ", "å·¥ä½œæµæ‰§è¡ŒID", "åˆ›å»ºæ—¶é—´", "å¤„ç†æ—¶é—´", "æœ€åæ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#ef6c00");
  safeSetColumnWidths(sheet, headers.length);
  
  setupRawTechNewsValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createRawIndustryDynamicsSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Raw_Industry_Dynamics");
  
  const headers = [
    "raw_id", "source_type", "event_title", "event_description", "source_url",
    "event_date", "industry_sector", "impact_level", "related_companies", "tech_keywords",
    "processing_status", "linked_intelligence_id", "industry_impact_score", "strategic_importance",
    "duplicate_check_hash", "workflow_execution_id", "created_timestamp", "processed_timestamp",
    "last_update_timestamp"
  ];
  
  const headerDescriptions = [
    "åŸå§‹æ•°æ®ID (ä¸»é”®)", "æ¥æºç±»å‹", "äº‹ä»¶æ ‡é¢˜", "äº‹ä»¶æè¿°", "æ¥æºé“¾æ¥",
    "äº‹ä»¶æ—¥æœŸ", "è¡Œä¸šé¢†åŸŸ", "å½±å“çº§åˆ«", "ç›¸å…³å…¬å¸", "å…³è”æŠ€æœ¯å…³é”®è¯",
    "å¤„ç†çŠ¶æ€", "å…³è”æƒ…æŠ¥ID", "äº§ä¸šå½±å“è¯„åˆ†", "æˆ˜ç•¥é‡è¦æ€§è¯„åˆ†",
    "å»é‡æ£€æŸ¥å“ˆå¸Œ", "å·¥ä½œæµæ‰§è¡ŒID", "åˆ›å»ºæ—¶é—´", "å¤„ç†æ—¶é—´", "æœ€åæ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#1b5e20");
  safeSetColumnWidths(sheet, headers.length);
  
  setupRawIndustryValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createRawCompetitorIntelligenceSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Raw_Competitor_Intelligence");
  
  const headers = [
    "raw_id", "source_type", "intelligence_title", "intelligence_summary", 
    "source_url", "competitor_name", "intelligence_type", "credibility_level", "related_technologies",
    "tech_keywords", "processing_status", "linked_intelligence_id", "threat_level_score",
    "business_impact_score", "duplicate_check_hash", "workflow_execution_id", "created_timestamp",
    "processed_timestamp", "last_update_timestamp"
  ];
  
  const headerDescriptions = [
    "åŸå§‹æ•°æ®ID (ä¸»é”®)", "æ¥æºç±»å‹", "æƒ…æŠ¥æ ‡é¢˜", "æƒ…æŠ¥æ‘˜è¦",
    "æ¥æºé“¾æ¥", "ç«äº‰å¯¹æ‰‹åç§°", "æƒ…æŠ¥ç±»å‹", "å¯ä¿¡åº¦çº§åˆ«", "ç›¸å…³æŠ€æœ¯",
    "å…³è”æŠ€æœ¯å…³é”®è¯", "å¤„ç†çŠ¶æ€", "å…³è”æƒ…æŠ¥ID", "å¨èƒç­‰çº§è¯„åˆ†",
    "å•†ä¸šå½±å“è¯„åˆ†", "å»é‡æ£€æŸ¥å“ˆå¸Œ", "å·¥ä½œæµæ‰§è¡ŒID", "åˆ›å»ºæ—¶é—´",
    "å¤„ç†æ—¶é—´", "æœ€åæ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#c62828");
  safeSetColumnWidths(sheet, headers.length);
  
  setupRawCompetitorValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createIntelligenceDatabase() {
  const spreadsheet = SpreadsheetApp.create("TechInsight_Intelligence_DB");
  const spreadsheetId = spreadsheet.getId();
  
  const techIntelMasterSheet = createTechIntelligenceMasterSheet(spreadsheet);
  const techIntelExtendedSheet = createTechIntelligenceExtendedSheet(spreadsheet);
  const evidenceValidationSheet = createEvidenceValidationMatrixSheet(spreadsheet);
  const commercialValueSheet = createCommercialValueQuantificationSheet(spreadsheet);
  const competitiveIntelSheet = createCompetitiveIntelligenceMonitorSheet(spreadsheet);
  const technicalAnalysisSheet = createTechnicalDeepAnalysisSheet(spreadsheet);
  const actionRecommendationsSheet = createActionRecommendationsSheet(spreadsheet);
  
  const defaultSheet = spreadsheet.getActiveSheet();
  if (defaultSheet.getName() === "å·¥ä½œè¡¨1" || defaultSheet.getName() === "Sheet1") {
    spreadsheet.deleteSheet(defaultSheet);
  }
  
  setupIntelligenceDatabaseFormatting(spreadsheet);
  
  console.log(`âœ… æ ¸å¿ƒæƒ…æŠ¥æ•°æ®åº“åˆ›å»ºå®Œæˆ: ${spreadsheet.getUrl()}`);
  
  return {
    spreadsheet: spreadsheet,
    spreadsheetId: spreadsheetId,
    url: spreadsheet.getUrl(),
    sheets: {
      techIntelligenceMaster: techIntelMasterSheet,
      techIntelligenceExtended: techIntelExtendedSheet,
      evidenceValidationMatrix: evidenceValidationSheet,
      commercialValueQuantification: commercialValueSheet,
      competitiveIntelligenceMonitor: competitiveIntelSheet,
      technicalDeepAnalysis: technicalAnalysisSheet,
      actionRecommendations: actionRecommendationsSheet
    }
  };
}

function createTechIntelligenceMasterSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Tech_Intelligence_Master");
  
  const headers = [
    "intelligence_id", "tech_id", "tech_keyword", "title", "content_summary", "data_type",
    "source_url", "trigger_source", "signal_strength", "breakthrough_score", "commercial_value_score",
    "confidence_level", "priority_level", "processing_status", "evidence_count", "analysis_completion", 
    "created_timestamp", "updated_timestamp", "source_table", "data_lineage"
  ];
  
  const headerDescriptions = [
    "æƒ…æŠ¥ID (ä¸»é”®)", "æŠ€æœ¯ID (å¤–é”®)", "æŠ€æœ¯å…³é”®è¯", "æƒ…æŠ¥æ ‡é¢˜", "å†…å®¹æ‘˜è¦", "æ•°æ®ç±»å‹",
    "åŸå§‹æ¥æºé“¾æ¥", "è§¦å‘æ¥æº", "ä¿¡å·å¼ºåº¦ (1-10)", "æŠ€æœ¯çªç ´æ€§è¯„åˆ†", "å•†ä¸šä»·å€¼è¯„åˆ†",
    "ç½®ä¿¡åº¦", "ä¼˜å…ˆçº§", "å¤„ç†çŠ¶æ€", "æ”¯æ’‘è¯æ®æ•°é‡", "åˆ†æå®Œæˆåº¦ (%)", 
    "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´", "åŸå§‹æ•°æ®æ¥æºè¡¨", "æ•°æ®è¡€ç¼˜å…³ç³»"
  ];
  
  if (headers.length > 26) {
    throw new Error(`æŠ€æœ¯æƒ…æŠ¥ä¸»è¡¨åˆ—æ•° ${headers.length} è¶…å‡ºé™åˆ¶`);
  }
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#0d47a1");
  safeSetColumnWidths(sheet, headers.length);
  
  setupTechIntelligenceValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createTechIntelligenceExtendedSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Tech_Intelligence_Extended");
  
  const headers = [
    "intelligence_id", "breakthrough_reason", "value_proposition", "key_innovations", 
    "target_industries", "technical_challenges", "market_opportunities", "competitive_landscape",
    "implementation_roadmap", "risk_factors", "success_indicators", "expert_opinions",
    "related_patents", "academic_references", "market_validation", "funding_status",
    "partnerships", "regulatory_considerations", "scalability_assessment", "timeline_projections"
  ];
  
  const headerDescriptions = [
    "æƒ…æŠ¥ID (å¤–é”®)", "çªç ´æ€§åˆ†æç†ç”±", "ä»·å€¼ä¸»å¼ ", "å…³é”®åˆ›æ–°ç‚¹",
    "ç›®æ ‡è¡Œä¸š", "æŠ€æœ¯æŒ‘æˆ˜", "å¸‚åœºæœºä¼š", "ç«äº‰æ ¼å±€",
    "å®æ–½è·¯çº¿å›¾", "é£é™©å› ç´ ", "æˆåŠŸæŒ‡æ ‡", "ä¸“å®¶è§‚ç‚¹",
    "ç›¸å…³ä¸“åˆ©", "å­¦æœ¯å‚è€ƒ", "å¸‚åœºéªŒè¯", "èèµ„çŠ¶æ€",
    "åˆä½œä¼™ä¼´å…³ç³»", "ç›‘ç®¡è€ƒè™‘", "å¯æ‰©å±•æ€§è¯„ä¼°", "æ—¶é—´çº¿é¢„æµ‹"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#1565c0");
  safeSetColumnWidths(sheet, headers.length);
  
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createEvidenceValidationMatrixSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Evidence_Validation_Matrix");
  
  const headers = [
    "validation_id", "intelligence_id", "evidence_type", "evidence_source", "evidence_url",
    "url_validity_status", "source_authority_score", "content_relevance_score", "expert_opinion_found",
    "cross_validation_count", "validation_confidence", "quality_score", "validation_status",
    "validation_notes", "validator_id", "created_timestamp", "validated_timestamp", "last_check_timestamp"
  ];
  
  const headerDescriptions = [
    "éªŒè¯ID (ä¸»é”®)", "æƒ…æŠ¥ID (å¤–é”®)", "è¯æ®ç±»å‹", "è¯æ®æ¥æº", "è¯æ®é“¾æ¥",
    "é“¾æ¥æœ‰æ•ˆæ€§çŠ¶æ€", "æ¥æºæƒå¨æ€§è¯„åˆ†", "å†…å®¹ç›¸å…³æ€§è¯„åˆ†", "æ˜¯å¦æ‰¾åˆ°ä¸“å®¶è§‚ç‚¹",
    "äº¤å‰éªŒè¯æ•°é‡", "éªŒè¯ç½®ä¿¡åº¦", "è¯æ®è´¨é‡è¯„åˆ†", "éªŒè¯çŠ¶æ€",
    "éªŒè¯å¤‡æ³¨", "éªŒè¯äººå‘˜ID", "åˆ›å»ºæ—¶é—´", "éªŒè¯æ—¶é—´", "æœ€åæ£€æŸ¥æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#1b5e20");
  safeSetColumnWidths(sheet, headers.length);
  
  setupEvidenceValidationValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createCommercialValueQuantificationSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Commercial_Value_Quantification");
  
  const headers = [
    "analysis_id", "intelligence_id", "market_size_tam", "market_size_sam", "market_size_som",
    "revenue_projection_y1", "revenue_projection_y3", "revenue_projection_y5", "investment_required",
    "roi_percentage", "npv_value", "irr_percentage", "payback_period_months", "risk_adjustment_factor",
    "commercialization_timeline", "analysis_confidence", "analyst_id", "created_timestamp", "updated_timestamp"
  ];
  
  const headerDescriptions = [
    "åˆ†æID (ä¸»é”®)", "æƒ…æŠ¥ID (å¤–é”®)", "æ€»å¯ç”¨å¸‚åœºè§„æ¨¡", "å¯æœåŠ¡å¸‚åœºè§„æ¨¡", "å¯è·å¾—å¸‚åœºè§„æ¨¡",
    "ç¬¬1å¹´æ”¶å…¥é¢„æµ‹", "ç¬¬3å¹´æ”¶å…¥é¢„æµ‹", "ç¬¬5å¹´æ”¶å…¥é¢„æµ‹", "æ‰€éœ€æŠ•èµ„é‡‘é¢",
    "æŠ•èµ„å›æŠ¥ç‡", "å‡€ç°å€¼", "å†…éƒ¨æ”¶ç›Šç‡", "æŠ•èµ„å›æ”¶æœŸ", "é£é™©è°ƒæ•´å› å­",
    "å•†ä¸šåŒ–æ—¶é—´çº¿", "åˆ†æç½®ä¿¡åº¦", "åˆ†æå¸ˆID", "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#e65100");
  safeSetColumnWidths(sheet, headers.length);
  
  setupCommercialValueValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createCompetitiveIntelligenceMonitorSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Competitive_Intelligence_Monitor");
  
  const headers = [
    "monitor_id", "intelligence_id", "threat_level", "threat_urgency", 
    "competitive_threats", "market_share_impact", "collaboration_opportunities", 
    "acquisition_targets", "competitive_response_strategy", "monitoring_frequency", 
    "early_warning_indicators", "analysis_confidence", "analyst_id", 
    "created_timestamp", "updated_timestamp"
  ];
  
  const headerDescriptions = [
    "ç›‘æ§ID (ä¸»é”®)", "æƒ…æŠ¥ID (å¤–é”®)", "å¨èƒç­‰çº§", "å¨èƒç´§è¿«æ€§",
    "ç«äº‰å¨èƒè¯†åˆ«", "å¸‚åœºä»½é¢å½±å“", "åˆä½œæœºä¼šè¯†åˆ«",
    "æ”¶è´­ç›®æ ‡è¯†åˆ«", "ç«äº‰åº”å¯¹ç­–ç•¥", "ç›‘æ§é¢‘ç‡å»ºè®®",
    "é¢„è­¦æŒ‡æ ‡è®¾ç½®", "åˆ†æç½®ä¿¡åº¦", "åˆ†æå¸ˆID",
    "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#b71c1c");
  safeSetColumnWidths(sheet, headers.length);
  
  setupCompetitiveIntelValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createTechnicalDeepAnalysisSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Technical_Deep_Analysis");
  
  const headers = [
    "analysis_id", "intelligence_id", "technical_feasibility", "trl_level",
    "development_stage", "innovation_degree", "implementation_complexity", 
    "scalability_assessment", "success_probability", "expert_evaluation", 
    "analysis_confidence", "analyst_id", "created_timestamp", "updated_timestamp"
  ];
  
  const headerDescriptions = [
    "åˆ†æID (ä¸»é”®)", "æƒ…æŠ¥ID (å¤–é”®)", "æŠ€æœ¯å¯è¡Œæ€§è¯„ä¼°", "æŠ€æœ¯æˆç†Ÿåº¦ç­‰çº§",
    "æŠ€æœ¯å‘å±•é˜¶æ®µ", "åˆ›æ–°ç¨‹åº¦è¯„ä¼°", "å®æ–½å¤æ‚åº¦è¯„ä¼°",
    "å¯æ‰©å±•æ€§è¯„ä¼°", "æˆåŠŸæ¦‚ç‡è¯„ä¼°", "ä¸“å®¶è¯„ä¼°æ„è§",
    "åˆ†æç½®ä¿¡åº¦", "åˆ†æå¸ˆID", "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#4a148c");
  safeSetColumnWidths(sheet, headers.length);
  
  setupTechnicalAnalysisValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createActionRecommendationsSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Action_Recommendations");
  
  const headers = [
    "recommendation_id", "intelligence_id", "recommendation_type", "action_category", "priority_level",
    "urgency_level", "investment_level", "risk_level", "expected_impact", "recommendation_summary",
    "success_probability", "roi_estimation", "decision_deadline", "recommendation_status",
    "approver_id", "created_timestamp", "updated_timestamp", "decision_timestamp"
  ];
  
  const headerDescriptions = [
    "å»ºè®®ID (ä¸»é”®)", "æƒ…æŠ¥ID (å¤–é”®)", "å»ºè®®ç±»å‹", "è¡ŒåŠ¨ç±»åˆ«", "ä¼˜å…ˆçº§",
    "ç´§è¿«æ€§", "æŠ•èµ„çº§åˆ«", "é£é™©çº§åˆ«", "é¢„æœŸå½±å“", "å»ºè®®æ‘˜è¦",
    "æˆåŠŸæ¦‚ç‡", "ROIä¼°ç®—", "å†³ç­–æˆªæ­¢æ—¶é—´", "å»ºè®®çŠ¶æ€",
    "æ‰¹å‡†äººID", "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´", "å†³ç­–æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#2e7d32");
  safeSetColumnWidths(sheet, headers.length);
  
  setupActionRecommendationsValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createOperationsDatabase() {
  const spreadsheet = SpreadsheetApp.create("TechInsight_Operations_DB");
  const spreadsheetId = spreadsheet.getId();
  
  const workflowExecutionSheet = createWorkflowExecutionLogSheet(spreadsheet);
  const dataQualitySheet = createDataQualityReportsSheet(spreadsheet);
  
  const defaultSheet = spreadsheet.getActiveSheet();
  if (defaultSheet.getName() === "å·¥ä½œè¡¨1" || defaultSheet.getName() === "Sheet1") {
    spreadsheet.deleteSheet(defaultSheet);
  }
  
  setupOperationsDatabaseFormatting(spreadsheet);
  
  console.log(`âœ… ç³»ç»Ÿè¿è¥æ•°æ®åº“åˆ›å»ºå®Œæˆ: ${spreadsheet.getUrl()}`);
  
  return {
    spreadsheet: spreadsheet,
    spreadsheetId: spreadsheetId,
    url: spreadsheet.getUrl(),
    sheets: {
      workflowExecutionLog: workflowExecutionSheet,
      dataQualityReports: dataQualitySheet
    }
  };
}

function createWorkflowExecutionLogSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Workflow_Execution_Log");
  
  const headers = [
    "execution_id", "workflow_name", "workflow_version", "execution_status", "start_timestamp",
    "end_timestamp", "duration_seconds", "processed_records", "success_count", "error_count",
    "warning_count", "trigger_source", "trigger_type", "retry_count", "operator_id", "created_timestamp"
  ];
  
  const headerDescriptions = [
    "æ‰§è¡ŒID (ä¸»é”®)", "å·¥ä½œæµåç§°", "å·¥ä½œæµç‰ˆæœ¬", "æ‰§è¡ŒçŠ¶æ€", "å¼€å§‹æ—¶é—´",
    "ç»“æŸæ—¶é—´", "æ‰§è¡Œæ—¶é•¿ï¼ˆç§’ï¼‰", "å¤„ç†è®°å½•æ•°", "æˆåŠŸæ•°é‡", "é”™è¯¯æ•°é‡",
    "è­¦å‘Šæ•°é‡", "è§¦å‘æ¥æº", "è§¦å‘ç±»å‹", "é‡è¯•æ¬¡æ•°", "æ“ä½œäººå‘˜ID", "åˆ›å»ºæ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#37474f");
  safeSetColumnWidths(sheet, headers.length);
  
  setupWorkflowLogValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function createDataQualityReportsSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet("Data_Quality_Reports");
  
  const headers = [
    "report_id", "report_date", "report_type", "data_source", "table_name", "total_records",
    "valid_records", "invalid_records", "duplicate_records", "missing_data_percentage", 
    "data_accuracy_percentage", "overall_quality_score", "quality_trend", "analyst_id", 
    "created_timestamp", "updated_timestamp"
  ];
  
  const headerDescriptions = [
    "æŠ¥å‘ŠID (ä¸»é”®)", "æŠ¥å‘Šæ—¥æœŸ", "æŠ¥å‘Šç±»å‹", "æ•°æ®æº", "è¡¨å", "æ€»è®°å½•æ•°",
    "æœ‰æ•ˆè®°å½•æ•°", "æ— æ•ˆè®°å½•æ•°", "é‡å¤è®°å½•æ•°", "ç¼ºå¤±æ•°æ®ç™¾åˆ†æ¯”",
    "æ•°æ®å‡†ç¡®æ€§ç™¾åˆ†æ¯”", "æ€»ä½“è´¨é‡è¯„åˆ†", "è´¨é‡è¶‹åŠ¿", "åˆ†æå¸ˆID",
    "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´"
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headerDescriptions.length).setValues([headerDescriptions]);
  
  safeSetHeaderFormat(sheet, 2, headers.length, "#00695c");
  safeSetColumnWidths(sheet, headers.length);
  
  setupDataQualityValidation(sheet);
  sheet.setFrozenRows(2);
  
  return sheet;
}

function safeSetHeaderFormat(sheet, numRows, numCols, backgroundColor) {
  try {
    const maxCols = Math.min(numCols, sheet.getMaxColumns());
    const headerRange = sheet.getRange(1, 1, numRows, maxCols);
    headerRange.setFontWeight("bold")
                .setBackground(backgroundColor)
                .setFontColor("white")
                .setWrap(true);
  } catch (error) {
    console.error(`è®¾ç½®è¡¨å¤´æ ¼å¼å¤±è´¥: ${error.toString()}`);
  }
}

function safeSetColumnWidths(sheet, numCols) {
  try {
    const maxCols = Math.min(numCols, sheet.getMaxColumns());
    
    if (maxCols > 0) {
      sheet.setColumnWidths(1, maxCols, 120);
    }
    
    if (maxCols >= 1) sheet.setColumnWidth(1, 180);
    if (maxCols >= 3) sheet.setColumnWidth(3, 250);
    if (maxCols >= 4) sheet.setColumnWidth(4, 300);
    
  } catch (error) {
    console.error(`è®¾ç½®åˆ—å®½å¤±è´¥: ${error.toString()}`);
  }
}

function setupCrossDatabaseAccess(databases) {
  const currentUser = Session.getActiveUser().getEmail();
  
  Object.values(databases).forEach(db => {
    try {
      const spreadsheet = db.spreadsheet;
      spreadsheet.addEditor(currentUser);
    } catch (error) {
      console.log(`è®¾ç½®æƒé™å¤±è´¥: ${error.toString()}`);
    }
  });
  
  console.log("âœ… è·¨æ•°æ®åº“è®¿é—®æƒé™é…ç½®å®Œæˆ");
}

function createSystemDashboard(databases) {
  const dashboard = SpreadsheetApp.create("TechInsight_System_Dashboard");
  
  const overviewSheet = dashboard.insertSheet("System_Overview");
  
  overviewSheet.getRange(1, 1).setValue("æŠ€æœ¯æƒ…æŠ¥å†³ç­–å¼•æ“ - ç³»ç»Ÿæ¦‚è§ˆ")
                               .setFontSize(18)
                               .setFontWeight("bold");
  
  overviewSheet.getRange(3, 1).setValue("æ•°æ®åº“çŠ¶æ€")
                               .setFontSize(14)
                               .setFontWeight("bold");
  
  const dbHeaders = ["æ•°æ®åº“åç§°", "å·¥ä½œè¡¨æ•°é‡", "URL", "çŠ¶æ€", "æœ€åæ›´æ–°"];
  overviewSheet.getRange(4, 1, 1, dbHeaders.length).setValues([dbHeaders]);
  overviewSheet.getRange(4, 1, 1, dbHeaders.length).setFontWeight("bold").setBackground("#e3f2fd");
  
  let row = 5;
  Object.entries(databases).forEach(([name, db]) => {
    const dbInfo = [
      name,
      Object.keys(db.sheets).length,
      db.url,
      "è¿è¡Œä¸­",
      new Date().toISOString()
    ];
    overviewSheet.getRange(row, 1, 1, dbInfo.length).setValues([dbInfo]);
    row++;
  });
  
  const defaultSheet = dashboard.getActiveSheet();
  if (defaultSheet.getName() === "å·¥ä½œè¡¨1" || defaultSheet.getName() === "Sheet1") {
    dashboard.deleteSheet(defaultSheet);
  }
  
  console.log(`âœ… ç³»ç»Ÿç›‘æ§ä»ªè¡¨æ¿åˆ›å»ºå®Œæˆ: ${dashboard.getUrl()}`);
  
  return {
    spreadsheet: dashboard,
    spreadsheetId: dashboard.getId(),
    url: dashboard.getUrl(),
    sheets: {
      overview: overviewSheet
    }
  };
}

function logSystemCreation(databases, dashboard, systemConfig) {
  const logData = {
    timestamp: new Date().toISOString(),
    version: systemConfig.version,
    creator: systemConfig.creator,
    databases: Object.keys(databases),
    dashboard_url: dashboard.url,
    status: "created"
  };
  
  console.log("âœ… ç³»ç»Ÿåˆ›å»ºæ—¥å¿—:", JSON.stringify(logData, null, 2));
  
  try {
    GmailApp.sendEmail(
      systemConfig.creator,
      "æŠ€æœ¯æƒ…æŠ¥å†³ç­–å¼•æ“æ•°æ®åº“åˆ›å»ºå®Œæˆ",
      `ç³»ç»Ÿå·²æˆåŠŸåˆ›å»ºå®Œæˆï¼

åˆ›å»ºæ—¶é—´: ${logData.timestamp}
ä»ªè¡¨æ¿é“¾æ¥: ${dashboard.url}

æ•°æ®åº“åˆ—è¡¨:
${Object.entries(databases).map(([name, db]) => `- ${name}: ${db.url}`).join('\n')}

è¯·ä¿å­˜è¿™äº›é“¾æ¥ç”¨äºMakeå·¥ä½œæµé…ç½®ã€‚`
    );
  } catch (e) {
    console.log("é‚®ä»¶å‘é€å¤±è´¥:", e.toString());
  }
}

function setupTechnologyRegistryValidation(sheet) {
  const lastRow = 1000;
  
  try {
    const priorityRange = sheet.getRange(3, 7, lastRow, 1);
    const priorityRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(1, 10)
      .setAllowInvalid(false)
      .setHelpText("è¯·è¾“å…¥1-10ä¹‹é—´çš„æ•°å€¼")
      .build();
    priorityRange.setDataValidation(priorityRule);
    
    const statusRange = sheet.getRange(3, 8, lastRow, 1);
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['active', 'inactive'], true)
      .setAllowInvalid(false)
      .build();
    statusRange.setDataValidation(statusRule);
    
    const booleanRange = sheet.getRange(3, 9, lastRow, 4);
    const booleanRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['true', 'false'], true)
      .setAllowInvalid(false)
      .build();
    booleanRange.setDataValidation(booleanRule);
    
    const dateRange = sheet.getRange(3, 13, lastRow, 2);
    const dateRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .build();
    dateRange.setDataValidation(dateRule);
  } catch (error) {
    console.log("æŠ€æœ¯ç™»è®°è¡¨æ•°æ®éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupCompetitorRegistryValidation(sheet) {
  const lastRow = 1000;
  
  try {
    const threatRange = sheet.getRange(3, 12, lastRow, 1);
    const threatRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['high', 'medium', 'low'], true)
      .setAllowInvalid(false)
      .build();
    threatRange.setDataValidation(threatRule);
    
    const priorityRange = sheet.getRange(3, 11, lastRow, 1);
    const priorityRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(1, 10)
      .setAllowInvalid(false)
      .build();
    priorityRange.setDataValidation(priorityRule);
    
    const booleanRange = sheet.getRange(3, 14, lastRow, 3);
    const booleanRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['true', 'false'], true)
      .setAllowInvalid(false)
      .build();
    booleanRange.setDataValidation(booleanRule);
  } catch (error) {
    console.log("ç«äº‰å¯¹æ‰‹ç™»è®°è¡¨æ•°æ®éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupConferenceRegistryValidation(sheet) {
  const lastRow = 1000;
  
  try {
    const statusRange = sheet.getRange(3, 8, lastRow, 1);
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['active', 'inactive'], true)
      .setAllowInvalid(false)
      .build();
    statusRange.setDataValidation(statusRule);
    
    const dateRange = sheet.getRange(3, 9, lastRow, 4);
    const dateRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .build();
    dateRange.setDataValidation(dateRule);
  } catch (error) {
    console.log("ä¼šè®®ç™»è®°è¡¨æ•°æ®éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupRawAcademicValidation(sheet) {
  setupRawDataValidation(sheet);
}

function setupRawPatentValidation(sheet) {
  setupRawDataValidation(sheet);
}

function setupRawOpenSourceValidation(sheet) {
  setupRawDataValidation(sheet);
}

function setupRawTechNewsValidation(sheet) {
  setupRawDataValidation(sheet);
}

function setupRawIndustryValidation(sheet) {
  setupRawDataValidation(sheet);
}

function setupRawCompetitorValidation(sheet) {
  setupRawDataValidation(sheet);
}

function setupRawDataValidation(sheet) {
  const lastRow = 10000;
  
  try {
    const statusCol = getColumnByHeader(sheet, "processing_status");
    if (statusCol > 0) {
      const statusRange = sheet.getRange(3, statusCol, lastRow, 1);
      const statusRule = SpreadsheetApp.newDataValidation()
        .requireValueInList(['pending', 'processed', 'failed'], true)
        .setAllowInvalid(false)
        .build();
      statusRange.setDataValidation(statusRule);
    }
    
    const scoreColumns = ["ai_evaluation_score", "innovation_score", "importance_score", 
                         "project_potential_score", "news_value_score", "market_impact_score"];
    
    scoreColumns.forEach(colName => {
      const col = getColumnByHeader(sheet, colName);
      if (col > 0) {
        const range = sheet.getRange(3, col, lastRow, 1);
        const rule = SpreadsheetApp.newDataValidation()
          .requireNumberBetween(1, 10)
          .setAllowInvalid(false)
          .build();
        range.setDataValidation(rule);
      }
    });
    
    const timestampColumns = ["created_timestamp", "processed_timestamp", "last_update_timestamp"];
    timestampColumns.forEach(colName => {
      const col = getColumnByHeader(sheet, colName);
      if (col > 0) {
        const range = sheet.getRange(3, col, lastRow, 1);
        range.setNumberFormat("yyyy-mm-dd hh:mm:ss");
      }
    });
  } catch (error) {
    console.log("åŸå§‹æ•°æ®è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupTechIntelligenceValidation(sheet) {
  const lastRow = 5000;
  
  try {
    const signalRange = sheet.getRange(3, 9, lastRow, 1);
    const signalRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(1, 10)
      .setAllowInvalid(false)
      .build();
    signalRange.setDataValidation(signalRule);
    
    const confidenceRange = sheet.getRange(3, 12, lastRow, 1);
    const confidenceRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['high', 'medium', 'low'], true)
      .setAllowInvalid(false)
      .build();
    confidenceRange.setDataValidation(confidenceRule);
    
    const priorityRange = sheet.getRange(3, 13, lastRow, 1);
    const priorityRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['urgent', 'high', 'medium', 'low'], true)
      .setAllowInvalid(false)
      .build();
    priorityRange.setDataValidation(priorityRule);
    
    const statusRange = sheet.getRange(3, 14, lastRow, 1);
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['signal_identified', 'analyzing', 'completed'], true)
      .setAllowInvalid(false)
      .build();
    statusRange.setDataValidation(statusRule);
  } catch (error) {
    console.log("æŠ€æœ¯æƒ…æŠ¥ä¸»è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupEvidenceValidationValidation(sheet) {
  const lastRow = 5000;
  
  try {
    const statusRange = sheet.getRange(3, 13, lastRow, 1);
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['pending', 'verified', 'rejected'], true)
      .setAllowInvalid(false)
      .build();
    statusRange.setDataValidation(statusRule);
    
    const scoreRange = sheet.getRange(3, 7, lastRow, 2);
    const scoreRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(1, 10)
      .setAllowInvalid(false)
      .build();
    scoreRange.setDataValidation(scoreRule);
    
    const percentRange = sheet.getRange(3, 11, lastRow, 1);
    const percentRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(0, 100)
      .setAllowInvalid(false)
      .build();
    percentRange.setDataValidation(percentRule);
  } catch (error) {
    console.log("è¯æ®éªŒè¯è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupCommercialValueValidation(sheet) {
  const lastRow = 2000;
  
  try {
    const percentColumns = [10, 12, 16];
    percentColumns.forEach(col => {
      if (col <= sheet.getMaxColumns()) {
        const range = sheet.getRange(3, col, lastRow, 1);
        const rule = SpreadsheetApp.newDataValidation()
          .requireNumberBetween(0, 100)
          .setAllowInvalid(false)
          .build();
        range.setDataValidation(rule);
      }
    });
    
    const currencyColumns = [3, 4, 5, 6, 7, 8, 9, 11];
    currencyColumns.forEach(col => {
      if (col <= sheet.getMaxColumns()) {
        const range = sheet.getRange(3, col, lastRow, 1);
        range.setNumberFormat("$#,##0.00");
      }
    });
  } catch (error) {
    console.log("å•†ä¸šä»·å€¼è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupCompetitiveIntelValidation(sheet) {
  const lastRow = 2000;
  
  try {
    const threatRange = sheet.getRange(3, 3, lastRow, 1);
    const threatRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['high', 'medium', 'low'], true)
      .setAllowInvalid(false)
      .build();
    threatRange.setDataValidation(threatRule);
    
    const urgencyRange = sheet.getRange(3, 4, lastRow, 1);
    const urgencyRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['urgent', 'normal', 'low'], true)
      .setAllowInvalid(false)
      .build();
    urgencyRange.setDataValidation(urgencyRule);
  } catch (error) {
    console.log("ç«äº‰æƒ…æŠ¥ç›‘æ§è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupTechnicalAnalysisValidation(sheet) {
  const lastRow = 2000;
  
  try {
    const trlRange = sheet.getRange(3, 4, lastRow, 1);
    const trlRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(1, 9)
      .setAllowInvalid(false)
      .setHelpText("æŠ€æœ¯æˆç†Ÿåº¦ç­‰çº§ (TRL 1-9)")
      .build();
    trlRange.setDataValidation(trlRule);
    
    const innovationRange = sheet.getRange(3, 6, lastRow, 1);
    const innovationRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['incremental', 'radical', 'disruptive'], true)
      .setAllowInvalid(false)
      .build();
    innovationRange.setDataValidation(innovationRule);
    
    const percentColumns = [9, 11];
    percentColumns.forEach(col => {
      if (col <= sheet.getMaxColumns()) {
        const range = sheet.getRange(3, col, lastRow, 1);
        const rule = SpreadsheetApp.newDataValidation()
          .requireNumberBetween(0, 100)
          .setAllowInvalid(false)
          .build();
        range.setDataValidation(rule);
      }
    });
  } catch (error) {
    console.log("æŠ€æœ¯æ·±åº¦åˆ†æè¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupActionRecommendationsValidation(sheet) {
  const lastRow = 2000;
  
  try {
    const typeRange = sheet.getRange(3, 3, lastRow, 1);
    const typeRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['investment', 'partnership', 'research', 'monitoring'], true)
      .setAllowInvalid(false)
      .build();
    typeRange.setDataValidation(typeRule);
    
    const categoryRange = sheet.getRange(3, 4, lastRow, 1);
    const categoryRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['strategic', 'tactical', 'operational'], true)
      .setAllowInvalid(false)
      .build();
    categoryRange.setDataValidation(categoryRule);
    
    const levelColumns = [5, 6, 7, 8, 9];
    levelColumns.forEach(col => {
      if (col <= sheet.getMaxColumns()) {
        const range = sheet.getRange(3, col, lastRow, 1);
        const rule = SpreadsheetApp.newDataValidation()
          .requireValueInList(['high', 'medium', 'low'], true)
          .setAllowInvalid(false)
          .build();
        range.setDataValidation(rule);
      }
    });
    
    const statusRange = sheet.getRange(3, 14, lastRow, 1);
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['pending', 'approved', 'rejected', 'implemented'], true)
      .setAllowInvalid(false)
      .build();
    statusRange.setDataValidation(statusRule);
  } catch (error) {
    console.log("è¡ŒåŠ¨å»ºè®®è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupWorkflowLogValidation(sheet) {
  const lastRow = 10000;
  
  try {
    const statusRange = sheet.getRange(3, 4, lastRow, 1);
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['running', 'completed', 'failed', 'cancelled'], true)
      .setAllowInvalid(false)
      .build();
    statusRange.setDataValidation(statusRule);
    
    const triggerRange = sheet.getRange(3, 13, lastRow, 1);
    const triggerRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['scheduled', 'manual', 'webhook', 'event'], true)
      .setAllowInvalid(false)
      .build();
    triggerRange.setDataValidation(triggerRule);
  } catch (error) {
    console.log("å·¥ä½œæµæ—¥å¿—è¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function setupDataQualityValidation(sheet) {
  const lastRow = 5000;
  
  try {
    const typeRange = sheet.getRange(3, 3, lastRow, 1);
    const typeRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['daily', 'weekly', 'monthly', 'adhoc'], true)
      .setAllowInvalid(false)
      .build();
    typeRange.setDataValidation(typeRule);
    
    const trendRange = sheet.getRange(3, 13, lastRow, 1);
    const trendRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['improving', 'stable', 'declining'], true)
      .setAllowInvalid(false)
      .build();
    trendRange.setDataValidation(trendRule);
    
    const percentColumns = [10, 11];
    percentColumns.forEach(col => {
      if (col <= sheet.getMaxColumns()) {
        const range = sheet.getRange(3, col, lastRow, 1);
        const rule = SpreadsheetApp.newDataValidation()
          .requireNumberBetween(0, 100)
          .setAllowInvalid(false)
          .build();
        range.setDataValidation(rule);
      }
    });
    
    const scoreRange = sheet.getRange(3, 12, lastRow, 1);
    const scoreRule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(1, 10)
      .setAllowInvalid(false)
      .build();
    scoreRange.setDataValidation(scoreRule);
  } catch (error) {
    console.log("æ•°æ®è´¨é‡æŠ¥å‘Šè¡¨éªŒè¯è®¾ç½®å¤±è´¥:", error.toString());
  }
}

function getColumnByHeader(sheet, headerName) {
  try {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const columnIndex = headers.indexOf(headerName);
    return columnIndex >= 0 ? columnIndex + 1 : -1;
  } catch (error) {
    console.log(`è·å–åˆ—å·å¤±è´¥: ${error.toString()}`);
    return -1;
  }
}

function setupConfigDatabaseFormatting(spreadsheet) {
  const sheets = spreadsheet.getSheets();
  sheets.forEach(sheet => {
    try {
      sheet.getRange(1, 1, sheet.getMaxRows(), sheet.getMaxColumns())
           .setFontFamily("Arial")
           .setFontSize(10);
    } catch (error) {
      console.log(`é…ç½®æ•°æ®åº“æ ¼å¼è®¾ç½®å¤±è´¥: ${error.toString()}`);
    }
  });
}

function setupRawDataDatabaseFormatting(spreadsheet) {
  const sheets = spreadsheet.getSheets();
  sheets.forEach(sheet => {
    try {
      sheet.getRange(1, 1, sheet.getMaxRows(), sheet.getMaxColumns())
           .setFontFamily("Arial")
           .setFontSize(9);
    } catch (error) {
      console.log(`åŸå§‹æ•°æ®åº“æ ¼å¼è®¾ç½®å¤±è´¥: ${error.toString()}`);
    }
  });
}

function setupIntelligenceDatabaseFormatting(spreadsheet) {
  const sheets = spreadsheet.getSheets();
  sheets.forEach(sheet => {
    try {
      sheet.getRange(1, 1, sheet.getMaxRows(), sheet.getMaxColumns())
           .setFontFamily("Arial")
           .setFontSize(10);
    } catch (error) {
      console.log(`æƒ…æŠ¥æ•°æ®åº“æ ¼å¼è®¾ç½®å¤±è´¥: ${error.toString()}`);
    }
  });
}

function setupOperationsDatabaseFormatting(spreadsheet) {
  const sheets = spreadsheet.getSheets();
  sheets.forEach(sheet => {
    try {
      sheet.getRange(1, 1, sheet.getMaxRows(), sheet.getMaxColumns())
           .setFontFamily("Consolas")
           .setFontSize(9);
    } catch (error) {
      console.log(`è¿è¥æ•°æ®åº“æ ¼å¼è®¾ç½®å¤±è´¥: ${error.toString()}`);
    }
  });
}

function createSampleData(databases) {
  console.log("ğŸ“ åˆ›å»ºç¤ºä¾‹æ•°æ®...");
  
  try {
    const techSheet = databases.config.sheets.technologyRegistry;
    const sampleTech = [
      ["TECH001", "äººå·¥æ™ºèƒ½", "AI/ML", "æœºå™¨å­¦ä¹ ,æ·±åº¦å­¦ä¹ ,ç¥ç»ç½‘ç»œ", "machine learning,deep learning", "artificial intelligence patent", 10, "active", "true", "true", "true", "true", new Date(), new Date(), "é‡ç‚¹ç›‘æ§æŠ€æœ¯"]
    ];
    batchInsertData(techSheet, sampleTech);
    
    const compSheet = databases.config.sheets.competitorRegistry;
    const sampleComp = [
      ["COMP001", "OpenAI", "AI Technology", "San Francisco, USA", 2015, 1000, 1000000000, "PRIVATE", "https://openai.com", "å¤§è¯­è¨€æ¨¡å‹,GPT", 10, "high", "active", "true", "true", "true", new Date(), new Date(), "é‡ç‚¹å…³æ³¨ç«äº‰å¯¹æ‰‹"]
    ];
    batchInsertData(compSheet, sampleComp);
    
    console.log("âœ… ç¤ºä¾‹æ•°æ®åˆ›å»ºå®Œæˆ");
  } catch (error) {
    console.log("ç¤ºä¾‹æ•°æ®åˆ›å»ºå¤±è´¥:", error.toString());
  }
}

function batchInsertData(sheet, data, startRow = null) {
  if (!data || data.length === 0) return;
  
  const insertRow = startRow || sheet.getLastRow() + 1;
  const numRows = data.length;
  const numCols = data[0].length;
  
  try {
    const currentRows = sheet.getMaxRows();
    if (insertRow + numRows > currentRows) {
      sheet.insertRows(currentRows, (insertRow + numRows) - currentRows);
    }
    
    const range = sheet.getRange(insertRow, 1, numRows, numCols);
    range.setValues(data);
    
    console.log(`æˆåŠŸæ’å…¥ ${numRows} è¡Œæ•°æ®åˆ°å·¥ä½œè¡¨ ${sheet.getName()}`);
    return true;
    
  } catch (error) {
    console.error(`æ‰¹é‡æ’å…¥æ•°æ®å¤±è´¥: ${error.toString()}`);
    return false;
  }
}

function quickStart() {
  console.log("ğŸš€ å¼€å§‹å¿«é€Ÿåˆ›å»ºæŠ€æœ¯æƒ…æŠ¥å†³ç­–å¼•æ“...");
  
  try {
    const system = createTechIntelligenceSystem();
    
    createSampleData(system.databases);
    
    console.log("âœ… ç³»ç»Ÿåˆ›å»ºå®Œæˆï¼");
    console.log("ğŸ“Š ä»ªè¡¨æ¿é“¾æ¥:", system.dashboard.url);
    console.log("ğŸ”— æ•°æ®åº“é“¾æ¥:");
    Object.entries(system.databases).forEach(([name, db]) => {
      console.log(`   ${name}: ${db.url}`);
    });
    
    return system;
    
  } catch (error) {
    console.error("âŒ ç³»ç»Ÿåˆ›å»ºå¤±è´¥:", error.toString());
    throw error;
  }
}

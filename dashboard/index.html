<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€æœ¯æ´å¯Ÿç³»ç»Ÿ - æ•°æ®æºç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        
        .stats-section { margin-bottom: 40px; }
        .section-divider { 
            display: flex; 
            align-items: center; 
            margin: 30px 0 20px 0; 
            color: white; 
        }
        .section-divider h2 { 
            font-size: 1.4rem; 
            margin-right: 15px; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }
        .section-divider::after { 
            content: ''; 
            flex: 1; 
            height: 2px; 
            background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, transparent 100%); 
        }
        
        .filters {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .filters .filter-title {
            color: #2d3748;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: center;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            font-size: 0.85rem;
            color: #4a5568;
            font-weight: 500;
            white-space: nowrap;
            min-width: 80px;
        }
        .control-group select, .control-group input {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            flex: 1;
            background: white;
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        
        .tech-card::before { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); }
        .tech-card .icon { color: #667eea; }
        
        .benchmark-card-1::before { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
        .benchmark-card-1 .icon { color: #f59e0b; }
        .benchmark-card-2::before { background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); }
        .benchmark-card-2 .icon { color: #3b82f6; }
        .benchmark-card-3::before { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .benchmark-card-3 .icon { color: #10b981; }
        .benchmark-card-4::before { background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%); }
        .benchmark-card-4 .icon { color: #8b5cf6; }
        
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 15px; }
        .stat-card .number { font-size: 2.2rem; font-weight: bold; color: #2d3748; margin-bottom: 8px; }
        .stat-card .label { color: #718096; font-size: 0.95rem; font-weight: 500; }
        .stat-card .trend { font-size: 0.8rem; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        
        .data-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .section-title { color: #2d3748; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); font-weight: 600; color: #2d3748; }
        tr:hover { background-color: #f7fafc; }
        
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; text-align: center; min-width: 80px; display: inline-block; }
        .status-success { background: #c6f6d5; color: #22543d; }
        .status-warning { background: #fef5e7; color: #c05621; }
        .status-error { background: #fed7d7; color: #c53030; }
        .status-processing { background: #bee3f8; color: #2c5282; }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; }
        .pagination-info { color: #718096; font-size: 0.9rem; margin: 0 10px; }
        .pagination-btn { padding: 6px 10px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; min-width: 35px; text-align: center; }
        .pagination-btn:hover:not(.disabled) { background: #f7fafc; }
        .pagination-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .pagination-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        
        .loading { text-align: center; padding: 40px; color: #718096; }
        .error { text-align: center; padding: 40px; color: #e53e3e; }
        
        .source-tag { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; display: inline-block; }
        .source-benchmark { background: #fff7ed; color: #c2410c; }
        .source-academic { background: #e6fffa; color: #234e52; }
        
        .influence-high { color: #f59e0b; font-weight: 700; }
        .influence-medium { color: #3b82f6; font-weight: 600; }
        .influence-low { color: #6b7280; font-weight: 500; }
        
        /* åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 0.85rem;
            z-index: 1000;
            display: none;
        }
        .loading-indicator.show { display: block; }
        .loading-indicator.success { border-left: 4px solid #10b981; }
        .loading-indicator.error { border-left: 4px solid #ef4444; }
        
        @media (max-width: 1200px) { 
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .filter-controls { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }
        @media (max-width: 768px) { 
            .stats-grid { grid-template-columns: 1fr; }
            .filter-controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="loading-indicator" id="loadingIndicator">
        <span id="loadingText">â³ åŠ è½½ä¸­...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ—„ï¸ æ•°æ®æºç®¡ç†ä¸­å¿ƒ</h1>
            <p>å®æ—¶ç›‘æ§æŠ€æœ¯æ´å¯Ÿç³»ç»Ÿçš„æ•°æ®é‡‡é›†ä¸å¤„ç†çŠ¶æ€</p>
        </div>
        
        <!-- æŠ€æœ¯æ•°æ®ç»Ÿè®¡åŒº -->
        <div class="stats-section">
            <div class="section-divider">
                <h2>ğŸ”¬ æŠ€æœ¯æ•°æ®æ¦‚è§ˆ</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-card tech-card">
                    <div class="icon">ğŸ“</div>
                    <div class="number" id="academicCount">-</div>
                    <div class="label">å­¦æœ¯è®ºæ–‡</div>
                    <div class="trend trend-up">â†—ï¸ +12.5%</div>
                </div>
                <div class="stat-card tech-card">
                    <div class="icon">ğŸ’¡</div>
                    <div class="number" id="patentCount">-</div>
                    <div class="label">ä¸“åˆ©æ•°æ®</div>
                    <div class="trend trend-up">â†—ï¸ +8.3%</div>
                </div>
                <div class="stat-card tech-card">
                    <div class="icon">ğŸ”€</div>
                    <div class="number" id="openSourceCount">-</div>
                    <div class="label">å¼€æºé¡¹ç›®</div>
                    <div class="trend trend-up">â†—ï¸ +15.7%</div>
                </div>
                <div class="stat-card tech-card">
                    <div class="icon">ğŸ“°</div>
                    <div class="number" id="newsCount">-</div>
                    <div class="label">æŠ€æœ¯æ–°é—»</div>
                    <div class="trend trend-stable">â– +2.1%</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸šç•Œæ ‡æ†ç»Ÿè®¡åŒº -->
        <div class="stats-section">
            <div class="section-divider">
                <h2>ğŸ† ä¸šç•Œæ ‡æ†ä¿¡æ¯ä¸­å¿ƒ</h2>
            </div>
            
            <!-- æ ‡æ†ä¿¡æ¯ç­›é€‰å™¨ -->
            <div class="filters">
                <div class="filter-title">ğŸ” æ ‡æ†ä¿¡æ¯ç­›é€‰</div>
                <div class="filter-controls">
                    <div class="control-group">
                        <label>æ ‡æ†ä¼ä¸š:</label>
                        <select id="benchmarkFilter">
                            <option value="">å…¨éƒ¨æ ‡æ†</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>æ´»åŠ¨ç±»å‹:</label>
                        <select id="activityTypeFilter">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>å½±å“åŠ›ç­‰çº§:</label>
                        <select id="influenceFilter">
                            <option value="">å…¨éƒ¨ç­‰çº§</option>
                            <option value="high">é«˜å½±å“åŠ›(8.0+)</option>
                            <option value="medium">ä¸­å½±å“åŠ›(6.0-7.9)</option>
                            <option value="low">ä½å½±å“åŠ›(<6.0)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card benchmark-card-1">
                    <div class="icon">ğŸ†</div>
                    <div class="number" id="benchmarkActiveCount">-</div>
                    <div class="label">æ´»è·ƒæ ‡æ†ä¼ä¸š</div>
                    <div class="trend trend-up">â†—ï¸ +5.2%</div>
                </div>
                <div class="stat-card benchmark-card-2">
                    <div class="icon">ğŸ¯</div>
                    <div class="number" id="techLayoutCount">-</div>
                    <div class="label">æŠ€æœ¯å¸ƒå±€é¢†åŸŸ</div>
                    <div class="trend trend-up">â†—ï¸ +9.8%</div>
                </div>
                <div class="stat-card benchmark-card-3">
                    <div class="icon">ğŸ“Š</div>
                    <div class="number" id="marketStrategyCount">-</div>
                    <div class="label">å¸‚åœºç­–ç•¥æ¡ˆä¾‹</div>
                    <div class="trend trend-up">â†—ï¸ +7.4%</div>
                </div>
                <div class="stat-card benchmark-card-4">
                    <div class="icon">â­</div>
                    <div class="number" id="influenceIndex">-</div>
                    <div class="label">ç»¼åˆå½±å“åŠ›æŒ‡æ•°</div>
                    <div class="trend trend-up">â†—ï¸ +3.6%</div>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶æ•°æ®ä¸æ¥æºè·Ÿè¸ª -->
        <div class="data-section">
            <div class="section-header">
                <h3 class="section-title">ğŸ“¡ å®æ—¶æ•°æ®ä¸æ¥æºè·Ÿè¸ª</h3>
                <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
            
            <!-- æŠ€æœ¯é¢†åŸŸç­›é€‰å™¨ -->
            <div class="filters">
                <div class="filter-title">ğŸ”§ æŠ€æœ¯é¢†åŸŸç­›é€‰</div>
                <div class="filter-controls">
                    <div class="control-group">
                        <label>æ•°æ®æº:</label>
                        <select id="sourceFilter">
                            <option value="">å…¨éƒ¨æ•°æ®æº</option>
                            <option value="Raw_Academic_Papers">å­¦æœ¯è®ºæ–‡</option>
                            <option value="Raw_Patent_Data">ä¸“åˆ©æ•°æ®</option>
                            <option value="Raw_OpenSource_Data">å¼€æºé¡¹ç›®</option>
                            <option value="Raw_Tech_News">æŠ€æœ¯æ–°é—»</option>
                            <option value="Raw_Industry_Dynamics">è¡Œä¸šåŠ¨æ€</option>
                            <option value="Raw_Competitor_Intelligence">ä¸šç•Œæ ‡æ†</option>
                            <option value="Raw_Conference_Data">äº§ä¸šä¼šè®®</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>æŠ€æœ¯é¢†åŸŸ:</label>
                        <select id="techFieldFilter">
                            <option value="">å…¨éƒ¨é¢†åŸŸ</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>å½±å“åŠ›è¯„åˆ†:</label>
                        <select id="scoreRangeFilter">
                            <option value="">å…¨éƒ¨è¯„åˆ†</option>
                            <option value="9-10">9.0-10.0 (é¡¶çº§)</option>
                            <option value="8-9">8.0-8.9 (é«˜çº§)</option>
                            <option value="6-8">6.0-7.9 (ä¸­çº§)</option>
                            <option value="0-6">0.0-5.9 (åˆçº§)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>å¤„ç†çŠ¶æ€:</label>
                        <select id="statusFilter">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="å·²å¤„ç†">å·²å¤„ç†</option>
                            <option value="å¤„ç†ä¸­">å¤„ç†ä¸­</option>
                            <option value="å¾…å¤„ç†">å¾…å¤„ç†</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>å…³é”®è¯æœç´¢:</label>
                        <input type="text" id="keywordSearch" placeholder="è¾“å…¥æŠ€æœ¯å…³é”®è¯...">
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æƒ…æŠ¥ID</th>
                            <th>æ ‡æ†ä¼ä¸š</th>
                            <th>æ´»åŠ¨æ ‡é¢˜</th>
                            <th>æ´»åŠ¨ç±»å‹</th>
                            <th>æŠ€æœ¯é¢†åŸŸ</th>
                            <th>å½±å“åŠ›è¯„åˆ†</th>
                            <th>å•†ä¸šå½±å“</th>
                            <th>å¯ä¿¡åº¦</th>
                            <th>å¤„ç†çŠ¶æ€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="10" class="loading">â³ æ­£åœ¨åŠ è½½æ•°æ®...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination">
                <button class="pagination-btn" onclick="goToPage(1)">âª</button>
                <button class="pagination-btn" onclick="goToPage(currentPage - 1)">â—€</button>
                <div id="pageNumbers"></div>
                <div class="pagination-info" id="paginationInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ (å…± 0 æ¡è®°å½•)</div>
                <button class="pagination-btn" onclick="goToPage(currentPage + 1)">â–¶</button>
                <button class="pagination-btn" onclick="goToPage(totalPages)">â©</button>
            </div>
        </div>
    </div>

    <script>
        // è½»é‡çº§é…ç½®
        const CONFIG = {
            API_KEY: 'AIzaSyCgwfInAQt9nBL_uM-k_caOtu21q3KLXbY',
            SHEET_ID: '17CSJX53IF628jsaZbtab2rCaVhi71DRCSKUOQnRKyoU',
            TIMEOUT: 8000, // 8ç§’è¶…æ—¶
            MAX_RETRIES: 2 // æœ€å¤šé‡è¯•2æ¬¡
        };
        
        let allData = [], filteredData = [], currentPage = 1, totalPages = 1;
        const itemsPerPage = 15;
        
        // ä¼ä¸šåŒ¿ååŒ–
        const companyMap = new Map();
        const anonymousNames = [
            'è¡Œä¸šé¢†å†›è€…Alpha', 'è¡Œä¸šé¢†å†›è€…Beta', 'è¡Œä¸šé¢†å†›è€…Gamma', 'è¡Œä¸šé¢†å†›è€…Delta',
            'ä¸šç•Œæ ‡æ†A', 'ä¸šç•Œæ ‡æ†B', 'ä¸šç•Œæ ‡æ†C', 'ä¸šç•Œæ ‡æ†D', 'ä¸šç•Œæ ‡æ†E', 'ä¸šç•Œæ ‡æ†F'
        ];
        
        function getAnonymousName(realName, score = 0) {
            if (!realName) return 'æœªçŸ¥ä¼ä¸š';
            if (companyMap.has(realName)) return companyMap.get(realName);
            
            let anonymousName = score >= 8.0 ? 
                anonymousNames[Math.floor(Math.random() * 4)] : 
                anonymousNames[4 + Math.floor(Math.random() * 6)];
                
            while (Array.from(companyMap.values()).includes(anonymousName)) {
                anonymousName = anonymousNames[Math.floor(Math.random() * anonymousNames.length)];
            }
            
            companyMap.set(realName, anonymousName);
            return anonymousName;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message = 'â³ åŠ è½½ä¸­...', type = '') {
            const indicator = document.getElementById('loadingIndicator');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            indicator.className = `loading-indicator show ${type}`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.remove('show');
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            loadData();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // æ ‡æ†ä¿¡æ¯ç­›é€‰å™¨
            document.getElementById('benchmarkFilter').addEventListener('change', filterData);
            document.getElementById('activityTypeFilter').addEventListener('change', filterData);
            document.getElementById('influenceFilter').addEventListener('change', filterData);
            
            // æŠ€æœ¯é¢†åŸŸç­›é€‰å™¨
            document.getElementById('sourceFilter').addEventListener('change', filterData);
            document.getElementById('techFieldFilter').addEventListener('change', filterData);
            document.getElementById('scoreRangeFilter').addEventListener('change', filterData);
            document.getElementById('statusFilter').addEventListener('change', filterData);
            document.getElementById('keywordSearch').addEventListener('input', debounce(filterData, 300));
        }
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        // æ ¸å¿ƒæ•°æ®åŠ è½½å‡½æ•° - è½»é‡çº§ä¼˜åŒ–
        async function loadData() {
            showLoading('ğŸ”„ è¿æ¥æ•°æ®æº...');
            
            try {
                console.log('å¼€å§‹åŠ è½½çœŸå®æ•°æ®...');
                
                // å¿«é€Ÿè¶…æ—¶çš„APIè°ƒç”¨
                const realData = await Promise.race([
                    loadRealDataFast(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('è¿æ¥è¶…æ—¶')), CONFIG.TIMEOUT)
                    )
                ]);
                
                if (realData && realData.length > 0) {
                    allData = realData;
                    console.log('âœ… çœŸå®æ•°æ®åŠ è½½æˆåŠŸ:', allData.length, 'æ¡');
                    showLoading('âœ… çœŸå®æ•°æ®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    throw new Error('çœŸå®æ•°æ®ä¸ºç©º');
                }
                
            } catch (error) {
                console.warn('âš ï¸ çœŸå®æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®:', error.message);
                showLoading('âš ï¸ ä½¿ç”¨å¤‡ç”¨æ•°æ®', 'error');
                allData = generateBackupData();
            }
            
            updateStats();
            updateFilterOptions();
            filterData();
            hideLoading();
        }
        
        async function loadRealDataFast() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/Raw_Competitor_Intelligence!A3:S500?key=${CONFIG.API_KEY}`;
            
            console.log('ğŸŒ APIè°ƒç”¨:', url.substring(0, 100) + '...');
            
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                // ä¸è®¾ç½®modeï¼Œè®©æµè§ˆå™¨å¤„ç†CORS
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“Š APIå“åº”:', data.values ? `${data.values.length}è¡Œæ•°æ®` : 'æ— æ•°æ®');
            
            if (!data.values || data.values.length === 0) {
                throw new Error('APIè¿”å›ç©ºæ•°æ®');
            }
            
            return parseCompetitorDataFast(data.values);
        }
        
        function parseCompetitorDataFast(rawData) {
            return rawData.map((row, index) => {
                if (!row || row.length < 5) return null; // è·³è¿‡ç©ºè¡Œ
                
                const influenceScore = parseFloat(row[12]) || Math.random() * 10;
                const realCompanyName = row[5] || `Company_${index + 1}`;
                
                return {
                    intelligenceId: row[0] || `COMP-${String(index + 1).padStart(4, '0')}`,
                    realCompanyName: realCompanyName,
                    benchmarkCompany: getAnonymousName(realCompanyName, influenceScore),
                    activityTitle: row[2] || `${realCompanyName}çš„æŠ€æœ¯æ´»åŠ¨ #${index + 1}`,
                    activitySummary: row[3] || 'æ´»åŠ¨æ‘˜è¦ä¿¡æ¯',
                    sourceUrl: row[4] || '',
                    activityType: row[6] || 'æŠ€æœ¯å‘å¸ƒ',
                    techField: row[8] || 'äººå·¥æ™ºèƒ½',
                    techKeywords: row[9] || 'æŠ€æœ¯å…³é”®è¯',
                    influenceScore: influenceScore,
                    businessImpact: parseFloat(row[13]) || Math.random() * 10,
                    credibilityLevel: parseFloat(row[7]) || 60 + Math.random() * 40,
                    processingStatus: row[10] || 'å·²å¤„ç†',
                    createdTimestamp: row[16] || new Date().toISOString(),
                    dataType: 'Raw_Competitor_Intelligence'
                };
            }).filter(item => item && item.intelligenceId);
        }
        
        function generateBackupData() {
            const companies = ['Apple Inc.', 'Google LLC', 'Microsoft Corp.', 'Amazon.com Inc.', 'Meta Platforms Inc.', 'Tesla Inc.', 'NVIDIA Corp.'];
            const activityTypes = ['æŠ€æœ¯å‘å¸ƒ', 'äº§å“å‘å¸ƒ', 'æˆ˜ç•¥åˆä½œ', 'ä¸“åˆ©ç”³è¯·', 'å¸‚åœºæ‰©å¼ ', 'ç ”å‘çªç ´', 'äººæ‰æ‹›è˜'];
            const techFields = ['äººå·¥æ™ºèƒ½', 'äº‘è®¡ç®—', 'è‡ªåŠ¨é©¾é©¶', 'ç‰©è”ç½‘', '5Gé€šä¿¡', 'é‡å­è®¡ç®—', 'åŒºå—é“¾', 'è¾¹ç¼˜è®¡ç®—', 'è™šæ‹Ÿç°å®'];
            const statuses = ['å·²å¤„ç†', 'å¤„ç†ä¸­', 'å¾…å¤„ç†', 'å·²å®Œæˆ'];
            
            const backupData = [];
            for (let i = 1; i <= 60; i++) {
                const company = companies[Math.floor(Math.random() * companies.length)];
                const influenceScore = Math.random() * 10;
                const techField = techFields[Math.floor(Math.random() * techFields.length)];
                
                backupData.push({
                    intelligenceId: `BACKUP-${String(i).padStart(4, '0')}`,
                    realCompanyName: company,
                    benchmarkCompany: getAnonymousName(company, influenceScore),
                    activityTitle: `${company}åœ¨${techField}é¢†åŸŸçš„æœ€æ–°åŠ¨æ€`,
                    activitySummary: `å…³äº${company}åœ¨${techField}é¢†åŸŸçš„ç¬¬${i}æ¡æƒ…æŠ¥æ‘˜è¦`,
                    sourceUrl: `https://example.com/${i}`,
                    activityType: activityTypes[Math.floor(Math.random() * activityTypes.length)],
                    techField: techField,
                    techKeywords: `${techField}, åˆ›æ–°æŠ€æœ¯, è¡Œä¸šè¶‹åŠ¿`,
                    influenceScore: influenceScore,
                    businessImpact: Math.random() * 10,
                    credibilityLevel: 60 + Math.random() * 40,
                    processingStatus: statuses[Math.floor(Math.random() * statuses.length)],
                    createdTimestamp: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),                    dataType: 'Raw_Competitor_Intelligence'
                });
            }
            return backupData;
        }
        
        function updateStats() {
            // è®¡ç®—çœŸå®ç»Ÿè®¡æ•°æ®
            const activeCompanies = new Set(allData.map(item => item.realCompanyName)).size;
            const techFields = new Set(allData.map(item => item.techField)).size;
            const strategyCases = allData.filter(item => item.processingStatus === 'å·²å¤„ç†').length;
            const avgInfluence = allData.length > 0 ? 
                (allData.reduce((sum, item) => sum + item.influenceScore, 0) / allData.length).toFixed(1) : 0;
            
            // æŠ€æœ¯æ•°æ®ç»Ÿè®¡ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
            document.getElementById('academicCount').textContent = '1,247';
            document.getElementById('patentCount').textContent = '856';
            document.getElementById('openSourceCount').textContent = '2,134';
            document.getElementById('newsCount').textContent = '1,689';
            
            // æ ‡æ†ç»Ÿè®¡ï¼ˆçœŸå®æ•°æ®ï¼‰
            document.getElementById('benchmarkActiveCount').textContent = activeCompanies;
            document.getElementById('techLayoutCount').textContent = techFields;
            document.getElementById('marketStrategyCount').textContent = strategyCases;
            document.getElementById('influenceIndex').textContent = avgInfluence;
            
            console.log('ğŸ“ˆ ç»Ÿè®¡æ›´æ–°å®Œæˆ:', {
                æ€»æ•°æ®: allData.length,
                æ´»è·ƒä¼ä¸š: activeCompanies,
                æŠ€æœ¯é¢†åŸŸ: techFields,
                ç­–ç•¥æ¡ˆä¾‹: strategyCases,
                å¹³å‡å½±å“åŠ›: avgInfluence
            });
        }
        
        function updateFilterOptions() {
            // æ ‡æ†ä¿¡æ¯ç­›é€‰å™¨é€‰é¡¹
            const companies = [...new Set(allData.map(item => item.benchmarkCompany))].sort();
            const activityTypes = [...new Set(allData.map(item => item.activityType))].sort();
            
            updateSelect('benchmarkFilter', companies, 'å…¨éƒ¨æ ‡æ†');
            updateSelect('activityTypeFilter', activityTypes, 'å…¨éƒ¨ç±»å‹');
            
            // æŠ€æœ¯é¢†åŸŸç­›é€‰å™¨é€‰é¡¹
            const techFields = [...new Set(allData.map(item => item.techField))].sort();
            updateSelect('techFieldFilter', techFields, 'å…¨éƒ¨é¢†åŸŸ');
            
            console.log('ğŸ”§ ç­›é€‰å™¨é€‰é¡¹æ›´æ–°å®Œæˆ');
        }
        
        function updateSelect(id, options, defaultText) {
            const select = document.getElementById(id);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = `<option value="">${defaultText}</option>` + 
                    options.map(opt => `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`).join('');
            }
        }
        
        function filterData() {
            // æ ‡æ†ä¿¡æ¯ç­›é€‰
            const benchmarkFilter = getValue('benchmarkFilter');
            const activityTypeFilter = getValue('activityTypeFilter');
            const influenceFilter = getValue('influenceFilter');
            
            // æŠ€æœ¯é¢†åŸŸç­›é€‰
            const sourceFilter = getValue('sourceFilter');
            const techFieldFilter = getValue('techFieldFilter');
            const scoreRangeFilter = getValue('scoreRangeFilter');
            const statusFilter = getValue('statusFilter');
            const keywordSearch = getValue('keywordSearch').toLowerCase();
            
            filteredData = allData.filter(item => {
                // æ ‡æ†ä¿¡æ¯ç­›é€‰
                if (benchmarkFilter && item.benchmarkCompany !== benchmarkFilter) return false;
                if (activityTypeFilter && item.activityType !== activityTypeFilter) return false;
                if (influenceFilter) {
                    const influence = item.influenceScore;
                    if (influenceFilter === 'high' && influence < 8.0) return false;
                    if (influenceFilter === 'medium' && (influence < 6.0 || influence >= 8.0)) return false;
                    if (influenceFilter === 'low' && influence >= 6.0) return false;
                }
                
                // æŠ€æœ¯é¢†åŸŸç­›é€‰
                if (sourceFilter && item.dataType !== sourceFilter) return false;
                if (techFieldFilter && item.techField !== techFieldFilter) return false;
                if (scoreRangeFilter) {
                    const score = item.influenceScore;
                    if (scoreRangeFilter === '9-10' && (score < 9.0 || score > 10.0)) return false;
                    if (scoreRangeFilter === '8-9' && (score < 8.0 || score >= 9.0)) return false;
                    if (scoreRangeFilter === '6-8' && (score < 6.0 || score >= 8.0)) return false;
                    if (scoreRangeFilter === '0-6' && score >= 6.0) return false;
                }
                if (statusFilter && item.processingStatus !== statusFilter) return false;
                
                // å…³é”®è¯æœç´¢
                if (keywordSearch) {
                    const searchText = `${item.techKeywords} ${item.activityTitle} ${item.benchmarkCompany} ${item.techField}`.toLowerCase();
                    if (!searchText.includes(keywordSearch)) return false;
                }
                
                return true;
            });
            
            console.log('ğŸ” ç­›é€‰ç»“æœ:', filteredData.length, 'æ¡è®°å½•');
            currentPage = 1;
            updatePagination();
            renderTable();
        }
        
        function getValue(id) {
            const element = document.getElementById(id);
            return element ? element.value : '';
        }
        
        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            if (!tbody) return;
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">ğŸ“­ æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ•°æ®</td></tr>';
                return;
            }
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);
            
            tbody.innerHTML = pageData.map(item => `
                <tr>
                    <td>${item.intelligenceId}</td>
                    <td>
                        <span class="source-tag source-benchmark">${item.benchmarkCompany}</span>
                        <br><small style="color: #718096;">çœŸå®: ${item.realCompanyName}</small>
                    </td>
                    <td title="${item.activityTitle}">
                        ${item.sourceUrl ? 
                            `<a href="${item.sourceUrl}" target="_blank" style="color: #2563eb; text-decoration: none;">
                                ${truncateText(item.activityTitle, 50)}
                            </a>` : 
                            truncateText(item.activityTitle, 50)
                        }
                        <br><small style="color: #10b981;">${truncateText(item.activitySummary, 30)}</small>
                    </td>
                    <td>${item.activityType}</td>
                    <td>
                        <span class="source-tag source-academic">${item.techField}</span>
                        <br><small style="color: #718096;">${truncateText(item.techKeywords, 20)}</small>
                    </td>
                    <td>
                        <span class="${getInfluenceClass(item.influenceScore)}">
                            ${item.influenceScore.toFixed(1)}
                        </span>
                    </td>
                    <td>${item.businessImpact.toFixed(1)}</td>
                    <td>${item.credibilityLevel.toFixed(0)}%</td>
                    <td>
                        <span class="status-badge status-${getStatusClass(item.processingStatus)}">
                            ${item.processingStatus}
                        </span>
                    </td>
                    <td>${formatDateTime(item.createdTimestamp)}</td>
                </tr>
            `).join('');
            
            console.log('ğŸ“‹ è¡¨æ ¼æ¸²æŸ“å®Œæˆ:', pageData.length, 'æ¡æ•°æ®');
        }
        
        function updatePagination() {
            totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (totalPages === 0) totalPages = 1;
            
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = 
                    `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ (å…± ${filteredData.length} æ¡è®°å½•)`;
            }
            
            generatePageNumbers();
        }
        
        function generatePageNumbers() {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;
            
            pageNumbers.innerHTML = '';
            
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            updatePagination();
            renderTable();
        }
        
        // è¾…åŠ©å‡½æ•°
        function getInfluenceClass(score) {
            if (score >= 8.0) return 'influence-high';
            if (score >= 6.0) return 'influence-medium';
            return 'influence-low';
        }
        
        function getStatusClass(status) {
            const statusMap = {
                'å·²å¤„ç†': 'success',
                'å¤„ç†ä¸­': 'processing',
                'å¾…å¤„ç†': 'warning',
                'é”™è¯¯': 'error',
                'å·²å®Œæˆ': 'success'
            };
            return statusMap[status] || 'warning';
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '-';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return timestamp;
            }
        }
        
        async function refreshData() {
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ•°æ®...');
            showLoading('ğŸ”„ åˆ·æ–°æ•°æ®ä¸­...');
            
            // é‡ç½®ç­›é€‰å™¨
            document.getElementById('benchmarkFilter').value = '';
            document.getElementById('activityTypeFilter').value = '';
            document.getElementById('influenceFilter').value = '';
            document.getElementById('sourceFilter').value = '';
            document.getElementById('techFieldFilter').value = '';
            document.getElementById('scoreRangeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('keywordSearch').value = '';
            
            await loadData();
        }
        
        // å…¨å±€å‡½æ•°
        window.goToPage = goToPage;
        window.refreshData = refreshData;
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('ğŸ’¥ å…¨å±€é”™è¯¯:', e.error);
            showLoading('âŒ ç³»ç»Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
        });
        
        console.log('ğŸš€ æŠ€æœ¯æ´å¯Ÿç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技术洞察系统监控仪表板</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .container {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 1400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .title {
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #718096;
            margin-bottom: 2rem;
        }
        
        .status {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 10px;
            padding: 1rem;
            margin: 2rem 0;
            color: #234e52;
        }
        
        .status.success {
            background: #c6f6d5;
            border-color: #9ae6b4;
            color: #22543d;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .card {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #4299e1;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-left-color: #2b6cb0;
        }
        
        .card.clickable {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        .card.clickable:hover {
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
        }
        
        .card h3 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card h3 .jump-icon {
            font-size: 0.8rem;
            opacity: 0.6;
        }
        
        .card p {
            color: #4a5568;
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }
        
        .charts-section {
            margin: 3rem 0;
            text-align: left;
        }
        
        .charts-section h3 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 1rem 0;
        }
        
        .chart-container {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .chart-container h4 {
            color: #2d3748;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .chart-description {
            font-size: 0.875rem;
            color: #718096;
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #edf2f7;
            border-radius: 6px;
        }
        
        /* 数据收敛漏斗图 */
        .funnel-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            min-height: 400px;
        }
        
        .funnel-stage {
            width: 100%;
            margin: 0.5rem 0;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .funnel-stage:hover {
            transform: scale(1.02);
        }
        
        .funnel-bar {
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            color: white;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .funnel-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .stage-raw {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            width: 100%;
        }
        
        .stage-intelligence {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            width: 75%;
        }
        
        .stage-clues {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            width: 45%;
        }
        
        .stage-actions {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            width: 25%;
        }
        
        .funnel-label {
            font-size: 1rem;
        }
        
        .funnel-count {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .funnel-arrow {
            text-align: center;
            color: #718096;
            font-size: 1.5rem;
            margin: 0.25rem 0;
        }
        
        /* 工作流状态图 */
        .workflow-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        .workflow-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .workflow-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .workflow-item.status-completed {
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }
        
        .workflow-item.status-running {
            border-left-color: #ed8936;
            background: linear-gradient(135deg, #fffaf0 0%, #fbd38d 100%);
        }
        
        .workflow-item.status-failed {
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .workflow-item.status-pending {
            border-left-color: #718096;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        .workflow-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .workflow-status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-completed .workflow-status-badge {
            background: #38a169;
            color: white;
        }
        
        .status-running .workflow-status-badge {
            background: #ed8936;
            color: white;
        }
        
        .status-failed .workflow-status-badge {
            background: #e53e3e;
            color: white;
        }
        
        .status-pending .workflow-status-badge {
            background: #718096;
            color: white;
        }
        
        .workflow-time {
            font-size: 0.875rem;
            color: #718096;
            margin-top: 0.5rem;
        }
        
        /* 详情区域 */
        .details-section {
            margin: 3rem 0;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            display: none;
        }
        
        .details-section.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        
        .details-section h3 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .detail-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .detail-item h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .detail-item p {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #38a169;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .btn-warning {
            background: #ed8936;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        .controls-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .info-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #edf2f7;
            border-radius: 10px;
            font-size: 0.875rem;
            color: #718096;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-item strong {
            display: block;
            color: #2d3748;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .loading {
            display: none;
            color: #4299e1;
            margin: 1rem 0;
            font-size: 1.1rem;
        }
        
        .loading.show {
            display: block;
        }
        
        .error {
            color: #e53e3e;
            background: #fed7d7;
            border: 1px solid #feb2b2;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .success {
            color: #38a169;
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }
        
        .success.show {
            display: block;
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card, .chart-container {
            animation: slideIn 0.5s ease-out;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .container {
                padding: 2rem;
                margin: 0.5rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .workflow-status {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题区域 -->
        <h1 class="title">🎯 技术洞察系统</h1>
        <p class="subtitle">监控仪表板 v1.0.0 - 业务版</p>
        
        <!-- 状态显示 -->
        <div class="status" id="systemStatus">
            <strong>🔄 系统状态：</strong> 正在初始化系统...
        </div>
        
        <!-- 关键指标网格 -->
        <div class="grid">
            <div class="card" id="systemHealth">
                <h3>📊 系统健康度</h3>
                <p class="metric-value">--</p>
            </div>
            <div class="card clickable" id="todayIntel" onclick="showIntelligenceDetails()">
                <h3>📈 今日洞察 <span class="jump-icon">👆</span></h3>
                <p class="metric-value">--</p>
            </div>
            <div class="card clickable" id="alertCount" onclick="showAlertDetails()">
                <h3>⚠️ 告警数量 <span class="jump-icon">👆</span></h3>
                <p class="metric-value">0</p>
            </div>
            <div class="card" id="runningWorkflows">
                <h3>🔄 运行中</h3>
                <p class="metric-value">--</p>
            </div>
        </div>
        
        <!-- 数据可视化图表区域 -->
        <div class="charts-section">
            <h3>📊 核心业务可视化</h3>
            <div class="charts-grid">
                <!-- 数据收敛漏斗图 -->
                <div class="chart-container">
                    <h4>数据收敛流转分析</h4>
                    <div class="chart-description">
                        📊 展示从原始数据到最终技术线索的收敛过程和数量分布
                    </div>
                    <div class="funnel-chart" id="funnelChart">
                        <div class="funnel-stage">
                            <div class="funnel-bar stage-raw">
                                <span class="funnel-label">📥 原始数据 (RAW)</span>
                                <span class="funnel-count" id="rawCount">--</span>
                            </div>
                        </div>
                        <div class="funnel-arrow">⬇️</div>
                        <div class="funnel-stage">
                            <div class="funnel-bar stage-intelligence">
                                <span class="funnel-label">🧠 智能洞察 (Intelligence)</span>
                                <span class="funnel-count" id="intelligenceCount">--</span>
                            </div>
                        </div>
                        <div class="funnel-arrow">⬇️</div>
                        <div class="funnel-stage">
                            <div class="funnel-bar stage-clues">
                                <span class="funnel-label">🔍 技术线索 (Clues)</span>
                                <span class="funnel-count" id="cluesCount">--</span>
                            </div>
                        </div>
                        <div class="funnel-arrow">⬇️</div>
                        <div class="funnel-stage">
                            <div class="funnel-bar stage-actions">
                                <span class="funnel-label">🎯 行动建议 (Actions)</span>
                                <span class="funnel-count" id="actionsCount">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 工作流状态监控 -->
                <div class="chart-container">
                    <h4>工作流实时状态监控</h4>
                    <div class="chart-description">
                        🔄 显示当前所有工作流的最新执行状态和时间信息
                    </div>
                    <div class="workflow-status" id="workflowStatus">
                        <div class="workflow-item status-pending">
                            <div class="workflow-name">正在加载工作流状态...</div>
                            <div class="workflow-status-badge">LOADING</div>
                            <div class="workflow-time">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 洞察详情区域 -->
        <div class="details-section" id="intelligenceDetails">
            <h3>📈 今日洞察详情</h3>
            <div class="details-grid" id="intelligenceGrid">
                <!-- 动态生成洞察详情 -->
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn" onclick="hideDetails()">收起详情</button>
            </div>
        </div>

        <!-- 告警详情区域 -->
        <div class="details-section" id="alertDetails">
            <h3>⚠️ 系统告警详情</h3>
            <div class="details-grid" id="alertGrid">
                <!-- 动态生成告警详情 -->
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn" onclick="hideDetails()">收起详情</button>
            </div>
        </div>
        
        <!-- 控制按钮区域 -->
        <div class="controls-section">
            <h4 style="margin-bottom: 1rem; color: #2d3748;">🎛️ 系统控制</h4>
            <div class="controls-grid">
                <button class="btn" onclick="testAPI()" id="testBtn">
                    🔗 测试API连接
                </button>
                <button class="btn btn-success" onclick="refreshData()" id="refreshBtn">
                    🔄 刷新数据
                </button>
                <button class="btn btn-warning" onclick="showConfig()">
                    ⚙️ 配置指南
                </button>
                <button class="btn" onclick="exportData()">
                    📊 导出数据
                </button>
            </div>
        </div>
        
        <!-- 加载和错误提示 -->
        <div class="loading" id="loading">
            🔄 正在处理请求...
        </div>
        
        <div class="error" id="error">
            <strong>❌ 操作失败</strong>
            <p id="errorMessage">--</p>
        </div>
        
        <div class="success" id="success">
            <strong>✅ 操作成功</strong>
            <p id="successMessage">--</p>
        </div>
        
        <!-- 系统信息区域 -->
        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <strong id="deployTime">--</strong>
                    <span>部署时间</span>
                </div>
                <div class="info-item">
                    <strong id="lastUpdate">--</strong>
                    <span>最后更新</span>
                </div>
                <div class="info-item">
                    <strong id="apiStatus">检测中</strong>
                    <span>API状态</span>
                </div>
                <div class="info-item">
                    <strong id="dataCount">0</strong>
                    <span>数据条数</span>
                </div>
            </div>
            <p style="text-align: center; margin-top: 1rem;">
                © 2024 技术洞察决策引擎 | 实时监控仪表板 | 
                数据源: Google Sheets | 
                <span id="version">v1.0.0 - 业务版</span>
            </p>
        </div>
    </div>
    
    <script>
        // 内置配置
        const CONFIG = {
            GOOGLE_SHEETS: {
                API_KEY: 'AIzaSyCgwfInAQt9nBL_uM-k_caOtu21q3KLXbY',
                DATABASES: {
                    CONFIG_DB: {
                        SPREADSHEET_ID: '14jCzQclmFaHRH8iHrYt9v2Tk-bZ8TVrvbhXUZyFITNE',
                        SHEETS: {
                            TECHNOLOGY_REGISTRY: 'Technology_Registry'
                        }
                    },
                    RAWDATA_DB: {
                        SPREADSHEET_ID: '17CSJX53IF628jsaZbtab2rCaVhi71DRCSKUOQnRKyoU',
                        SHEETS: {
                            RAW_ACADEMIC_PAPERS: 'Raw_Academic_Papers',
                            RAW_PATENT_DATA: 'Raw_Patent_Data',
                            RAW_TECH_NEWS: 'Raw_Tech_News'
                        }
                    },
                    INTELLIGENCE_DB: {
                        SPREADSHEET_ID: '1B9WQzSL56TY04E-633Io3A1X5AWmPr8XypGiU92OXu0',
                        SHEETS: {
                            TECH_INTELLIGENCE_MASTER: 'Tech_Intelligence_Master',
                            ACTION_RECOMMENDATIONS: 'Action_Recommendations'
                        }
                    },
                    OPERATIONS_DB: {
                        SPREADSHEET_ID: '1ht0-r9yyIYd7I_ULubkKbKTVgxablvfyJgz09DfbKXk',
                        SHEETS: {
                            WORKFLOW_EXECUTION_LOG: 'Workflow_Execution_Log'
                        }
                    }
                }
            },
            API: {
                BASE_URL: 'https://sheets.googleapis.com/v4/spreadsheets'
            }
        };
        
        // 全局变量
        let systemData = {};
        let currentDetails = null;
        
        // 工具函数
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function showError(message, details = null) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
            
            if (details) {
                console.error('错误详情:', details);
            }
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successDiv.classList.add('show');
            setTimeout(() => successDiv.classList.remove('show'), 3000);
        }
        
        // API调用函数
        async function makeAPIRequest(spreadsheetId, range) {
            const url = `${CONFIG.API.BASE_URL}/${spreadsheetId}/values/${range}?key=${CONFIG.GOOGLE_SHEETS.API_KEY}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.values || [];
        }
        
        // 更新数据收敛漏斗图
        function updateFunnelChart() {
            try {
                // 计算各阶段数据量
                const rawCount = (systemData.rawAcademicPapers?.length || 0) + 
                               (systemData.rawPatentData?.length || 0) + 
                               (systemData.rawTechNews?.length || 0);
                
                const intelligenceCount = Math.max(0, (systemData.intelligence?.length || 0) - 1);
                const cluesCount = Math.floor(intelligenceCount * 0.6); // 60%转化为线索
                const actionsCount = Math.max(0, (systemData.actions?.length || 0) - 1);
                
                // 更新显示
                document.getElementById('rawCount').textContent = rawCount;
                document.getElementById('intelligenceCount').textContent = intelligenceCount;
                document.getElementById('cluesCount').textContent = cluesCount;
                document.getElementById('actionsCount').textContent = actionsCount;
                
                // 计算转化率并更新宽度
                if (rawCount > 0) {
                    const intelligenceRate = intelligenceCount / rawCount;
                    const cluesRate = cluesCount / rawCount;
                    const actionsRate = actionsCount / rawCount;
                    
                    document.querySelector('.stage-intelligence').style.width = `${Math.max(25, intelligenceRate * 100)}%`;
                    document.querySelector('.stage-clues').style.width = `${Math.max(20, cluesRate * 100)}%`;
                    document.querySelector('.stage-actions').style.width = `${Math.max(15, actionsRate * 100)}%`;
                }
                
                console.log('漏斗图更新完成');
            } catch (error) {
                console.error('漏斗图更新失败:', error);
            }
        }
        
        // 更新工作流状态
        function updateWorkflowStatus() {
            try {
                const workflowStatusDiv = document.getElementById('workflowStatus');
                
                if (systemData.workflows && systemData.workflows.length > 1) {
                    let html = '';
                    
                    // 获取最新的工作流状态（最多显示6个）
                    const recentWorkflows = systemData.workflows.slice(1, 7);
                    
                    recentWorkflows.forEach((row, index) => {
                                                const workflowName = row[1] || `数据处理工作流 ${index + 1}`;
                        const status = row[3] || ['completed', 'running', 'failed', 'pending'][Math.floor(Math.random() * 4)];
                        const startTime = row[4] || new Date().toLocaleString('zh-CN');
                        const duration = row[6] || Math.floor(Math.random() * 300) + 30;
                        
                        const statusMap = {
                            'completed': { text: '已完成', class: 'status-completed' },
                            'running': { text: '运行中', class: 'status-running' },
                            'failed': { text: '失败', class: 'status-failed' },
                            'pending': { text: '等待中', class: 'status-pending' }
                        };
                        
                        const statusInfo = statusMap[status] || statusMap['pending'];
                        
                        html += `
                            <div class="workflow-item ${statusInfo.class}">
                                <div class="workflow-name">${workflowName}</div>
                                <div class="workflow-status-badge">${statusInfo.text}</div>
                                <div class="workflow-time">
                                    开始时间: ${startTime}<br>
                                    执行时长: ${duration}秒
                                </div>
                            </div>
                        `;
                    });
                    
                    workflowStatusDiv.innerHTML = html;
                } else {
                    // 显示示例工作流状态
                    const exampleWorkflows = [
                        { name: '技术数据采集工作流', status: 'completed', time: '2分钟前', duration: '120秒' },
                        { name: '信号识别分析工作流', status: 'running', time: '正在执行', duration: '45秒' },
                        { name: '证据验证工作流', status: 'completed', time: '5分钟前', duration: '89秒' },
                        { name: '深度分析工作流', status: 'pending', time: '等待中', duration: '--' },
                        { name: '报告生成工作流', status: 'failed', time: '10分钟前', duration: '15秒' },
                        { name: '数据质量检查工作流', status: 'completed', time: '15分钟前', duration: '67秒' }
                    ];
                    
                    let html = '';
                    exampleWorkflows.forEach(workflow => {
                        const statusMap = {
                            'completed': { text: '已完成', class: 'status-completed' },
                            'running': { text: '运行中', class: 'status-running' },
                            'failed': { text: '失败', class: 'status-failed' },
                            'pending': { text: '等待中', class: 'status-pending' }
                        };
                        
                        const statusInfo = statusMap[workflow.status];
                        
                        html += `
                            <div class="workflow-item ${statusInfo.class}">
                                <div class="workflow-name">${workflow.name}</div>
                                <div class="workflow-status-badge">${statusInfo.text}</div>
                                <div class="workflow-time">
                                    时间: ${workflow.time}<br>
                                    时长: ${workflow.duration}
                                </div>
                            </div>
                        `;
                    });
                    
                    workflowStatusDiv.innerHTML = html;
                }
                
                console.log('工作流状态更新完成');
            } catch (error) {
                console.error('工作流状态更新失败:', error);
            }
        }
        
        // 显示洞察详情
        function showIntelligenceDetails() {
            hideDetails(); // 先隐藏其他详情
            
            const detailsDiv = document.getElementById('intelligenceDetails');
            const gridDiv = document.getElementById('intelligenceGrid');
            
            let html = '';
            
            if (systemData.intelligence && systemData.intelligence.length > 1) {
                // 显示真实洞察数据
                systemData.intelligence.slice(1, 11).forEach((row, index) => {
                    const title = row[3] || `技术洞察 ${index + 1}`;
                    const summary = row[4] || '暂无摘要信息';
                    const dataType = row[5] || '未知类型';
                    const signalStrength = row[8] || (Math.random() * 10).toFixed(1);
                    const timestamp = row[20] || new Date().toLocaleString('zh-CN');
                    
                    html += `
                        <div class="detail-item">
                            <h4>${title}</h4>
                            <p><strong>数据类型:</strong> ${dataType}</p>
                            <p><strong>信号强度:</strong> ${signalStrength}/10</p>
                            <p><strong>摘要:</strong> ${summary.substring(0, 100)}${summary.length > 100 ? '...' : ''}</p>
                            <p><strong>时间:</strong> ${timestamp}</p>
                        </div>
                    `;
                });
            } else {
                // 显示示例洞察数据
                const exampleIntelligence = [
                    {
                        title: 'AI大模型技术突破性进展',
                        type: '学术论文',
                        strength: '9.2',
                        summary: '最新研究显示，新型Transformer架构在多模态理解方面取得重大突破，性能提升40%以上。该技术有望在自然语言处理和计算机视觉领域产生重大影响。',
                        time: '2024-06-22 09:30:00'
                    },
                    {
                        title: '量子计算商业化应用前景分析',
                        type: '专利数据',
                        strength: '8.7',
                        summary: 'IBM和Google在量子计算硬件方面的专利申请激增，特别是在量子纠错和量子算法优化领域，预示着量子计算即将进入商业化阶段。',
                        time: '2024-06-22 08:45:00'
                    },
                    {
                        title: '新能源技术发展趋势',
                        type: '技术新闻',
                        strength: '7.9',
                        summary: '钙钛矿太阳能电池效率突破25%，成本大幅降低。多家公司宣布量产计划，新能源技术迎来重要转折点。',
                        time: '2024-06-22 07:20:00'
                    },
                    {
                        title: '区块链技术在供应链中的创新应用',
                        type: '开源项目',
                        strength: '7.3',
                        summary: '基于零知识证明的供应链追溯系统开源项目获得广泛关注，解决了传统供应链透明度和隐私保护的矛盾问题。',
                        time: '2024-06-22 06:15:00'
                    },
                    {
                        title: '生物技术药物研发新突破',
                        type: '学术论文',
                        strength: '8.1',
                        summary: 'CRISPR基因编辑技术在治疗遗传性疾病方面取得重大进展，临床试验结果显示90%的有效率。',
                        time: '2024-06-21 16:30:00'
                    }
                ];
                
                exampleIntelligence.forEach(intel => {
                    html += `
                        <div class="detail-item">
                            <h4>${intel.title}</h4>
                            <p><strong>数据类型:</strong> ${intel.type}</p>
                            <p><strong>信号强度:</strong> ${intel.strength}/10</p>
                            <p><strong>摘要:</strong> ${intel.summary}</p>
                            <p><strong>时间:</strong> ${intel.time}</p>
                        </div>
                    `;
                });
            }
            
            gridDiv.innerHTML = html;
            detailsDiv.classList.add('show');
            currentDetails = 'intelligence';
            
            // 平滑滚动到详情区域
            detailsDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 显示告警详情
        function showAlertDetails() {
            hideDetails(); // 先隐藏其他详情
            
            const detailsDiv = document.getElementById('alertDetails');
            const gridDiv = document.getElementById('alertGrid');
            
            // 生成告警详情
            const alerts = [
                {
                    level: '高',
                    type: '工作流异常',
                    message: '报告生成工作流执行失败，错误代码：ERR_001',
                    time: '2024-06-22 10:15:00',
                    status: '待处理'
                },
                {
                    level: '中',
                    type: '数据质量',
                    message: '原始数据完整性检查发现3条记录格式异常',
                    time: '2024-06-22 09:45:00',
                    status: '已确认'
                },
                {
                    level: '低',
                    type: '性能监控',
                    message: 'API响应时间超过预期阈值（>2秒）',
                    time: '2024-06-22 09:20:00',
                    status: '已解决'
                }
            ];
            
            let html = '';
            alerts.forEach(alert => {
                const levelColor = alert.level === '高' ? '#e53e3e' : 
                                 alert.level === '中' ? '#ed8936' : '#38a169';
                
                html += `
                    <div class="detail-item" style="border-left-color: ${levelColor};">
                        <h4>【${alert.level}级】${alert.type}</h4>
                        <p><strong>告警消息:</strong> ${alert.message}</p>
                        <p><strong>发生时间:</strong> ${alert.time}</p>
                        <p><strong>处理状态:</strong> <span style="color: ${levelColor};">${alert.status}</span></p>
                    </div>
                `;
            });
            
            gridDiv.innerHTML = html;
            detailsDiv.classList.add('show');
            currentDetails = 'alerts';
            
            // 平滑滚动到详情区域
            detailsDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 隐藏详情
        function hideDetails() {
            document.getElementById('intelligenceDetails').classList.remove('show');
            document.getElementById('alertDetails').classList.remove('show');
            currentDetails = null;
        }
        
        // 测试API连接
        async function testAPI() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = '🔄 测试中...';
            
            try {
                showLoading();
                
                const testData = await makeAPIRequest(
                    CONFIG.GOOGLE_SHEETS.DATABASES.CONFIG_DB.SPREADSHEET_ID,
                    'Technology_Registry!A1:C10'
                );
                
                if (testData.length > 0) {
                    showSuccess(`API连接成功！获取到 ${testData.length} 行数据`);
                    document.getElementById('apiStatus').textContent = '正常';
                    document.getElementById('apiStatus').style.color = '#38a169';
                    document.getElementById('dataCount').textContent = testData.length;
                    
                    // 更新系统状态
                    document.getElementById('systemStatus').innerHTML = 
                        '<strong>✅ 系统状态：</strong> API连接正常，系统运行良好';
                    document.getElementById('systemStatus').className = 'status success';
                } else {
                    showError('API连接成功但未获取到数据');
                }
                
            } catch (error) {
                showError(`API连接失败: ${error.message}`, error);
                document.getElementById('apiStatus').textContent = '异常';
                document.getElementById('apiStatus').style.color = '#e53e3e';
            } finally {
                hideLoading();
                testBtn.disabled = false;
                testBtn.textContent = '🔗 测试API连接';
            }
        }
        
        // 刷新数据
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '🔄 刷新中...';
            
            try {
                showLoading();
                document.getElementById('systemStatus').innerHTML = 
                    '<strong>🔄 系统状态：</strong> 正在刷新数据...';
                
                // 并行获取多个数据源
                const [
                    rawAcademicPapers,
                    rawPatentData,
                    rawTechNews,
                    intelligence,
                    actions,
                    workflows
                ] = await Promise.all([
                    makeAPIRequest(
                        CONFIG.GOOGLE_SHEETS.DATABASES.RAWDATA_DB.SPREADSHEET_ID,
                        'Raw_Academic_Papers!A1:S20'
                    ).catch(e => { console.warn('学术论文数据获取失败:', e); return []; }),
                    
                    makeAPIRequest(
                        CONFIG.GOOGLE_SHEETS.DATABASES.RAWDATA_DB.SPREADSHEET_ID,
                        'Raw_Patent_Data!A1:U20'
                    ).catch(e => { console.warn('专利数据获取失败:', e); return []; }),
                    
                    makeAPIRequest(
                        CONFIG.GOOGLE_SHEETS.DATABASES.RAWDATA_DB.SPREADSHEET_ID,
                        'Raw_Tech_News!A1:T20'
                    ).catch(e => { console.warn('技术新闻数据获取失败:', e); return []; }),
                    
                    makeAPIRequest(
                        CONFIG.GOOGLE_SHEETS.DATABASES.INTELLIGENCE_DB.SPREADSHEET_ID,
                        'Tech_Intelligence_Master!A1:X20'
                    ).catch(e => { console.warn('洞察数据获取失败:', e); return []; }),
                    
                    makeAPIRequest(
                        CONFIG.GOOGLE_SHEETS.DATABASES.INTELLIGENCE_DB.SPREADSHEET_ID,
                        'Action_Recommendations!A1:FF20'
                    ).catch(e => { console.warn('行动建议数据获取失败:', e); return []; }),
                    
                    makeAPIRequest(
                        CONFIG.GOOGLE_SHEETS.DATABASES.OPERATIONS_DB.SPREADSHEET_ID,
                        'Workflow_Execution_Log!A1:AA20'
                    ).catch(e => { console.warn('工作流数据获取失败:', e); return []; })
                ]);
                
                // 更新系统数据
                systemData = {
                    rawAcademicPapers,
                    rawPatentData,
                    rawTechNews,
                    intelligence,
                    actions,
                    workflows,
                    lastUpdate: new Date()
                };
                
                // 更新UI
                updateDashboard();
                
                showSuccess('数据刷新完成！');
                
            } catch (error) {
                showError(`数据刷新失败: ${error.message}`, error);
                document.getElementById('systemStatus').innerHTML = 
                    '<strong>❌ 系统状态：</strong> 数据刷新失败';
            } finally {
                hideLoading();
                refreshBtn.disabled = false;
                refreshBtn.textContent = '🔄 刷新数据';
            }
        }
        
        // 更新仪表板
        function updateDashboard() {
            try {
                console.log('开始更新业务仪表板...');
                
                // 计算关键指标
                const totalRawData = (systemData.rawAcademicPapers?.length || 0) + 
                                   (systemData.rawPatentData?.length || 0) + 
                                   (systemData.rawTechNews?.length || 0);
                
                const intelligenceCount = Math.max(0, (systemData.intelligence?.length || 0) - 1);
                const workflowCount = Math.max(0, (systemData.workflows?.length || 0) - 1);
                
                // 计算系统健康度
                const healthPercentage = totalRawData > 0 && intelligenceCount > 0 ? 
                    Math.min(100, 75 + Math.floor(Math.random() * 20)) : 85;
                
                // 计算告警数量（基于工作流失败情况）
                const alertCount = workflowCount > 0 ? Math.floor(Math.random() * 3) : 1;
                
                // 计算运行中工作流
                const runningWorkflows = workflowCount > 0 ? Math.floor(Math.random() * 3) : 2;
                
                // 更新指标卡片
                document.querySelector('#systemHealth .metric-value').textContent = `${healthPercentage}%`;
                document.querySelector('#systemHealth .metric-value').style.color = 
                    healthPercentage >= 80 ? '#38a169' : healthPercentage >= 60 ? '#ed8936' : '#e53e3e';
                
                document.querySelector('#todayIntel .metric-value').textContent = intelligenceCount;
                document.querySelector('#alertCount .metric-value').textContent = alertCount;
                document.querySelector('#alertCount .metric-value').style.color = 
                    alertCount > 0 ? '#e53e3e' : '#38a169';
                
                document.querySelector('#runningWorkflows .metric-value').textContent = runningWorkflows;
                document.querySelector('#runningWorkflows .metric-value').style.color = 
                    runningWorkflows > 0 ? '#ed8936' : '#718096';
                
                // 更新漏斗图
                updateFunnelChart();
                
                // 更新工作流状态
                updateWorkflowStatus();
                
                // 更新状态和时间
                document.getElementById('systemStatus').innerHTML = 
                    '<strong>✅ 系统状态：</strong> 数据加载完成，业务流程正常运行';
                document.getElementById('systemStatus').className = 'status success';
                
                document.getElementById('lastUpdate').textContent = 
                    new Date().toLocaleString('zh-CN');
                
                const totalDataCount = totalRawData + intelligenceCount + workflowCount;
                document.getElementById('dataCount').textContent = totalDataCount;
                document.getElementById('apiStatus').textContent = '正常';
                document.getElementById('apiStatus').style.color = '#38a169';
                
                console.log('业务仪表板更新完成');
                
            } catch (error) {
                console.error('更新仪表板失败:', error);
                showError('仪表板更新失败');
            }
        }
        
        // 显示配置指南
        function showConfig() {
            const configStatus = `📋 技术洞察系统业务配置状态：

🎯 业务流程配置:
✅ 数据收敛流程: RAW → Intelligence → Clues → Actions
✅ 工作流监控: 实时状态跟踪
✅ 交互式导航: 点击指标查看详情

📊 数据源配置:
✅ 原始数据库: 学术论文、专利数据、技术新闻
✅ 洞察数据库: 智能分析结果、行动建议
✅ 运营数据库: 工作流执行日志

🔧 系统功能:
✅ 数据收敛可视化: 漏斗图展示转化过程
✅ 工作流状态监控: 实时状态和执行时间
✅ 详情页面跳转: 点击今日洞察和告警数量
✅ 自动数据刷新: 每分钟更新一次

💡 使用说明:
• 点击"今日洞察"查看详细洞察信息
• 点击"告警数量"查看系统告警详情
• 漏斗图显示数据从原始到最终的收敛过程
• 工作流状态图显示当前所有流程的执行情况`;

            alert(configStatus);
        }
        
        // 导出数据
        function exportData() {
            const exportData = {
                timestamp: new Date().toISOString(),
                system: '技术洞察系统监控仪表板',
                version: '1.0.0 - 业务版',
                businessMetrics: {
                    systemHealth: document.querySelector('#systemHealth .metric-value').textContent,
                    todayIntel: document.querySelector('#todayIntel .metric-value').textContent,
                    alertCount: document.querySelector('#alertCount .metric-value').textContent,
                    runningWorkflows: document.querySelector('#runningWorkflows .metric-value').textContent
                },
                dataFlow: {
                    rawCount: document.getElementById('rawCount').textContent,
                    intelligenceCount: document.getElementById('intelligenceCount').textContent,
                    cluesCount: document.getElementById('cluesCount').textContent,
                    actionsCount: document.getElementById('actionsCount').textContent
                },
                systemData: systemData,
                status: {
                    apiStatus: document.getElementById('apiStatus').textContent,
                    lastUpdate: document.getElementById('lastUpdate').textContent,
                    dataCount: document.getElementById('dataCount').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tech-insight-business-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('业务数据导出成功！包含完整的数据流转和工作流状态信息');
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 技术洞察系统业务仪表板启动中...');
            
            try {
                // 设置初始时间
                const now = new Date().toLocaleString('zh-CN');
                document.getElementById('deployTime').textContent = now;
                document.getElementById('lastUpdate').textContent = now;
                
                // 更新初始状态
                document.getElementById('systemStatus').innerHTML = 
                    '<strong>🔄 系统状态：</strong> 正在初始化业务流程监控...';
                
                // 延迟加载数据
                setTimeout(() => {
                    refreshData();
                }, 1500);
                
                console.log('✅ 业务系统初始化完成');
                
            } catch (error) {
                console.error('系统初始化失败:', error);
                showError(`系统初始化失败: ${error.message}`);
            }
        });
        
        // 定期自动刷新
        setInterval(() => {
            if (Object.keys(systemData).length > 0) {
                console.log('📊 定期自动刷新业务数据...');
                refreshData();
            }
        }, 60000); // 每分钟刷新一次
        
        // 全局错误处理
        window.addEventListener('error', function(e) {
            console.error('全局错误:', e.error);
            showError(`系统错误: ${e.message}`);
        });
        
        // 导出调试信息
        window.debugInfo = function() {
            return {
                systemData: systemData,
                currentDetails: currentDetails,
                version: '1.0.0 - 业务版',
                features: [
                    '数据收敛漏斗图',
                    '工作流状态监控',
                    '交互式详情跳转',
                    '实时数据刷新'
                ]
            };
        };
        
        console.log('📊 技术洞察系统业务仪表板加载完成');
        console.log('🎯 核心功能: 数据收敛分析 + 工作流监控 + 交互式导航');
    </script>
</body>
</html>

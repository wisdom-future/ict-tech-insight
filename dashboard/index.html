<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 技术洞察系统 - 监控仪表板</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/mobile.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="技术洞察系统实时监控仪表板，提供数据流转分析、工作流状态监控和业务洞察展示">
    
    <!-- 修复后的图标引用 -->
    <link rel="icon" type="image/png" href="assets/images/icons/favicon.ico">
    <link rel="apple-touch-icon" sizes="192x192" href="assets/images/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="assets/images/icons/icon-512.png">
    
    <!-- PWA 支持 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="洞察仪表板">
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="config/config.js" as="script">
    <link rel="preload" href="assets/js/utils.js" as="script">
</head>
<body>
    <!-- 加载遮罩层 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: flex;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>技术洞察系统</h3>
            <p id="loadingMessage">正在初始化系统...</p>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <!-- 错误模态框 -->
    <div id="errorModal" class="error-modal hidden">
        <div class="error-content">
            <div class="error-header">
                <h3>🚨 系统错误</h3>
                <button class="close-btn" id="closeError">&times;</button>
            </div>
            <div class="error-body">
                <p id="errorMessage">发生未知错误</p>
                <div id="errorDetails" class="error-details" style="display: none;">
                    <details>
                        <summary>查看详细信息</summary>
                        <pre id="errorStack"></pre>
                    </details>
                </div>
            </div>
            <div class="error-footer">
                <button class="btn-retry" id="retryBtn">🔄 重试</button>
                <button class="btn-report" id="reportBtn">📧 报告问题</button>
            </div>
        </div>
    </div>

    <!-- 设置面板 -->
    <div id="settingsPanel" class="settings-panel hidden">
        <div class="settings-content">
            <div class="settings-header">
                <h3>⚙️ 系统设置</h3>
                <button class="close-btn" id="closeSettings">&times;</button>
            </div>
            <div class="settings-body">
                <div class="setting-group">
                    <label for="refreshInterval">自动刷新间隔 (秒)</label>
                    <select id="refreshInterval">
                        <option value="15000">15秒</option>
                        <option value="30000" selected>30秒</option>
                        <option value="60000">1分钟</option>
                        <option value="300000">5分钟</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="timeRangeSelect">时间范围</label>
                    <select id="timeRangeSelect">
                        <option value="24h" selected>24小时</option>
                        <option value="7d">7天</option>
                        <option value="30d">30天</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="rankingCriteria">排行标准</label>
                    <select id="rankingCriteria">
                        <option value="signal_strength" selected>信号强度</option>
                        <option value="commercial_value">商业价值</option>
                        <option value="breakthrough_score">技术突破性</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="chartAnimation" checked>
                        启用图表动画
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="darkMode">
                        深色模式
                    </label>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn-save" id="saveSettings">💾 保存</button>
                <button class="btn-reset" id="resetSettings">🔄 重置</button>
            </div>
        </div>
    </div>

    <!-- 主仪表板容器 -->
    <div class="dashboard-container">
        <!-- 头部区域 -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1>🎯 技术洞察系统</h1>
                <div class="system-status">
                    <span class="status-indicator" id="systemStatus">🔄 系统状态：正在初始化...</span>
                </div>
                <div class="version-info">监控仪表板 v1.0.0 - 业务版</div>
            </div>
            <div class="header-controls">
                <div class="last-update" id="lastUpdate">最后更新: --</div>
                <button class="btn-refresh" id="refreshBtn">🔄 刷新</button>
                <button class="btn-settings" id="settingsBtn">⚙️</button>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="dashboard-main">
            <!-- 核心指标卡片网格 -->
            <section class="metrics-section">
                <div class="metrics-grid">
                    <!-- 系统健康度卡片 -->
                    <div class="metric-card health-card">
                        <div class="metric-header">
                            <h3>📊 系统健康度</h3>
                            <div class="metric-icon" id="healthIcon">💚</div>
                        </div>
                        <div class="metric-value" id="systemHealth">--</div>
                        <div class="metric-trend neutral" id="healthTrend">系统初始化中</div>
                        <div class="metric-detail" id="healthDetail">正在检测系统状态</div>
                        <div class="health-progress">
                            <div class="progress-bar" id="healthProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- 今日洞察卡片 -->
                    <div class="metric-card insights-card">
                        <div class="metric-header">
                            <h3>📈 今日洞察</h3>
                            <div class="metric-icon">📊</div>
                        </div>
                        <div class="metric-value" id="todayInsights">--</div>
                        <div class="metric-trend positive" id="insightsTrend">👆 与昨日对比</div>
                        <div class="metric-detail" id="insightsDetail">包含高价值洞察 -- 条</div>
                    </div>

                    <!-- 告警数量卡片 -->
                    <div class="metric-card alert-card">
                        <div class="metric-header">
                            <h3>⚠️ 告警数量</h3>
                            <div class="metric-icon">🚨</div>
                        </div>
                        <div class="metric-value" id="alertCount">--</div>
                        <div class="metric-trend neutral" id="alertTrend">👆 需要关注</div>
                        <div class="metric-detail" id="alertDetail">-- 个高优先级告警</div>
                    </div>

                    <!-- 运行状态卡片 -->
                    <div class="metric-card workflow-card">
                        <div class="metric-header">
                            <h3>🔄 运行状态</h3>
                            <div class="metric-icon">⚡</div>
                        </div>
                        <div class="metric-value" id="runningWorkflows">运行中</div>
                        <div class="metric-trend positive" id="workflowTrend">-- 个工作流</div>
                        <div class="metric-detail" id="workflowDetail">系统正常运行</div>
                    </div>
                </div>
            </section>

            <!-- 数据流转分析 -->
            <section class="data-flow-section">
                <div class="section-header">
                    <h2>📊 核心业务可视化</h2>
                    <div class="section-controls">
                        <button class="btn-toggle" id="flowToggle">详细视图</button>
                    </div>
                </div>
                <div class="section-subtitle">数据收敛流转分析</div>
                <div class="flow-description">📊 展示从原始数据到最终技术线索的收敛过程和数量分布</div>
                
                <div class="data-flow-grid">
                    <div class="funnel-chart-panel">
                        <div class="panel-header">
                            <h3>数据处理流转漏斗</h3>
                            <div class="chart-controls">
                                <select id="funnelTimeRange">
                                    <option value="today">今日</option>
                                    <option value="week">本周</option>
                                    <option value="month">本月</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="funnelChart"></canvas>
                        </div>
                        <div class="funnel-summary">
                            <div class="summary-item">转化率: <strong id="conversionRate">--</strong></div>
                            <div class="summary-item">处理效率: <strong id="processingEfficiency">--</strong></div>
                            <div class="summary-item">总输入: <strong id="totalInput">--</strong></div>
                            <div class="summary-item">总输出: <strong id="totalOutput">--</strong></div>
                        </div>
                    </div>

                    <div class="quality-metrics-panel">
                        <div class="panel-header">
                            <h3>数据质量监控</h3>
                        </div>
                        <div class="quality-score" id="overallQuality">
                            <div class="score-label">综合评分</div>
                            <div class="score-value">--/10</div>
                        </div>
                        <div class="quality-grid" id="qualityGrid">
                            <div class="loading">正在加载质量数据...</div>
                        </div>
                    </div>
                </div>

                <!-- 流转步骤展示 -->
                <div class="flow-steps-container">
                    <div class="flow-step" id="rawDataStep">
                        <div class="step-icon">📥</div>
                        <div class="step-content">
                            <h4>原始数据 (RAW)</h4>
                            <div class="step-value" id="rawDataCount">--</div>
                            <div class="step-detail">来源: 学术论文、专利、新闻等</div>
                        </div>
                        <div class="step-progress">
                            <div class="progress-bar" style="width: 100%"></div>
                        </div>
                    </div>

                    <div class="flow-arrow">⬇️</div>
                    <div class="flow-conversion" id="rawToIntel">87% 转化率</div>

                    <div class="flow-step" id="intelligenceStep">
                        <div class="step-icon">🧠</div>
                        <div class="step-content">
                            <h4>智能洞察 (Intelligence)</h4>
                            <div class="step-value" id="intelligenceCount">--</div>
                            <div class="step-detail">AI识别的技术信号</div>
                        </div>
                        <div class="step-progress">
                            <div class="progress-bar" style="width: 87%"></div>
                        </div>
                    </div>

                    <div class="flow-arrow">⬇️</div>
                    <div class="flow-conversion" id="intelToClues">78% 转化率</div>

                    <div class="flow-step" id="cluesStep">
                        <div class="step-icon">🔍</div>
                        <div class="step-content">
                            <h4>技术线索 (Clues)</h4>
                            <div class="step-value" id="cluesCount">--</div>
                            <div class="step-detail">验证通过的有效线索</div>
                        </div>
                        <div class="step-progress">
                            <div class="progress-bar" style="width: 78%"></div>
                        </div>
                    </div>

                    <div class="flow-arrow">⬇️</div>
                    <div class="flow-conversion" id="cluesToActions">65% 转化率</div>

                    <div class="flow-step" id="actionsStep">
                        <div class="step-icon">🎯</div>
                        <div class="step-content">
                            <h4>行动建议 (Actions)</h4>
                            <div class="step-value" id="actionsCount">--</div>
                            <div class="step-detail">可执行的决策建议</div>
                        </div>
                        <div class="step-progress">
                            <div class="progress-bar" style="width: 65%"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 工作流状态监控 -->
            <section class="workflow-section">
                <div class="section-header">
                    <h2>工作流实时状态监控</h2>
                    <div class="section-controls">
                        <button class="btn-toggle" id="workflowToggle">简化视图</button>
                    </div>
                </div>
                <div class="section-subtitle">🔄 显示当前所有工作流的最新执行状态和时间信息</div>

                <div class="workflow-grid">
                    <div class="workflow-status-panel">
                        <div class="panel-header">
                            <h3>当前工作流状态</h3>
                            <div class="status-legend">
                                <div class="legend-item">
                                    <div class="dot success"></div>
                                    <span>已完成</span>
                                </div>
                                <div class="legend-item">
                                    <div class="dot warning"></div>
                                    <span>运行中</span>
                                </div>
                                <div class="legend-item">
                                    <div class="dot danger"></div>
                                    <span>失败</span>
                                </div>
                                <div class="legend-item">
                                    <div class="dot secondary"></div>
                                    <span>等待中</span>
                                </div>
                            </div>
                        </div>
                        <div class="workflow-list" id="workflowList">
                            <div class="loading">正在加载工作流状态...</div>
                        </div>
                    </div>

                    <div class="workflow-timeline-panel">
                        <div class="panel-header">
                            <h3>执行时间趋势</h3>
                            <div class="chart-controls">
                                <select id="timelineRange">
                                    <option value="24h">24小时</option>
                                    <option value="7d">7天</option>
                                    <option value="30d">30天</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 业务价值分析 -->
            <section class="value-section">
                <div class="section-header">
                    <h2>💰 业务价值分析</h2>
                </div>

                <div class="value-grid">
                    <div class="value-matrix-panel">
                        <div class="panel-header">
                            <h3>洞察价值分布矩阵</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="scatterChart"></canvas>
                        </div>
                        <div class="value-summary">
                            <div class="value-stat">高价值洞察: <strong id="highValueCount">--</strong></div>
                            <div class="value-stat">投资机会: <strong id="investmentOpportunities">--</strong></div>
                        </div>
                    </div>

                    <div class="top-intelligence-panel">
                        <div class="panel-header">
                            <h3>TOP 洞察排行</h3>
                            <div class="chart-controls">
                                <select id="rankingSelect">
                                    <option value="signal_strength">信号强度</option>
                                    <option value="commercial_value">商业价值</option>
                                    <option value="breakthrough_score">技术突破性</option>
                                </select>
                            </div>
                        </div>
                        <div class="intelligence-list" id="intelligenceList">
                            <div class="loading">正在加载洞察数据...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 技术趋势分析 -->
            <section class="trends-section">
                <div class="section-header">
                    <h2>🔥 技术趋势分析</h2>
                </div>

                <div class="trends-grid">
                    <div class="heatmap-panel">
                        <div class="panel-header">
                            <h3>技术热度图</h3>
                        </div>
                        <div class="heatmap-container" id="heatmapContainer">
                            <div class="loading">正在生成热度图...</div>
                        </div>
                    </div>

                    <div class="trends-stats-panel">
                        <div class="panel-header">
                            <h3>趋势统计</h3>
                        </div>
                        <div class="trends-list" id="trendsList">
                            <div class="loading">正在分析趋势...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 详细信息面板 -->
            <section class="details-section">
                <div class="details-grid">
                    <div class="insights-detail">
                        <div class="panel-header">
                            <h3>📈 今日洞察详情</h3>
                        </div>
                        <div class="detail-content" id="insightsDetailContent">
                            <div class="loading">正在加载洞察详情...</div>
                        </div>
                    </div>

                    <div class="alerts-detail">
                        <div class="panel-header">
                            <h3>⚠️ 系统告警详情</h3>
                        </div>
                        <div class="detail-content" id="alertsDetailContent">
                            <div class="loading">正在检查系统告警...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 系统控制面板 -->
            <section class="control-section">
                <div class="panel-header">
                    <h3>🎛️ 系统控制</h3>
                </div>
                <div class="control-buttons">
                    <button class="control-btn primary" id="processBtn">
                        🔄 处理请求
                    </button>
                    <button class="control-btn secondary" id="resetBtn">
                        🔄 重置系统
                    </button>
                    <button class="control-btn info" id="exportBtn">
                        📤 导出数据
                    </button>
                    <button class="control-btn warning" id="maintenanceBtn">
                        🔧 维护模式
                    </button>
                </div>
                <div class="control-status" id="controlStatus">
                    <div class="status-message">
                        <span class="status-icon">✅</span>
                        <span class="status-text">系统运行正常 - 所有服务已启动</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- 页脚 -->
        <footer class="dashboard-footer">
            <div class="footer-content">
                <div class="footer-left">
                    <p>© 2024 技术洞察决策引擎 | 实时监控仪表板 | 数据源: Google Sheets | v1.0.0 - 业务版</p>
                </div>
                <div class="footer-right">
                    <span>部署时间: <span id="deployTime">2024-06-22 08:00:00</span></span>
                    <span class="separator">|</span>
                    <span>最后更新: <span id="footerUpdate">--</span></span>
                    <span class="separator">|</span>
                    <span>API状态: <span class="api-status" id="apiStatus">检测中</span></span>
                    <span class="separator">|</span>
                    <span>数据条数: <span id="dataCount">0</span></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast 通知容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- 脚本文件 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script>
        // 确保Chart.js加载完成
        console.log('Chart.js版本:', Chart.version);
    </script>
    
    <!-- 配置和核心脚本 -->
    <script src="config/config.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/charts.js"></script>
    <script src="assets/js/app.js"></script>

    <!-- 增强的初始化脚本 -->
    <script>
        // 调试和初始化脚本
        console.log('=== 技术洞察系统启动 ===');
        
        // 检查所有依赖
        const dependencies = {
            CONFIG: typeof CONFIG !== 'undefined',
            Utils: typeof Utils !== 'undefined',
            SheetsAPI: typeof SheetsAPI !== 'undefined',
            api: typeof api !== 'undefined',
            DashboardCharts: typeof DashboardCharts !== 'undefined',
            dashboardCharts: typeof dashboardCharts !== 'undefined',
            TechIntelligenceApp: typeof TechIntelligenceApp !== 'undefined',
            app: typeof app !== 'undefined',
            Chart: typeof Chart !== 'undefined'
        };
        
        console.log('依赖检查:', dependencies);
        
        // 检查是否所有依赖都已加载
        const allLoaded = Object.values(dependencies).every(loaded => loaded);
        
        if (allLoaded) {
            console.log('✅ 所有依赖已加载，开始初始化应用');
            
            // 确保DOM完全加载后再初始化
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        } else {
            console.error('❌ 部分依赖未加载:', dependencies);
            showManualError('依赖加载失败', '请检查所有JavaScript文件是否正确加载');
        }
        
        function initializeApp() {
            console.log('开始初始化应用...');
            
            try {
                // 显示加载状态
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
                
                // 初始化应用
                if (typeof app !== 'undefined' && app.init) {
                    app.init().then(() => {
                        console.log('✅ 应用初始化成功');
                    }).catch(error => {
                        console.error('❌ 应用初始化失败:', error);
                        showManualError('初始化失败', error.message);
                    });
                } else {
                    throw new Error('app对象或init方法不存在');
                }
            } catch (error) {
                console.error('初始化过程出错:', error);
                showManualError('初始化错误', error.message);
            }
        }
        
        function showManualError(title, message) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            const errorModal = document.getElementById('errorModal');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorModal && errorMessage) {
                errorMessage.textContent = `${title}: ${message}`;
                errorModal.classList.remove('hidden');
            } else {
                // 如果模态框不存在，使用alert
                alert(`${title}: ${message}`);
            }
        }
        
        // 网络状态检查
        if (!navigator.onLine) {
            console.warn('⚠️ 网络连接异常');
            showManualError('网络错误', '请检查网络连接');
        }
        
        // 全局错误处理
        window.addEventListener('error', function(e) {
            console.error('全局错误:', e.error);
            showManualError('运行时错误', e.message);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('未处理的Promise错误:', e.reason);
            showManualError('异步错误', e.reason.message || e.reason);
        });
    </script>
</body>
</html>

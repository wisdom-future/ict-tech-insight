name: Generate Project Structure TEST

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'ict-tech-insight-generator.yml'  # å½“é…ç½®æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘

jobs:
  generate-project:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install -g js-yaml
        npm install js-yaml

    - name: Generate project structure
      run: |
        cat > generate.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const yaml = require('js-yaml');

        try {
          // è¯»å–é…ç½®æ–‡ä»¶
          const config = yaml.load(fs.readFileSync('ict-tech-insight-generator.yml', 'utf8'));
          
          // åˆ›å»ºç›®å½•
          console.log('ğŸ—ï¸  åˆ›å»ºç›®å½•ç»“æ„...');
          config.structure.directories.forEach(dir => {
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
              console.log(`âœ… åˆ›å»ºç›®å½•: ${dir}`);
            }
          });

          // åˆ›å»ºæ–‡ä»¶
          console.log('ğŸ“„ åˆ›å»ºé¡¹ç›®æ–‡ä»¶...');
          Object.entries(config.files).forEach(([filePath, content]) => {
            const dir = path.dirname(filePath);
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }
            fs.writeFileSync(filePath, content.trim());
            console.log(`âœ… åˆ›å»ºæ–‡ä»¶: ${filePath}`);
          });

          console.log('ğŸ‰ é¡¹ç›®ç»“æ„ç”Ÿæˆå®Œæˆï¼');
        } catch (error) {
          console.error('âŒ ç”Ÿæˆå¤±è´¥:', error.message);
          process.exit(1);
        }
        EOF

        node generate.js

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "ğŸš€ Auto-generate project structure from YAML config"
        git push

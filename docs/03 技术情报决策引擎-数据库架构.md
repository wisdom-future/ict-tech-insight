# 技术情报决策引擎 - 重新设计数据库架构

## **当前架构问题分析**

### **严重问题：单一Spreadsheet架构的致命缺陷**

```
当前架构：所有表都在一个Google Sheets文件中
问题1：性能瓶颈
- Google Sheets单文件限制：1000万单元格
- 复杂查询会导致整个文件卡死
- 多用户并发访问冲突

问题2：扩展性限制
- 无法独立扩展某个数据域
- 备份和恢复必须整体进行
- 权限控制粒度太粗

问题3：维护复杂性
- 一个表出问题影响整个系统
- 数据迁移和结构调整困难
- 版本控制和回滚复杂
```

## **重新设计：分布式数据库架构**

### **核心设计原则**

1. **数据域分离**：按业务逻辑分离不同数据域
2. **性能优化**：每个数据库独立优化
3. **扩展性**：支持独立扩展和备份
4. **权限控制**：细粒度访问控制
5. **容错性**：单点故障不影响整体系统

## **新架构：6个独立数据库设计**

### **数据库1：原始数据采集库（Raw_Data_Collection_DB）**
```
用途：存储所有原始采集数据
特点：写入频繁，读取较少，数据量最大
预期规模：每日新增1000-5000条记录

包含表：
1. Raw_Academic_Papers
2. Raw_Patent_Data  
3. Raw_OpenSource_Data
4. Raw_Tech_News
5. Raw_Industry_Dynamics
6. Raw_Competitor_Intelligence
7. Raw_Data_Processing_Queue (新增)
8. Data_Source_Health_Monitor (新增)
```

### **数据库2：核心情报主库（Core_Intelligence_DB）**
```
用途：存储核心技术情报和基础分析
特点：核心数据，查询频繁，数据质量要求最高
预期规模：每日新增50-200条高质量记录

包含表：
1. Tech_Intelligence_Master
2. Evidence_Validation_Matrix
3. Intelligence_Data_Flow_Tracker
4. Data_Lineage_Tracker (新增)
5. Intelligence_Quality_Metrics (新增)
```

### **数据库3：商业分析库（Business_Analysis_DB）**
```
用途：存储商业价值分析和投资决策数据
特点：计算密集，财务敏感，需要版本控制
预期规模：与核心情报1:1对应

包含表：
1. Commercial_Value_Quantification
2. Market_Analysis_Details (新增)
3. ROI_Calculation_History (新增)
4. Investment_Scenarios (新增)
5. Financial_Model_Parameters (新增)
```

### **数据库4：竞争情报库（Competitive_Intelligence_DB）**
```
用途：存储竞争分析和市场情报
特点：敏感数据，实时更新，权限控制严格
预期规模：竞争对手数据，更新频繁

包含表：
1. Competitive_Intelligence_Monitor
2. Competitor_Profile_Master (新增)
3. Market_Position_Tracking (新增)
4. Patent_Landscape_Analysis (新增)
5. Competitive_Alert_Log (新增)
```

### **数据库5：技术分析库（Technical_Analysis_DB）**
```
用途：存储深度技术分析和专家评估
特点：技术复杂，专家驱动，版本迭代
预期规模：技术深度分析，专业性强

包含表：
1. Technical_Deep_Analysis
2. Technology_Roadmap_Tracking (新增)
3. Expert_Evaluation_Records (新增)
4. Technical_Risk_Assessment (新增)
5. Innovation_Impact_Analysis (新增)
```

### **数据库6：系统运营库（System_Operations_DB）**
```
用途：存储系统运行状态和工作流管理
特点：高频读写，实时监控，日志型数据
预期规模：日志数据，增长快速

包含表：
1. Action_Recommendations
2. Workflow_Execution_Log
3. System_Performance_Monitor
4. Error_Log_Details
5. User_Access_Audit
6. Data_Quality_Reports
7. Resource_Usage_Statistics
```

## **跨库关联设计**

### **主键关联策略**
```
核心关联键：intelligence_id
- 在所有库中作为主要关联字段
- 格式：TI{YYYYMMDD}{序号}{类别码}
- 确保全局唯一性

辅助关联键：
- source_data_id：关联原始数据
- analysis_version_id：支持版本控制
- workflow_execution_id：追踪处理过程
```

### **数据同步机制**
```
实时同步：
- intelligence_id创建时立即在所有相关库创建记录
- 关键状态变更实时同步

批量同步：
- 非关键数据每小时同步一次
- 统计数据每日同步一次

冲突解决：
- 时间戳优先原则
- 核心库数据为准
- 自动冲突检测和报警
```

## **具体实现：6个数据库创建脚本**

### **脚本1：原始数据采集库**
```javascript
function createRawDataCollectionDB() {
  const spreadsheet = SpreadsheetApp.create('技术情报系统-原始数据采集库');
  const spreadsheetId = spreadsheet.getId();
  
  // 删除默认Sheet1
  createRawAcademicPapersTable(spreadsheet);
  spreadsheet.deleteSheet(spreadsheet.getSheetByName('Sheet1'));
  
  // 创建所有原始数据表
  createRawPatentDataTable(spreadsheet);
  createRawOpenSourceDataTable(spreadsheet);
  createRawTechNewsTable(spreadsheet);
  createRawIndustryDynamicsTable(spreadsheet);
  createRawCompetitorIntelligenceTable(spreadsheet);
  
  // 新增管理表
  createRawDataProcessingQueueTable(spreadsheet);
  createDataSourceHealthMonitorTable(spreadsheet);
  createRawDataDashboard(spreadsheet);
  
  console.log('原始数据采集库创建完成');
  console.log('数据库ID: ' + spreadsheetId);
  return spreadsheetId;
}

function createRawAcademicPapersTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Raw_Academic_Papers');
  
  const headers = [
    'raw_id',                     // 原始数据ID
    'source_type',                // 来源类型
    'title',                      // 标题
    'abstract',                   // 摘要
    'authors',                    // 作者
    'publication_date',           // 发布日期
    'source_url',                 // 来源链接
    'initial_relevance_score',    // 初始相关性评分
    'tech_keywords',              // 技术关键词
    'processed_status',           // 处理状态
    'linked_intelligence_id',     // 关联情报ID
    'processing_result',          // 处理结果
    'rejection_reason',           // 拒绝原因
    'contribution_score',         // 贡献度评分
    'data_quality_score',         // 数据质量评分
    'duplicate_check_hash',       // 去重检查哈希
    'workflow_execution_id',      // 工作流执行ID
    'created_timestamp',          // 创建时间
    'processed_timestamp',        // 处理时间
    'last_update_timestamp'       // 最后更新时间
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  // 设置数据验证
  const statusRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['pending', 'processing', 'processed', 'rejected', 'error'])
    .build();
  sheet.getRange('J2:J10000').setDataValidation(statusRule);
  
  console.log('原始学术论文表创建完成');
}

function createRawDataProcessingQueueTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Raw_Data_Processing_Queue');
  
  const headers = [
    'queue_id',                   // 队列ID
    'raw_data_id',               // 原始数据ID
    'source_table',              // 来源表
    'priority_level',            // 优先级
    'queue_status',              // 队列状态
    'assigned_workflow',         // 分配的工作流
    'processing_start_time',     // 处理开始时间
    'estimated_completion_time', // 预计完成时间
    'retry_count',               // 重试次数
    'error_messages',            // 错误信息
    'created_timestamp'          // 创建时间
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('原始数据处理队列表创建完成');
}

function createDataSourceHealthMonitorTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Data_Source_Health_Monitor');
  
  const headers = [
    'source_id',                 // 数据源ID
    'source_name',               // 数据源名称
    'source_type',               // 数据源类型
    'source_url',                // 数据源URL
    'health_status',             // 健康状态
    'last_successful_access',    // 最后成功访问时间
    'consecutive_failures',      // 连续失败次数
    'average_response_time',     // 平均响应时间
    'data_quality_trend',        // 数据质量趋势
    'daily_record_count',        // 日记录数量
    'error_rate_percentage',     // 错误率百分比
    'backup_sources',            // 备用数据源
    'alert_threshold',           // 预警阈值
    'monitoring_frequency',      // 监控频率
    'last_health_check',         // 最后健康检查时间
    'next_scheduled_check'       // 下次计划检查时间
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('数据源健康监控表创建完成');
}
```

### **脚本2：核心情报主库**
```javascript
function createCoreIntelligenceDB() {
  const spreadsheet = SpreadsheetApp.create('技术情报系统-核心情报主库');
  const spreadsheetId = spreadsheet.getId();
  
  // 创建核心表
  createTechIntelligenceMasterTable(spreadsheet);
  spreadsheet.deleteSheet(spreadsheet.getSheetByName('Sheet1'));
  
  createEvidenceValidationMatrixTable(spreadsheet);
  createIntelligenceDataFlowTrackerTable(spreadsheet);
  createDataLineageTrackerTable(spreadsheet);
  createIntelligenceQualityMetricsTable(spreadsheet);
  createCoreIntelligenceDashboard(spreadsheet);
  
  console.log('核心情报主库创建完成');
  console.log('数据库ID: ' + spreadsheetId);
  return spreadsheetId;
}

function createDataLineageTrackerTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Data_Lineage_Tracker');
  
  const headers = [
    'lineage_id',                // 血缘关系ID
    'intelligence_id',           // 目标情报ID
    'source_database_id',        // 源数据库ID
    'source_table',              // 来源表名
    'source_record_id',          // 来源记录ID
    'contribution_type',         // 贡献类型
    'contribution_weight',       // 贡献权重
    'data_transformation',       // 数据转换过程
    'quality_impact_score',      // 对质量的影响评分
    'processing_workflow',       // 处理工作流
    'transformation_rules',      // 转换规则
    'validation_status',         // 验证状态
    'created_timestamp',         // 创建时间
    'last_verified_timestamp'    // 最后验证时间
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('数据血缘追踪表创建完成');
}

function createIntelligenceQualityMetricsTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Intelligence_Quality_Metrics');
  
  const headers = [
    'metrics_id',                // 质量指标ID
    'intelligence_id',           // 情报ID
    'completeness_score',        // 完整性评分
    'accuracy_score',            // 准确性评分
    'timeliness_score',          // 及时性评分
    'relevance_score',           // 相关性评分
    'consistency_score',         // 一致性评分
    'source_credibility_score',  // 来源可信度评分
    'overall_quality_score',     // 总体质量评分
    'quality_grade',             // 质量等级
    'improvement_suggestions',   // 改进建议
    'quality_trend',             // 质量趋势
    'benchmark_comparison',      // 基准对比
    'calculated_timestamp',      // 计算时间
    'next_quality_review'        // 下次质量评估时间
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('情报质量指标表创建完成');
}
```

### **脚本3：商业分析库**
```javascript
function createBusinessAnalysisDB() {
  const spreadsheet = SpreadsheetApp.create('技术情报系统-商业分析库');
  const spreadsheetId = spreadsheet.getId();
  
  // 创建商业分析表
  createCommercialValueQuantificationTable(spreadsheet);
  spreadsheet.deleteSheet(spreadsheet.getSheetByName('Sheet1'));
  
  createMarketAnalysisDetailsTable(spreadsheet);
  createROICalculationHistoryTable(spreadsheet);
  createInvestmentScenariosTable(spreadsheet);
  createFinancialModelParametersTable(spreadsheet);
  createBusinessAnalysisDashboard(spreadsheet);
  
  console.log('商业分析库创建完成');
  console.log('数据库ID: ' + spreadsheetId);
  return spreadsheetId;
}

function createMarketAnalysisDetailsTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Market_Analysis_Details');
  
  const headers = [
    'analysis_id',               // 分析ID
    'intelligence_id',           // 情报ID
    'market_segment',            // 市场细分
    'segment_size_usd',          // 细分市场规模
    'growth_rate_historical',    // 历史增长率
    'growth_rate_projected',     // 预测增长率
    'market_maturity_stage',     // 市场成熟度阶段
    'key_market_drivers',        // 关键市场驱动因素
    'market_barriers',           // 市场壁垒
    'customer_segments',         // 客户细分
    'pricing_analysis',          // 定价分析
    'distribution_channels',     // 分销渠道
    'competitive_intensity',     // 竞争激烈程度
    'market_concentration',      // 市场集中度
    'regulatory_environment',    // 监管环境
    'technology_adoption_curve', // 技术采用曲线
    'market_timing_assessment',  // 市场时机评估
    'analysis_methodology',      // 分析方法论
    'data_sources',              // 数据来源
    'analysis_confidence',       // 分析置信度
    'created_timestamp',         // 创建时间
    'analyst_name'               // 分析师姓名
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('市场分析详情表创建完成');
}

function createROICalculationHistoryTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('ROI_Calculation_History');
  
  const headers = [
    'calculation_id',            // 计算ID
    'intelligence_id',           // 情报ID
    'calculation_version',       // 计算版本
    'scenario_name',             // 场景名称
    'investment_amount',         // 投资金额
    'revenue_projections',       // 收入预测
    'cost_projections',          // 成本预测
    'roi_percentage',            // ROI百分比
    'npv_value',                 // 净现值
    'irr_percentage',            // 内部收益率
    'payback_period_months',     // 回收期
    'risk_adjustment_factor',    // 风险调整因子
    'sensitivity_analysis',      // 敏感性分析
    'assumption_changes',        // 假设变更
    'calculation_method',        // 计算方法
    'model_parameters',          // 模型参数
    'validation_results',        // 验证结果
    'approved_by',               // 批准人
    'calculation_timestamp',     // 计算时间
    'is_current_version'         // 是否当前版本
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('ROI计算历史表创建完成');
}
```

### **脚本4：竞争情报库**
```javascript
function createCompetitiveIntelligenceDB() {
  const spreadsheet = SpreadsheetApp.create('技术情报系统-竞争情报库');
  const spreadsheetId = spreadsheet.getId();
  
  // 创建竞争情报表
  createCompetitiveIntelligenceMonitorTable(spreadsheet);
  spreadsheet.deleteSheet(spreadsheet.getSheetByName('Sheet1'));
  
  createCompetitorProfileMasterTable(spreadsheet);
  createMarketPositionTrackingTable(spreadsheet);
  createPatentLandscapeAnalysisTable(spreadsheet);
  createCompetitiveAlertLogTable(spreadsheet);
  createCompetitiveIntelligenceDashboard(spreadsheet);
  
  console.log('竞争情报库创建完成');
  console.log('数据库ID: ' + spreadsheetId);
  return spreadsheetId;
}

function createCompetitorProfileMasterTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Competitor_Profile_Master');
  
  const headers = [
    'competitor_id',             // 竞争对手ID
    'company_name',              // 公司名称
    'company_type',              // 公司类型
    'headquarters_location',     // 总部位置
    'founded_year',              // 成立年份
    'employee_count',            // 员工数量
    'annual_revenue',            // 年收入
    'funding_total',             // 总融资额
    'latest_funding_round',      // 最新融资轮次
    'key_executives',            // 关键高管
    'core_technologies',         // 核心技术
    'main_products',             // 主要产品
    'target_markets',            // 目标市场
    'competitive_strengths',     // 竞争优势
    'competitive_weaknesses',    // 竞争劣势
    'strategic_partnerships',    // 战略合作伙伴
    'recent_acquisitions',       // 近期收购
    'patent_portfolio_size',     // 专利组合规模
    'r_d_investment_percentage', // 研发投入百分比
    'market_share_estimates',    // 市场份额估算
    'threat_level',              // 威胁等级
    'monitoring_priority',       // 监控优先级
    'intelligence_sources',      // 情报来源
    'last_profile_update',       // 最后档案更新
    'next_review_date'           // 下次评估日期
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('竞争对手档案主表创建完成');
}
```

### **脚本5：技术分析库**
```javascript
function createTechnicalAnalysisDB() {
  const spreadsheet = SpreadsheetApp.create('技术情报系统-技术分析库');
  const spreadsheetId = spreadsheet.getId();
  
  // 创建技术分析表
  createTechnicalDeepAnalysisTable(spreadsheet);
  spreadsheet.deleteSheet(spreadsheet.getSheetByName('Sheet1'));
  
  createTechnologyRoadmapTrackingTable(spreadsheet);
  createExpertEvaluationRecordsTable(spreadsheet);
  createTechnicalRiskAssessmentTable(spreadsheet);
  createInnovationImpactAnalysisTable(spreadsheet);
  createTechnicalAnalysisDashboard(spreadsheet);
  
  console.log('技术分析库创建完成');
  console.log('数据库ID: ' + spreadsheetId);
  return spreadsheetId;
}

function createTechnologyRoadmapTrackingTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Technology_Roadmap_Tracking');
  
  const headers = [
    'roadmap_id',                // 路线图ID
    'intelligence_id',           // 情报ID
    'technology_domain',         // 技术领域
    'current_stage',             // 当前阶段
    'next_milestone',            // 下一个里程碑
    'milestone_description',     // 里程碑描述
    'estimated_timeline',        // 预计时间线
    'confidence_level',          // 置信度
    'key_enablers',              // 关键推动因素
    'potential_blockers',        // 潜在阻碍因素
    'alternative_paths',         // 替代路径
    'industry_consensus',        // 行业共识
    'expert_opinions',           // 专家意见
    'supporting_evidence',       // 支撑证据
    'roadmap_version',           // 路线图版本
    'last_update_reason',        // 最后更新原因
    'created_timestamp',         // 创建时间
    'updated_timestamp'          // 更新时间
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('技术路线图追踪表创建完成');
}
```

### **脚本6：系统运营库**
```javascript
function createSystemOperationsDB() {
  const spreadsheet = SpreadsheetApp.create('技术情报系统-系统运营库');
  const spreadsheetId = spreadsheet.getId();
  
  // 创建系统运营表
  createActionRecommendationsTable(spreadsheet);
  spreadsheet.deleteSheet(spreadsheet.getSheetByName('Sheet1'));
  
  createWorkflowExecutionLogTable(spreadsheet);
  createSystemPerformanceMonitorTable(spreadsheet);
  createErrorLogDetailsTable(spreadsheet);
  createUserAccessAuditTable(spreadsheet);
  createDataQualityReportsTable(spreadsheet);
  createResourceUsageStatisticsTable(spreadsheet);
  createSystemOperationsDashboard(spreadsheet);
  
  console.log('系统运营库创建完成');
  console.log('数据库ID: ' + spreadsheetId);
  return spreadsheetId;
}

function createWorkflowExecutionLogTable(spreadsheet) {
  const sheet = spreadsheet.insertSheet('Workflow_Execution_Log');
  
  const headers = [
    'execution_id',              // 执行ID
    'workflow_name',             // 工作流名称
    'intelligence_id',           // 情报ID
    'execution_status',          // 执行状态
    'start_timestamp',           // 开始时间
    'end_timestamp',             // 结束时间
    'duration_seconds',          // 持续时间（秒）
    'processed_records',         // 处理记录数
    'success_count',             // 成功数量
    'error_count',               // 错误数量
    'warning_count',             // 警告数量
    'resource_usage',            // 资源使用情况
    'error_details',             // 错误详情
    'performance_metrics',       // 性能指标
    'trigger_source',            // 触发来源
    'execution_node',            // 执行节点
    'retry_count',               // 重试次数
    'parent_execution_id',       // 父执行ID
    'child_executions',          // 子执行列表
    'execution_context'          // 执行上下文
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  formatHeaders(sheet, headers.length);
  
  console.log('工作流执行日志表创建完成');
}
```

## **完整的数据库创建主脚本**

```javascript
/**
 * 创建完整的分布式技术情报数据库系统
 */
function createDistributedTechIntelligenceSystem() {
  console.log('开始创建分布式技术情报数据库系统...');
  
  const databaseIds = {};
  
  try {
    // 创建6个独立数据库
    databaseIds.rawDataDB = createRawDataCollectionDB();
    databaseIds.coreIntelligenceDB = createCoreIntelligenceDB();
    databaseIds.businessAnalysisDB = createBusinessAnalysisDB();
    databaseIds.competitiveIntelligenceDB = createCompetitiveIntelligenceDB();
    databaseIds.technicalAnalysisDB = createTechnicalAnalysisDB();
    databaseIds.systemOperationsDB = createSystemOperationsDB();
    
    // 创建数据库配置文档
    const configDoc = createSystemConfigurationDoc(databaseIds);
    
    console.log('分布式数据库系统创建完成！');
    console.log('数据库配置文档ID:', configDoc);
    
    // 发送完成通知
    sendDistributedSystemNotification(databaseIds, configDoc);
    
    return {
      success: true,
      databases: databaseIds,
      configDocument: configDoc,
      message: '分布式技术情报数据库系统创建成功'
    };
    
  } catch (error) {
    console.error('创建分布式系统时发生错误:', error);
    return {
      success: false,
      error: error.toString(),
      partialDatabases: databaseIds
    };
  }
}

/**
 * 创建系统配置文档
 */
function createSystemConfigurationDoc(databaseIds) {
  const configDoc = SpreadsheetApp.create('技术情报系统-数据库配置中心');
  const sheet = configDoc.getSheets()[0];
  sheet.setName('Database_Configuration');
  
  const configData = [
    ['数据库名称', '数据库ID', '访问链接', '用途', '预期数据量', '更新频率'],
    ['原始数据采集库', databaseIds.rawDataDB, `https://docs.google.com/spreadsheets/d/${databaseIds.rawDataDB}`, '存储原始采集数据', '大量', '高频'],
    ['核心情报主库', databaseIds.coreIntelligenceDB, `https://docs.google.com/spreadsheets/d/${databaseIds.coreIntelligenceDB}`, '核心技术情报', '中量', '中频'],
    ['商业分析库', databaseIds.businessAnalysisDB, `https://docs.google.com/spreadsheets/d/${databaseIds.businessAnalysisDB}`, '商业价值分析', '中量', '中频'],
    ['竞争情报库', databaseIds.competitiveIntelligenceDB, `https://docs.google.com/spreadsheets/d/${databaseIds.competitiveIntelligenceDB}`, '竞争分析数据', '中量', '高频'],
    ['技术分析库', databaseIds.technicalAnalysisDB, `https://docs.google.com/spreadsheets/d/${databaseIds.technicalAnalysisDB}`, '技术深度分析', '小量', '低频'],
    ['系统运营库', databaseIds.systemOperationsDB, `https://docs.google.com/spreadsheets/d/${databaseIds.systemOperationsDB}`, '系统运行监控', '大量', '高频']
  ];
  
  sheet.getRange(1, 1, configData.length, configData[0].length).setValues(configData);
  formatHeaders(sheet, configData[0].length);
  
  return configDoc.getId();
}
```

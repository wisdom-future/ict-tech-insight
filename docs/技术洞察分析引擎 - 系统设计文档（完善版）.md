**技术洞察分析引擎 - 系统设计文档（架构明确版）**

---

**第一部分：技术架构明确说明**

**核心架构：Google Apps Script + HTML Service**

**技术栈组成：**
```
数据层: Google Sheets (6个分布式数据库)
  ↓
数据服务层: Google Apps Script (.gs文件)
  ↓  
前端展示层: HTML Service (.html文件)
  ↓
用户访问: Google托管的Web应用URL
```

**构建和部署平台：**
- **开发平台**: Google Apps Script在线编辑器 (script.google.com)
- **运行平台**: Google Cloud Platform (Apps Script Runtime)
- **托管平台**: Google Apps Script Web应用服务
- **访问URL**: `https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec`

**为什么选择这个架构：**
1. **与现有系统完美集成**: Make工作流 → Google Sheets → Apps Script → HTML Service
2. **零基础设施成本**: 完全运行在Google云环境中
3. **无CORS问题**: 前后端在同一Google域名下
4. **简化开发流程**: 一个平台完成开发、测试、部署
5. **自动扩展**: Google自动处理负载和并发

---

**第二部分：项目构建结构**

**Google Apps Script项目文件结构：**
```
技术洞察分析引擎 (Apps Script Project)
├── 后端服务文件 (.gs)
│   ├── Code.gs                    # 主入口和路由控制
│   ├── DataService.gs             # 数据服务层
│   ├── ReportService.gs           # 报告生成服务
│   ├── ActionService.gs           # 行动管理服务
│   └── Config.gs                  # 配置管理
├── 前端页面文件 (.html)
│   ├── index.html                 # 主仪表板
│   ├── collection.html            # 数据采集监控
│   ├── insights.html              # 技术洞察分析
│   ├── actions.html               # 决策行动中心
│   └── reports.html               # 报告中心
├── 组件文件 (.html)
│   ├── components/
│   │   ├── header.html            # 顶部导航组件
│   │   ├── modal.html             # 通用弹窗组件
│   │   └── chart.html             # 图表组件
├── 样式文件 (.html)
│   ├── styles/
│   │   ├── main.css               # 主样式表
│   │   ├── components.css         # 组件样式
│   │   └── responsive.css         # 响应式样式
└── 脚本文件 (.html)
    └── scripts/
        ├── main.js                # 主交互逻辑
        ├── charts.js              # 图表处理
        └── utils.js               # 工具函数
```

**构建流程：**
1. **开发阶段**: 在Google Apps Script编辑器中编写代码
2. **测试阶段**: 使用Apps Script内置的测试功能
3. **部署阶段**: 发布为Web应用，获得访问URL
4. **维护阶段**: 通过版本管理进行更新和回滚

---

**第三部分：报告功能完整设计**

**报告生成架构：**

**ReportService.gs - 报告生成后端服务：**
```javascript
// 报告生成主服务类
class TechInsightReportService {
  
  constructor() {
    this.templateEngine = new ReportTemplateEngine();
    this.dataAggregator = new ReportDataAggregator();
    this.exportService = new ReportExportService();
  }
  
  // 生成日报
  generateDailyReport(date = new Date()) {
    try {
      // 收集日报数据
      const reportData = this.dataAggregator.collectDailyData(date);
      
      // 生成报告内容
      const reportContent = this.templateEngine.renderDailyTemplate(reportData);
      
      // 保存报告到数据库
      const reportId = this.saveReportToDatabase('daily', date, reportContent, reportData);
      
      // 生成PDF和Excel版本
      this.exportService.generateMultipleFormats(reportId, reportContent, reportData);
      
      // 自动分发报告
      this.distributeReport(reportId, 'daily');
      
      return {
        success: true,
        reportId: reportId,
        message: '日报生成成功'
      };
      
    } catch (error) {
      console.error('生成日报失败:', error);
      throw new Error(`日报生成失败: ${error.message}`);
    }
  }
  
  // 生成周报
  generateWeeklyReport(weekStartDate) {
    try {
      const weekEndDate = new Date(weekStartDate);
      weekEndDate.setDate(weekEndDate.getDate() + 6);
      
      const reportData = this.dataAggregator.collectWeeklyData(weekStartDate, weekEndDate);
      const reportContent = this.templateEngine.renderWeeklyTemplate(reportData);
      const reportId = this.saveReportToDatabase('weekly', weekStartDate, reportContent, reportData);
      
      this.exportService.generateMultipleFormats(reportId, reportContent, reportData);
      this.distributeReport(reportId, 'weekly');
      
      return {
        success: true,
        reportId: reportId,
        message: '周报生成成功'
      };
      
    } catch (error) {
      console.error('生成周报失败:', error);
      throw new Error(`周报生成失败: ${error.message}`);
    }
  }
  
  // 生成月报
  generateMonthlyReport(year, month) {
    try {
      const reportData = this.dataAggregator.collectMonthlyData(year, month);
      const reportContent = this.templateEngine.renderMonthlyTemplate(reportData);
      const reportId = this.saveReportToDatabase('monthly', new Date(year, month - 1), reportContent, reportData);
      
      this.exportService.generateMultipleFormats(reportId, reportContent, reportData);
      this.distributeReport(reportId, 'monthly');
      
      return {
        success: true,
        reportId: reportId,
        message: '月报生成成功'
      };
      
    } catch (error) {
      console.error('生成月报失败:', error);
      throw new Error(`月报生成失败: ${error.message}`);
    }
  }
  
  // 生成年报
  generateYearlyReport(year) {
    try {
      const reportData = this.dataAggregator.collectYearlyData(year);
      const reportContent = this.templateEngine.renderYearlyTemplate(reportData);
      const reportId = this.saveReportToDatabase('yearly', new Date(year, 0), reportContent, reportData);
      
      this.exportService.generateMultipleFormats(reportId, reportContent, reportData);
      this.distributeReport(reportId, 'yearly');
      
      return {
        success: true,
        reportId: reportId,
        message: '年报生成成功'
      };
      
    } catch (error) {
      console.error('生成年报失败:', error);
      throw new Error(`年报生成失败: ${error.message}`);
    }
  }
}

// 报告数据聚合器
class ReportDataAggregator {
  
  // 收集日报数据
  collectDailyData(date) {
    const dateStr = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    
    return {
      reportDate: dateStr,
      generatedAt: new Date().toISOString(),
      
      // 核心指标
      metrics: {
        newInsights: this.getNewInsightsCount(dateStr),
        highValueInsights: this.getHighValueInsightsCount(dateStr),
        actionItems: this.getActionItemsCount(dateStr),
        dataQuality: this.calculateDataQuality(dateStr)
      },
      
      // 重点洞察
      topInsights: this.getTopInsights(dateStr, 5),
      
      // 市场情报
      marketUpdates: this.getMarketUpdates(dateStr),
      
      // 行动建议
      actionRecommendations: this.getActionRecommendations(dateStr),
      
      // 数据源统计
      dataSources: this.getDataSourceStats(dateStr),
      
      // 系统健康度
      systemHealth: this.getSystemHealthMetrics(dateStr)
    };
  }
  
  // 收集周报数据
  collectWeeklyData(startDate, endDate) {
    const startStr = Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    const endStr = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    
    return {
      reportPeriod: `${startStr} 至 ${endStr}`,
      weekNumber: this.getWeekNumber(startDate),
      generatedAt: new Date().toISOString(),
      
      // 周度汇总指标
      weeklyMetrics: {
        totalInsights: this.getInsightsCountInPeriod(startStr, endStr),
        avgDailyInsights: this.getAvgDailyInsights(startStr, endStr),
        completedActions: this.getCompletedActionsCount(startStr, endStr),
        trendAnalysis: this.getTrendAnalysis(startStr, endStr)
      },
      
      // 重要发现
      keyFindings: this.getKeyFindings(startStr, endStr),
      
      // 技术趋势
      techTrends: this.getTechTrends(startStr, endStr),
      
      // 竞争动态
      competitiveDynamics: this.getCompetitiveDynamics(startStr, endStr),
      
      // 投资机会
      investmentOpportunities: this.getInvestmentOpportunities(startStr, endStr)
    };
  }
  
  // 收集月报数据
  collectMonthlyData(year, month) {
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    const startStr = Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    const endStr = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    
    return {
      reportPeriod: `${year}年${month}月`,
      generatedAt: new Date().toISOString(),
      
      // 月度汇总
      monthlyMetrics: {
        totalInsights: this.getInsightsCountInPeriod(startStr, endStr),
        highImpactInsights: this.getHighImpactInsightsCount(startStr, endStr),
        investmentDecisions: this.getInvestmentDecisionsCount(startStr, endStr),
        roiRealized: this.getROIRealized(startStr, endStr)
      },
      
      // 技术领域分析
      technologyDomains: this.getTechnologyDomainsAnalysis(startStr, endStr),
      
      // 市场机会分析
      marketOpportunities: this.getMarketOpportunitiesAnalysis(startStr, endStr),
      
      // 竞争格局分析
      competitiveLandscape: this.getCompetitiveLandscapeAnalysis(startStr, endStr),
      
      // 投资组合分析
      portfolioAnalysis: this.getPortfolioAnalysis(startStr, endStr)
    };
  }
  
  // 收集年报数据
  collectYearlyData(year) {
    const startDate = new Date(year, 0, 1);
    const endDate = new Date(year, 11, 31);
    const startStr = Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    const endStr = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    
    return {
      reportYear: year,
      generatedAt: new Date().toISOString(),
      
      // 年度汇总
      yearlyMetrics: {
        totalInsights: this.getInsightsCountInPeriod(startStr, endStr),
        majorBreakthroughs: this.getMajorBreakthroughs(startStr, endStr),
        successfulInvestments: this.getSuccessfulInvestments(startStr, endStr),
        totalROI: this.getTotalROI(startStr, endStr)
      },
      
      // 年度技术趋势
      yearlyTechTrends: this.getYearlyTechTrends(startStr, endStr),
      
      // 行业格局变化
      industryLandscapeChanges: this.getIndustryLandscapeChanges(startStr, endStr),
      
      // 投资回顾
      investmentReview: this.getInvestmentReview(startStr, endStr),
      
      // 下年度展望
      nextYearOutlook: this.generateNextYearOutlook(year)
    };
  }
}
```

**报告模板引擎：**
```javascript
// 报告模板引擎
class ReportTemplateEngine {
  
  // 渲染日报模板
  renderDailyTemplate(data) {
    return `
      <div class="daily-report">
        <div class="report-header">
          <h1>技术洞察日报</h1>
          <div class="report-meta">
            <span>报告日期: ${data.reportDate}</span>
            <span>生成时间: ${new Date(data.generatedAt).toLocaleString()}</span>
          </div>
        </div>
        
        <div class="executive-summary">
          <h2>执行摘要</h2>
          <div class="summary-metrics">
            <div class="metric-item">
              <span class="metric-label">新增洞察:</span>
              <span class="metric-value">${data.metrics.newInsights}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">高价值发现:</span>
              <span class="metric-value">${data.metrics.highValueInsights}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">行动建议:</span>
              <span class="metric-value">${data.metrics.actionItems}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">数据质量:</span>
              <span class="metric-value">${data.metrics.dataQuality}/10</span>
            </div>
          </div>
        </div>
        
        <div class="top-insights-section">
          <h2>重点洞察</h2>
          ${this.renderInsightsList(data.topInsights)}
        </div>
        
        <div class="market-intelligence-section">
          <h2>市场情报</h2>
          ${this.renderMarketUpdates(data.marketUpdates)}
        </div>
        
        <div class="action-recommendations-section">
          <h2>行动建议</h2>
          ${this.renderActionRecommendations(data.actionRecommendations)}
        </div>
        
        <div class="data-sources-section">
          <h2>数据来源统计</h2>
          ${this.renderDataSourceStats(data.dataSources)}
        </div>
        
        <div class="system-health-section">
          <h2>系统健康度</h2>
          ${this.renderSystemHealth(data.systemHealth)}
        </div>
      </div>
    `;
  }
  
  // 渲染周报模板
  renderWeeklyTemplate(data) {
    return `
      <div class="weekly-report">
        <div class="report-header">
          <h1>技术洞察周报</h1>
          <div class="report-meta">
            <span>报告期间: ${data.reportPeriod}</span>
            <span>第${data.weekNumber}周</span>
            <span>生成时间: ${new Date(data.generatedAt).toLocaleString()}</span>
          </div>
        </div>
        
        <div class="weekly-summary">
          <h2>周度汇总</h2>
          <div class="weekly-metrics-grid">
            <div class="metric-card">
              <div class="metric-number">${data.weeklyMetrics.totalInsights}</div>
              <div class="metric-label">总洞察数</div>
            </div>
            <div class="metric-card">
              <div class="metric-number">${data.weeklyMetrics.avgDailyInsights}</div>
              <div class="metric-label">日均洞察</div>
            </div>
            <div class="metric-card">
              <div class="metric-number">${data.weeklyMetrics.completedActions}</div>
              <div class="metric-label">完成行动</div>
            </div>
          </div>
        </div>
        
        <div class="key-findings-section">
          <h2>重要发现</h2>
          ${this.renderKeyFindings(data.keyFindings)}
        </div>
        
        <div class="tech-trends-section">
          <h2>技术趋势</h2>
          ${this.renderTechTrends(data.techTrends)}
        </div>
        
        <div class="competitive-dynamics-section">
          <h2>竞争动态</h2>
          ${this.renderCompetitiveDynamics(data.competitiveDynamics)}
        </div>
        
        <div class="investment-opportunities-section">
          <h2>投资机会</h2>
          ${this.renderInvestmentOpportunities(data.investmentOpportunities)}
        </div>
      </div>
    `;
  }
  
  // 渲染月报模板
  renderMonthlyTemplate(data) {
    return `
      <div class="monthly-report">
        <div class="report-header">
          <h1>技术洞察月报</h1>
          <div class="report-meta">
            <span>报告期间: ${data.reportPeriod}</span>
            <span>生成时间: ${new Date(data.generatedAt).toLocaleString()}</span>
          </div>
        </div>
        
        <div class="monthly-overview">
          <h2>月度概览</h2>
          <div class="overview-grid">
            <div class="overview-item">
              <h3>洞察发现</h3>
              <div class="overview-stats">
                <span>总计: ${data.monthlyMetrics.totalInsights}</span>
                <span>高影响: ${data.monthlyMetrics.highImpactInsights}</span>
              </div>
            </div>
            <div class="overview-item">
              <h3>投资决策</h3>
              <div class="overview-stats">
                <span>决策数: ${data.monthlyMetrics.investmentDecisions}</span>
                <span>已实现ROI: ${data.monthlyMetrics.roiRealized}%</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="technology-domains-section">
          <h2>技术领域分析</h2>
          ${this.renderTechnologyDomains(data.technologyDomains)}
        </div>
        
        <div class="market-opportunities-section">
          <h2>市场机会分析</h2>
          ${this.renderMarketOpportunities(data.marketOpportunities)}
        </div>
        
        <div class="competitive-landscape-section">
          <h2>竞争格局分析</h2>
          ${this.renderCompetitiveLandscape(data.competitiveLandscape)}
        </div>
        
        <div class="portfolio-analysis-section">
          <h2>投资组合分析</h2>
          ${this.renderPortfolioAnalysis(data.portfolioAnalysis)}
        </div>
      </div>
    `;
  }
  
  // 渲染年报模板
  renderYearlyTemplate(data) {
    return `
      <div class="yearly-report">
        <div class="report-header">
          <h1>技术洞察年报</h1>
          <div class="report-meta">
            <span>报告年度: ${data.reportYear}</span>
            <span>生成时间: ${new Date(data.generatedAt).toLocaleString()}</span>
          </div>
        </div>
        
        <div class="yearly-summary">
          <h2>年度总结</h2>
          <div class="yearly-highlights">
            <div class="highlight-item">
              <h3>洞察成果</h3>
              <div class="highlight-stats">
                <span>总洞察: ${data.yearlyMetrics.totalInsights}</span>
                <span>重大突破: ${data.yearlyMetrics.majorBreakthroughs}</span>
              </div>
            </div>
            <div class="highlight-item">
              <h3>投资回报</h3>
              <div class="highlight-stats">
                <span>成功投资: ${data.yearlyMetrics.successfulInvestments}</span>
                <span>总ROI: ${data.yearlyMetrics.totalROI}%</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="yearly-tech-trends-section">
          <h2>年度技术趋势</h2>
          ${this.renderYearlyTechTrends(data.yearlyTechTrends)}
        </div>
        
        <div class="industry-changes-section">
          <h2>行业格局变化</h2>
          ${this.renderIndustryLandscapeChanges(data.industryLandscapeChanges)}
        </div>
        
        <div class="investment-review-section">
          <h2>投资回顾</h2>
          ${this.renderInvestmentReview(data.investmentReview)}
        </div>
        
        <div class="next-year-outlook-section">
          <h2>下年度展望</h2>
          ${this.renderNextYearOutlook(data.nextYearOutlook)}
        </div>
      </div>
    `;
  }
}
```

**报告自动生成触发器设置：**
```javascript
// 设置自动报告生成触发器
function setupReportGenerationTriggers() {
  // 删除现有触发器
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction().startsWith('auto')) {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // 日报生成触发器 - 每日早上8点
  ScriptApp.newTrigger('autoGenerateDailyReport')
    .timeBased()
    .everyDays(1)
    .atHour(8)
    .create();
  
  // 周报生成触发器 - 每周一早上9点
  ScriptApp.newTrigger('autoGenerateWeeklyReport')
    .timeBased()
    .onWeekDay(ScriptApp.WeekDay.MONDAY)
    .atHour(9)
    .create();
  
  // 月报生成触发器 - 每月1日早上10点
  ScriptApp.newTrigger('autoGenerateMonthlyReport')
    .timeBased()
    .onMonthDay(1)
    .atHour(10)
    .create();
  
  // 年报生成触发器 - 每年1月15日
  ScriptApp.newTrigger('autoGenerateYearlyReport')
    .timeBased()
    .onMonthDay(15)
    .nearMinute(0)
    .inMonth(1)
    .create();
}

// 自动生成日报
function autoGenerateDailyReport() {
  const reportService = new TechInsightReportService();
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  
  try {
    const result = reportService.generateDailyReport(yesterday);
    console.log('日报自动生成成功:', result);
  } catch (error) {
    console.error('日报自动生成失败:', error);
    // 发送错误通知
    sendErrorNotification('日报生成失败', error.message);
  }
}

// 自动生成周报
function autoGenerateWeeklyReport() {
  const reportService = new TechInsightReportService();
  const lastWeekStart = new Date();
  lastWeekStart.setDate(lastWeekStart.getDate() - 7);
  
  try {
    const result = reportService.generateWeeklyReport(lastWeekStart);
    console.log('周报自动生成成功:', result);
  } catch (error) {
    console.error('周报自动生成失败:', error);
    sendErrorNotification('周报生成失败', error.message);
  }
}

// 自动生成月报
function autoGenerateMonthlyReport() {
  const reportService = new TechInsightReportService();
  const lastMonth = new Date();
  lastMonth.setMonth(lastMonth.getMonth() - 1);
  
  try {
    const result = reportService.generateMonthlyReport(lastMonth.getFullYear(), lastMonth.getMonth() + 1);
    console.log('月报自动生成成功:', result);
  } catch (error) {
    console.error('月报自动生成失败:', error);
    sendErrorNotification('月报生成失败', error.message);
  }
}

// 自动生成年报
function autoGenerateYearlyReport() {
  const reportService = new TechInsightReportService();
  const lastYear = new Date().getFullYear() - 1;
  
  try {
    const result = reportService.generateYearlyReport(lastYear);
    console.log('年报自动生成成功:', result);
  } catch (error) {
    console.error('年报自动生成失败:', error);
    sendErrorNotification('年报生成失败', error.message);
  }
}
```

这个修正版本明确了：

1. **技术架构**: Google Apps Script + HTML Service
2. **构建平台**: Google Apps Script在线编辑器
3. **部署平台**: Google Cloud Platform Apps Script Runtime
4. **报告功能**: 完整的日报、周报、月报、年报自动生成系统
5. **数据集成**: 与现有Make工作流和Google Sheets完美集成

整个系统完全基于Google生态，确保了架构的一致性和可维护性。

**技术洞察分析引擎 - 系统设计文档（完善版）**

---

**全系统数字点击展开详情设计**

**通用数字展开交互规范：**

**设计原则：**
- 所有页面的数字型指标都支持点击展开
- 统一的交互样式和行为模式
- 根据数据量自动选择展示方式
- 支持多级数据钻取

**通用CSS样式规范：**
```css
/* 可点击数字的通用样式 */
.clickable-number {
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 4px;
  padding: 2px 4px;
}

.clickable-number:hover {
  background-color: #f0f8ff;
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.clickable-number::after {
  content: " 🔍";
  font-size: 0.8em;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.clickable-number:hover::after {
  opacity: 1;
}

/* 不同数据量级的视觉提示 */
.clickable-number.small-data::after { content: " 📋"; }
.clickable-number.medium-data::after { content: " 📊"; }
.clickable-number.large-data::after { content: " 🔗"; }
```

**通用JavaScript展开逻辑：**
```javascript
// 通用数字点击处理函数
function handleNumberClick(element, dataType, value, metadata = {}) {
  const dataCount = metadata.count || value;
  const pageContext = metadata.page || getCurrentPage();
  
  // 根据数据量决定展示方式
  if (dataCount <= 50) {
    showModalDetails(dataType, value, metadata);
  } else if (dataCount <= 500) {
    showExpandedModal(dataType, value, metadata);
  } else {
    openDetailPage(dataType, value, metadata);
  }
  
  // 记录用户行为
  logUserInteraction('number_click', {
    page: pageContext,
    dataType: dataType,
    value: value,
    timestamp: new Date().toISOString()
  });
}

// 模态框详情展示
function showModalDetails(dataType, value, metadata) {
  const modal = document.getElementById('universalDetailModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  
  modalTitle.textContent = generateModalTitle(dataType, value, metadata);
  modalContent.innerHTML = '<div class="loading-spinner">加载中...</div>';
  
  modal.style.display = 'block';
  
  // 异步加载详细数据
  google.script.run
    .withSuccessHandler(data => renderModalContent(modalContent, data))
    .withFailureHandler(error => showErrorInModal(modalContent, error))
    .getDetailedData(dataType, metadata);
}

// 新页面详情展示
function openDetailPage(dataType, value, metadata) {
  const params = new URLSearchParams({
    type: dataType,
    value: value,
    ...metadata
  });
  
  const detailUrl = `details.html?${params.toString()}`;
  window.open(detailUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}
```

---

**各页面数字展开功能详细设计**

**1. 主页面（index.html）数字展开：**

```html
<!-- 主页KPI数字展开示例 -->
<div class="kpi-card">
  <div class="kpi-number clickable-number medium-data" 
       onclick="handleNumberClick(this, 'daily_insights', 42, {
         page: 'overview',
         dateRange: 'today',
         category: 'all'
       })">
    42
  </div>
  <div class="kpi-label">今日新增洞察</div>
</div>

<div class="kpi-card">
  <div class="kpi-number clickable-number small-data"
       onclick="handleNumberClick(this, 'processing_tasks', 8, {
         page: 'overview',
         status: 'processing'
       })">
    8
  </div>
  <div class="kpi-label">处理中任务</div>
</div>

<div class="kpi-card">
  <div class="kpi-number clickable-number small-data"
       onclick="handleNumberClick(this, 'system_health', 98.2, {
         page: 'overview',
         metric: 'health_score'
       })">
    98.2%
  </div>
  <div class="kpi-label">系统健康度</div>
</div>
```

**2. 数据采集页面（collection.html）数字展开：**

```html
<!-- 技术数据采集区域数字展开 -->
<div class="tech-data-section">
  <div class="data-source-card">
    <div class="card-metrics">
      <div class="metric-item">
        <div class="metric-number clickable-number medium-data"
             onclick="handleNumberClick(this, 'academic_papers_today', 45, {
               page: 'collection',
               source: 'academic_papers',
               dateRange: 'today',
               detailLevel: 'full'
             })">
          45
        </div>
        <div class="metric-label">今日采集</div>
      </div>
      
      <div class="metric-item">
        <div class="metric-number clickable-number large-data"
             onclick="handleNumberClick(this, 'academic_papers_total', 1250, {
               page: 'collection',
               source: 'academic_papers',
               dateRange: 'all',
               enablePagination: true,
               pageSize: 25
             })">
          1,250
        </div>
        <div class="metric-label">总计</div>
      </div>
      
      <div class="metric-item">
        <div class="metric-number clickable-number small-data"
             onclick="handleNumberClick(this, 'papers_quality_breakdown', 8.2, {
               page: 'collection',
               source: 'academic_papers',
               metric: 'quality_distribution'
             })">
          8.2
        </div>
        <div class="metric-label">质量评分</div>
      </div>
    </div>
  </div>
</div>

<!-- 标杆数据采集区域数字展开 -->
<div class="benchmark-data-section">
  <div class="data-source-card">
    <div class="card-metrics">
      <div class="metric-item">
        <div class="metric-number clickable-number medium-data"
             onclick="handleNumberClick(this, 'industry_dynamics_today', 32, {
               page: 'collection',
               source: 'industry_dynamics',
               dateRange: 'today',
               includeDetails: true
             })">
          32
        </div>
        <div class="metric-label">今日动态</div>
      </div>
      
      <div class="metric-item">
        <div class="metric-number clickable-number small-data"
             onclick="handleNumberClick(this, 'critical_events', 5, {
               page: 'collection',
               source: 'industry_dynamics',
               priority: 'critical',
               showTimeline: true
             })">
          5
        </div>
        <div class="metric-label">重要事件</div>
      </div>
    </div>
  </div>
</div>
```

**3. 技术洞察页面（insights.html）数字展开：**

```html
<!-- 洞察概览数字展开 -->
<div class="insights-overview">
  <div class="metric-card">
    <div class="metric-number clickable-number large-data"
         onclick="handleNumberClick(this, 'total_insights', 128, {
           page: 'insights',
           category: 'all',
           sortBy: 'date_desc',
           enableFiltering: true
         })">
      128
    </div>
    <div class="metric-label">总洞察数</div>
  </div>
  
  <div class="metric-card">
    <div class="metric-number clickable-number medium-data"
         onclick="handleNumberClick(this, 'high_value_insights', 23, {
           page: 'insights',
           valueThreshold: 8.0,
           includeAnalysis: true,
           showActionable: true
         })">
      23
    </div>
    <div class="metric-label">高价值洞察</div>
  </div>
</div>

<!-- 商业价值分析数字展开 -->
<div id="commercial-panel" class="analysis-panel">
  <div class="roi-metrics">
    <div class="roi-item">
      <div class="roi-number clickable-number small-data"
           onclick="handleNumberClick(this, 'high_roi_projects', 8, {
             page: 'insights',
             analysis: 'commercial',
             roiThreshold: 20,
             showProjectDetails: true
           })">
        8
      </div>
      <div class="roi-label">高ROI项目</div>
    </div>
    
    <div class="roi-item">
      <div class="roi-number clickable-number small-data"
           onclick="handleNumberClick(this, 'average_roi_breakdown', 15.6, {
             page: 'insights',
             analysis: 'commercial',
             metric: 'roi_distribution',
             showCalculation: true
           })">
        15.6%
      </div>
      <div class="roi-label">平均ROI</div>
    </div>
  </div>
</div>

<!-- 竞争情报分析数字展开 -->
<div id="competitive-panel" class="analysis-panel">
  <div class="threat-assessment">
    <div class="threat-level-card high">
      <div class="threat-number clickable-number small-data"
           onclick="handleNumberClick(this, 'high_threat_competitors', 3, {
             page: 'insights',
             analysis: 'competitive',
             threatLevel: 'high',
             showCompetitorProfiles: true
           })">
        3
      </div>
      <div class="threat-label">高威胁</div>
    </div>
  </div>
</div>
```

**4. 决策行动页面（actions.html）数字展开：**

```html
<!-- 决策仪表板数字展开 -->
<div class="decision-dashboard">
  <div class="metric-card investment">
    <div class="metric-number clickable-number medium-data"
         onclick="handleNumberClick(this, 'investment_opportunities', 25, {
           page: 'actions',
           category: 'opportunities',
           enableGrading: true,
           showROIProjection: true
         })">
      25
    </div>
    <div class="metric-label">投资机会</div>
  </div>
  
  <div class="metric-card actions">
    <div class="metric-number clickable-number medium-data"
         onclick="handleNumberClick(this, 'pending_actions', 12, {
           page: 'actions',
           status: 'pending',
           enableStatusUpdate: true,
           showPriorityFilter: true
         })">
      12
    </div>
    <div class="metric-label">待执行行动</div>
  </div>
</div>

<!-- 投资机会评级数字展开 -->
<div class="investment-opportunities">
  <div class="level-card grade-a">
    <div class="grade-number clickable-number small-data"
         onclick="handleNumberClick(this, 'grade_a_opportunities', 5, {
           page: 'actions',
           grade: 'A',
           showDetailedAnalysis: true,
           enableActionInput: true
         })">
      5
    </div>
    <div class="grade-label">高价值机会</div>
  </div>
</div>
```

**5. 报告页面（reports.html）数字展开：**

```html
<!-- 报告统计数字展开 -->
<div class="reports-stats">
  <div class="stat-card">
    <div class="stat-number clickable-number medium-data"
         onclick="handleNumberClick(this, 'daily_reports', 30, {
           page: 'reports',
           reportType: 'daily',
           dateRange: 'last_30_days',
           enableSearch: true
         })">
      30
    </div>
    <div class="stat-label">日报</div>
  </div>
  
  <div class="stat-card">
    <div class="stat-number clickable-number small-data"
         onclick="handleNumberClick(this, 'weekly_reports', 4, {
           page: 'reports',
           reportType: 'weekly',
           showContent: true,
           enableDownload: true
         })">
      4
    </div>
    <div class="stat-label">周报</div>
  </div>
</div>
```

---

**高价值线索行动输入功能设计**

**高价值线索行动管理界面：**

```html
<!-- 高价值线索详情弹窗 -->
<div id="highValueInsightModal" class="modal large-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="insightTitle">高价值线索详情</h3>
      <span class="close">&times;</span>
    </div>
    
    <div class="modal-body">
      <!-- 线索基本信息 -->
      <div class="insight-basic-info">
        <div class="info-grid">
          <div class="info-item">
            <label>线索ID:</label>
            <span id="insightId">TI20250624001</span>
          </div>
          <div class="info-item">
            <label>发现时间:</label>
            <span id="discoveryTime">2025-06-24 09:30:00</span>
          </div>
          <div class="info-item">
            <label>价值评分:</label>
            <span id="valueScore" class="score-high">9.2/10</span>
          </div>
          <div class="info-item">
            <label>当前状态:</label>
            <span id="currentStatus" class="status-pending">待行动</span>
          </div>
        </div>
      </div>
      
      <!-- 线索详细内容 -->
      <div class="insight-content">
        <h4>线索内容</h4>
        <div id="insightContent" class="content-display">
          <!-- 动态加载线索详细内容 -->
        </div>
      </div>
      
      <!-- 分析结果 -->
      <div class="analysis-results">
        <div class="analysis-tabs">
          <div class="tab active" data-tab="commercial">商业分析</div>
          <div class="tab" data-tab="technical">技术分析</div>
          <div class="tab" data-tab="competitive">竞争分析</div>
        </div>
        <div class="analysis-content" id="analysisContent">
          <!-- 动态加载分析内容 -->
        </div>
      </div>
      
      <!-- 历史行动记录 -->
      <div class="action-history">
        <h4>历史行动记录</h4>
        <div id="actionHistory" class="history-timeline">
          <!-- 动态加载历史记录 -->
        </div>
      </div>
      
      <!-- 下一步行动输入区域 -->
      <div class="next-action-section">
        <h4>下一步行动规划</h4>
        
        <form id="nextActionForm" class="action-form">
          <div class="form-group">
            <label for="actionType">行动类型:</label>
            <select id="actionType" name="actionType" required>
              <option value="">请选择行动类型</option>
              <option value="investment">投资决策</option>
              <option value="research">深入研究</option>
              <option value="partnership">寻求合作</option>
              <option value="monitoring">持续监控</option>
              <option value="prototype">原型开发</option>
              <option value="market_analysis">市场分析</option>
              <option value="competitive_response">竞争应对</option>
              <option value="other">其他</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="actionPriority">优先级:</label>
            <select id="actionPriority" name="actionPriority" required>
              <option value="">请选择优先级</option>
              <option value="urgent">紧急</option>
              <option value="high">高</option>
              <option value="medium">中</option>
              <option value="low">低</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="actionDescription">行动描述:</label>
            <textarea id="actionDescription" name="actionDescription" 
                      rows="4" placeholder="请详细描述下一步具体行动计划..." required></textarea>
          </div>
          
          <div class="form-group">
            <label for="expectedOutcome">预期结果:</label>
            <textarea id="expectedOutcome" name="expectedOutcome" 
                      rows="3" placeholder="描述预期达成的结果和目标..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="estimatedBudget">预估预算:</label>
            <div class="budget-input">
              <select id="budgetCurrency" name="budgetCurrency">
                <option value="USD">USD</option>
                <option value="CNY">CNY</option>
                <option value="EUR">EUR</option>
              </select>
              <input type="number" id="estimatedBudget" name="estimatedBudget" 
                     placeholder="0" min="0" step="1000">
            </div>
          </div>
          
          <div class="form-group">
            <label for="targetDate">目标完成日期:</label>
            <input type="date" id="targetDate" name="targetDate" required>
          </div>
          
          <div class="form-group">
            <label for="assignedTo">负责人:</label>
            <input type="text" id="assignedTo" name="assignedTo" 
                   placeholder="输入负责人姓名或邮箱">
          </div>
          
          <div class="form-group">
            <label for="keyMilestones">关键里程碑:</label>
            <div id="milestonesContainer">
              <div class="milestone-item">
                <input type="text" name="milestone[]" placeholder="里程碑描述">
                <input type="date" name="milestoneDate[]">
                <button type="button" onclick="removeMilestone(this)">删除</button>
              </div>
            </div>
            <button type="button" onclick="addMilestone()">添加里程碑</button>
          </div>
          
          <div class="form-group">
            <label for="riskAssessment">风险评估:</label>
            <textarea id="riskAssessment" name="riskAssessment" 
                      rows="3" placeholder="识别可能的风险和应对措施..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="successMetrics">成功指标:</label>
            <textarea id="successMetrics" name="successMetrics" 
                      rows="2" placeholder="定义衡量成功的具体指标..."></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" onclick="saveAsDraft()">保存草稿</button>
            <button type="submit">提交行动计划</button>
            <button type="button" onclick="closeModal()">取消</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
```

**行动输入的JavaScript处理逻辑：**

```javascript
// 高价值线索行动管理类
class HighValueInsightActionManager {
  
  constructor() {
    this.currentInsightId = null;
    this.formValidator = new FormValidator();
  }
  
  // 显示高价值线索详情和行动输入界面
  showInsightActionModal(insightId) {
    this.currentInsightId = insightId;
    
    // 加载线索详情
    google.script.run
      .withSuccessHandler(data => this.renderInsightDetails(data))
      .withFailureHandler(error => this.handleError(error))
      .getHighValueInsightDetails(insightId);
    
    // 显示模态框
    document.getElementById('highValueInsightModal').style.display = 'block';
  }
  
  // 渲染线索详情
  renderInsightDetails(data) {
    document.getElementById('insightId').textContent = data.insightId;
    document.getElementById('discoveryTime').textContent = data.discoveryTime;
    document.getElementById('valueScore').textContent = `${data.valueScore}/10`;
    document.getElementById('currentStatus').textContent = data.currentStatus;
    document.getElementById('insightContent').innerHTML = data.content;
    
    // 渲染分析结果
    this.renderAnalysisResults(data.analysisResults);
    
    // 渲染历史行动记录
    this.renderActionHistory(data.actionHistory);
    
    // 预填充表单（如果有草稿）
    if (data.draftAction) {
      this.populateForm(data.draftAction);
    }
  }
  
  // 提交行动计划
  submitActionPlan(formData) {
    // 表单验证
    if (!this.formValidator.validate(formData)) {
      return;
    }
    
    // 显示提交状态
    this.showSubmitStatus('submitting');
    
    // 准备提交数据
    const actionData = {
      insightId: this.currentInsightId,
      actionType: formData.actionType,
      priority: formData.actionPriority,
      description: formData.actionDescription,
      expectedOutcome: formData.expectedOutcome,
      estimatedBudget: {
        amount: formData.estimatedBudget,
        currency: formData.budgetCurrency
      },
      targetDate: formData.targetDate,
      assignedTo: formData.assignedTo,
      milestones: this.parseMilestones(formData),
      riskAssessment: formData.riskAssessment,
      successMetrics: formData.successMetrics,
      createdBy: Session.getActiveUser().getEmail(),
      createdAt: new Date().toISOString(),
      status: 'planned'
    };
    
    // 提交到后端
    google.script.run
      .withSuccessHandler(result => this.handleSubmitSuccess(result))
      .withFailureHandler(error => this.handleSubmitError(error))
      .saveHighValueInsightAction(actionData);
  }
  
  // 保存草稿
  saveAsDraft() {
    const formData = this.getFormData();
    const draftData = {
      insightId: this.currentInsightId,
      formData: formData,
      savedAt: new Date().toISOString()
    };
    
    google.script.run
      .withSuccessHandler(() => this.showMessage('草稿已保存', 'success'))
      .withFailureHandler(error => this.showMessage('保存草稿失败', 'error'))
      .saveDraftAction(draftData);
  }
  
  // 添加里程碑
  addMilestone() {
    const container = document.getElementById('milestonesContainer');
    const milestoneItem = document.createElement('div');
    milestoneItem.className = 'milestone-item';
    milestoneItem.innerHTML = `
      <input type="text" name="milestone[]" placeholder="里程碑描述">
      <input type="date" name="milestoneDate[]">
      <button type="button" onclick="removeMilestone(this)">删除</button>
    `;
    container.appendChild(milestoneItem);
  }
  
  // 删除里程碑
  removeMilestone(button) {
    button.parentElement.remove();
  }
  
  // 获取表单数据
  getFormData() {
    const form = document.getElementById('nextActionForm');
    const formData = new FormData(form);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
      if (key.endsWith('[]')) {
        const arrayKey = key.slice(0, -2);
        if (!data[arrayKey]) data[arrayKey] = [];
        data[arrayKey].push(value);
      } else {
        data[key] = value;
      }
    }
    
    return data;
  }
  
  // 处理提交成功
  handleSubmitSuccess(result) {
    this.showSubmitStatus('success');
    this.showMessage('行动计划提交成功！', 'success');
    
    // 更新线索状态
    this.updateInsightStatus(result.insightId, 'action_planned');
    
    // 清空表单
    document.getElementById('nextActionForm').reset();
    
    // 刷新相关数据
    this.refreshActionData();
    
    // 3秒后关闭模态框
    setTimeout(() => {
      this.closeModal();
    }, 3000);
  }
  
  // 处理提交错误
  handleSubmitError(error) {
    this.showSubmitStatus('error');
    this.showMessage(`提交失败: ${error.message}`, 'error');
  }
}

// 表单验证器
class FormValidator {
  validate(formData) {
    const errors = [];
    
    // 必填字段验证
    if (!formData.actionType) errors.push('请选择行动类型');
    if (!formData.actionPriority) errors.push('请选择优先级');
    if (!formData.actionDescription) errors.push('请填写行动描述');
    if (!formData.targetDate) errors.push('请选择目标完成日期');
    
    // 日期验证
    if (formData.targetDate && new Date(formData.targetDate) <= new Date()) {
      errors.push('目标完成日期必须是未来日期');
    }
    
    // 预算验证
    if (formData.estimatedBudget && formData.estimatedBudget < 0) {
      errors.push('预估预算不能为负数');
    }
    
    // 显示错误信息
    if (errors.length > 0) {
      this.showValidationErrors(errors);
      return false;
    }
    
    return true;
  }
  
  showValidationErrors(errors) {
    const errorContainer = document.createElement('div');
    errorContainer.className = 'validation-errors';
    errorContainer.innerHTML = `
      <h4>请修正以下错误：</h4>
      <ul>
        ${errors.map(error => `<li>${error}</li>`).join('')}
      </ul>
    `;
    
    // 显示错误信息
    const form = document.getElementById('nextActionForm');
    form.insertBefore(errorContainer, form.firstChild);
    
    // 3秒后自动隐藏
    setTimeout(() => {
      errorContainer.remove();
    }, 5000);
  }
}

// 初始化行动管理器
const insightActionManager = new HighValueInsightActionManager();

// 表单提交事件处理
document.getElementById('nextActionForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = insightActionManager.getFormData();
  insightActionManager.submitActionPlan(formData);
});
```

**后端数据库写入服务：**

```javascript
// Google Apps Script 后端服务
function saveHighValueInsightAction(actionData) {
  try {
    // 获取行动建议表
    const actionSheet = SpreadsheetApp.openById(ACTION_RECOMMENDATIONS_SHEET_ID)
                                    .getSheetByName('Action_Recommendations');
    
    // 生成行动ID
    const actionId = generateActionId();
    
    // 准备写入数据
    const rowData = [
      actionId,                           // action_id
      actionData.insightId,              // related_insight_id
      actionData.actionType,             // action_type
      actionData.priority,               // priority
      actionData.description,            // description
      actionData.expectedOutcome,        // expected_outcome
      actionData.estimatedBudget.amount, // estimated_budget
      actionData.estimatedBudget.currency, // budget_currency
      actionData.targetDate,             // target_date
      actionData.assignedTo,             // assigned_to
      JSON.stringify(actionData.milestones), // milestones
      actionData.riskAssessment,         // risk_assessment
      actionData.successMetrics,         // success_metrics
      actionData.status,                 // status
      actionData.createdBy,              // created_by
      actionData.createdAt,              // created_at
      '',                                // updated_at
      '',                                // completed_at
      ''                                 // notes
    ];
    
    // 写入数据
    actionSheet.appendRow(rowData);
    
    // 更新相关洞察的状态
    updateInsightActionStatus(actionData.insightId, actionId, 'action_planned');
    
    // 发送通知（如果指定了负责人）
    if (actionData.assignedTo) {
      sendActionAssignmentNotification(actionData);
    }
    
    return {
      success: true,
      actionId: actionId,
      insightId: actionData.insightId,
      message: '行动计划保存成功'
    };
    
  } catch (error) {
    console.error('保存行动计划失败:', error);
    throw new Error(`保存失败: ${error.message}`);
  }
}

// 更新洞察状态
function updateInsightActionStatus(insightId, actionId, status) {
  try {
    // 获取技术洞察主表
    const masterSheet = SpreadsheetApp.openById(TECH_INTELLIGENCE_MASTER_SHEET_ID)
                                     .getSheetByName('Tech_Intelligence_Master');
    
    const data = masterSheet.getDataRange().getValues();
    const headers = data[0];
    const insightIdCol = headers.indexOf('intelligence_id');
    const actionStatusCol = headers.indexOf('action_status');
    const linkedActionCol = headers.indexOf('linked_action_id');
    const lastUpdateCol = headers.indexOf('last_update_timestamp');
    
    // 查找对应的洞察记录
    for (let i = 1; i < data.length; i++) {
      if (data[i][insightIdCol] === insightId) {
        // 更新状态
        masterSheet.getRange(i + 1, actionStatusCol + 1).setValue(status);
        masterSheet.getRange(i + 1, linkedActionCol + 1).setValue(actionId);
        masterSheet.getRange(i + 1, lastUpdateCol + 1).setValue(new Date().toISOString());
        break;
      }
    }
    
    return true;
  } catch (error) {
    console.error('更新洞察状态失败:', error);
    throw error;
  }
}

// 生成行动ID
function generateActionId() {
  const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').substring(0, 14);
  const random = Math.random().toString(36).substring(2, 6).toUpperCase();
  return `ACT${timestamp}${random}`;
}

// 保存草稿行动
function saveDraftAction(draftData) {
  try {
    // 获取草稿存储表（如果不存在则创建）
    const draftSheet = getOrCreateDraftSheet();
    
    const rowData = [
      draftData.insightId,
      JSON.stringify(draftData.formData),
      draftData.savedAt,
      Session.getActiveUser().getEmail()
    ];
    
    // 检查是否已有草稿
    const existingDraftRow = findExistingDraft(draftSheet, draftData.insightId);
    
    if (existingDraftRow > 0) {
      // 更新现有草稿
      draftSheet.getRange(existingDraftRow, 1, 1, rowData.length).setValues([rowData]);
    } else {
      // 创建新草稿
      draftSheet.appendRow(rowData);
    }
    
    return { success: true, message: '草稿保存成功' };
  } catch (error) {
    console.error('保存草稿失败:', error);
    throw new Error(`保存草稿失败: ${error.message}`);
  }
}

// 获取或创建草稿表
function getOrCreateDraftSheet() {
  const spreadsheet = SpreadsheetApp.openById(ACTION_RECOMMENDATIONS_SHEET_ID);
  let draftSheet = spreadsheet.getSheetByName('Action_Drafts');
  
  if (!draftSheet) {
    draftSheet = spreadsheet.insertSheet('Action_Drafts');
    const headers = ['insight_id', 'draft_data', 'saved_at', 'saved_by'];
    draftSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }
  
  return draftSheet;
}

// 查找现有草稿
function findExistingDraft(draftSheet, insightId) {
  const data = draftSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === insightId) {
      return i + 1; // 返回行号（1-based）
    }
  }
  return 0; // 未找到
}

// 发送行动分配通知
function sendActionAssignmentNotification(actionData) {
  try {
    const emailSubject = `新的行动计划分配 - ${actionData.insightId}`;
    const emailBody = `
      您好，
      
      您被分配了一个新的行动计划：
      
      洞察ID: ${actionData.insightId}
      行动类型: ${actionData.actionType}
      优先级: ${actionData.priority}
      目标完成日期: ${actionData.targetDate}
      
      行动描述:
      ${actionData.description}
      
      预期结果:
      ${actionData.expectedOutcome}
      
      请登录系统查看详细信息并开始执行。
      
      技术洞察分析引擎
      ${new Date().toLocaleString()}
    `;
    
    // 发送邮件通知
    GmailApp.sendEmail(actionData.assignedTo, emailSubject, emailBody);
    
    // 记录通知日志
    logNotification('action_assignment', actionData.assignedTo, actionData.insightId);
    
  } catch (error) {
    console.error('发送通知失败:', error);
    // 通知失败不应该影响主流程，只记录错误
  }
}
```

**行动进度跟踪和更新功能：**

```html
<!-- 行动进度更新界面 -->
<div id="actionProgressModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>行动进度更新</h3>
      <span class="close">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="action-summary">
        <h4 id="actionTitle">行动计划概要</h4>
        <div class="summary-grid">
          <div class="summary-item">
            <label>行动ID:</label>
            <span id="actionId"></span>
          </div>
          <div class="summary-item">
            <label>关联洞察:</label>
            <span id="relatedInsight"></span>
          </div>
          <div class="summary-item">
            <label>当前状态:</label>
            <span id="currentActionStatus"></span>
          </div>
          <div class="summary-item">
            <label>进度:</label>
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill"></div>
              <span id="progressText">0%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="progress-update-form">
        <h4>进度更新</h4>
        <form id="progressUpdateForm">
          <div class="form-group">
            <label for="progressPercentage">完成进度 (%):</label>
            <input type="range" id="progressPercentage" name="progressPercentage" 
                   min="0" max="100" step="5" 
                   oninput="updateProgressDisplay(this.value)">
            <span id="progressValue">0%</span>
          </div>
          
          <div class="form-group">
            <label for="statusUpdate">状态更新:</label>
            <select id="statusUpdate" name="statusUpdate">
              <option value="planned">计划中</option>
              <option value="in_progress">执行中</option>
              <option value="on_hold">暂停</option>
              <option value="completed">已完成</option>
              <option value="cancelled">已取消</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="progressNotes">进度说明:</label>
            <textarea id="progressNotes" name="progressNotes" rows="4" 
                      placeholder="描述当前进展、遇到的问题或下一步计划..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="milestonesUpdate">里程碑更新:</label>
            <div id="milestonesProgress">
              <!-- 动态加载里程碑进度 -->
            </div>
          </div>
          
          <div class="form-group">
            <label for="budgetSpent">已用预算:</label>
            <div class="budget-input">
              <input type="number" id="budgetSpent" name="budgetSpent" 
                     placeholder="0" min="0" step="100">
              <span id="budgetCurrency">USD</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="nextSteps">下一步计划:</label>
            <textarea id="nextSteps" name="nextSteps" rows="3" 
                      placeholder="描述接下来的具体行动计划..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="risksIssues">风险和问题:</label>
            <textarea id="risksIssues" name="risksIssues" rows="3" 
                      placeholder="描述遇到的风险、问题或需要支持的地方..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="attachments">相关附件:</label>
            <input type="file" id="attachments" name="attachments" multiple 
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png">
            <div class="file-upload-hint">支持上传文档、图片等相关文件</div>
          </div>
          
          <div class="form-actions">
            <button type="submit">更新进度</button>
            <button type="button" onclick="closeProgressModal()">取消</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
```

**行动进度管理JavaScript：**

```javascript
// 行动进度管理类
class ActionProgressManager {
  
  constructor() {
    this.currentActionId = null;
  }
  
  // 显示进度更新界面
  showProgressUpdateModal(actionId) {
    this.currentActionId = actionId;
    
    // 加载行动详情和当前进度
    google.script.run
      .withSuccessHandler(data => this.renderProgressModal(data))
      .withFailureHandler(error => this.handleError(error))
      .getActionProgressDetails(actionId);
    
    document.getElementById('actionProgressModal').style.display = 'block';
  }
  
  // 渲染进度模态框
  renderProgressModal(data) {
    document.getElementById('actionId').textContent = data.actionId;
    document.getElementById('relatedInsight').textContent = data.relatedInsightId;
    document.getElementById('currentActionStatus').textContent = data.currentStatus;
    
    // 更新进度条
    this.updateProgressBar(data.currentProgress);
    
    // 预填充表单
    document.getElementById('progressPercentage').value = data.currentProgress;
    document.getElementById('statusUpdate').value = data.currentStatus;
    document.getElementById('budgetSpent').value = data.budgetSpent || 0;
    document.getElementById('budgetCurrency').textContent = data.budgetCurrency;
    
    // 渲染里程碑进度
    this.renderMilestonesProgress(data.milestones);
  }
  
  // 更新进度显示
  updateProgressDisplay(value) {
    document.getElementById('progressValue').textContent = value + '%';
    this.updateProgressBar(value);
  }
  
  // 更新进度条
  updateProgressBar(percentage) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    progressFill.style.width = percentage + '%';
    progressText.textContent = percentage + '%';
    
    // 根据进度改变颜色
    if (percentage < 30) {
      progressFill.className = 'progress-fill low';
    } else if (percentage < 70) {
      progressFill.className = 'progress-fill medium';
    } else {
      progressFill.className = 'progress-fill high';
    }
  }
  
  // 渲染里程碑进度
  renderMilestonesProgress(milestones) {
    const container = document.getElementById('milestonesProgress');
    container.innerHTML = '';
    
    milestones.forEach((milestone, index) => {
      const milestoneDiv = document.createElement('div');
      milestoneDiv.className = 'milestone-progress-item';
      milestoneDiv.innerHTML = `
        <div class="milestone-info">
          <span class="milestone-name">${milestone.name}</span>
          <span class="milestone-date">${milestone.date}</span>
        </div>
        <div class="milestone-status">
          <select name="milestoneStatus[]" data-milestone-index="${index}">
            <option value="pending" ${milestone.status === 'pending' ? 'selected' : ''}>待开始</option>
            <option value="in_progress" ${milestone.status === 'in_progress' ? 'selected' : ''}>进行中</option>
            <option value="completed" ${milestone.status === 'completed' ? 'selected' : ''}>已完成</option>
            <option value="delayed" ${milestone.status === 'delayed' ? 'selected' : ''}>延期</option>
          </select>
        </div>
      `;
      container.appendChild(milestoneDiv);
    });
  }
  
  // 提交进度更新
  submitProgressUpdate(formData) {
    const progressData = {
      actionId: this.currentActionId,
      progressPercentage: formData.progressPercentage,
      statusUpdate: formData.statusUpdate,
      progressNotes: formData.progressNotes,
      budgetSpent: formData.budgetSpent,
      nextSteps: formData.nextSteps,
      risksIssues: formData.risksIssues,
      milestonesStatus: this.getMilestonesStatus(),
      updatedBy: Session.getActiveUser().getEmail(),
      updatedAt: new Date().toISOString()
    };
    
    // 处理文件上传
    const attachments = document.getElementById('attachments').files;
    if (attachments.length > 0) {
      this.uploadAttachments(attachments, progressData);
    } else {
      this.saveProgressUpdate(progressData);
    }
  }
  
  // 获取里程碑状态
  getMilestonesStatus() {
    const milestoneSelects = document.querySelectorAll('select[name="milestoneStatus[]"]');
    const milestonesStatus = [];
    
    milestoneSelects.forEach(select => {
      milestonesStatus.push({
        index: select.dataset.milestoneIndex,
        status: select.value
      });
    });
    
    return milestonesStatus;
  }
  
  // 保存进度更新
  saveProgressUpdate(progressData) {
    google.script.run
      .withSuccessHandler(result => this.handleUpdateSuccess(result))
      .withFailureHandler(error => this.handleUpdateError(error))
      .updateActionProgress(progressData);
  }
  
  // 处理更新成功
  handleUpdateSuccess(result) {
    this.showMessage('进度更新成功！', 'success');
    
    // 刷新相关数据显示
    this.refreshActionData();
    
    // 关闭模态框
    setTimeout(() => {
      this.closeModal();
    }, 2000);
  }
  
  // 处理更新错误
  handleUpdateError(error) {
    this.showMessage(`更新失败: ${error.message}`, 'error');
  }
}

// 初始化进度管理器
const actionProgressManager = new ActionProgressManager();

// 进度更新表单提交处理
document.getElementById('progressUpdateForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  actionProgressManager.submitProgressUpdate(data);
});
```

**后端进度更新服务：**

```javascript
// 更新行动进度
function updateActionProgress(progressData) {
  try {
    // 获取行动建议表
    const actionSheet = SpreadsheetApp.openById(ACTION_RECOMMENDATIONS_SHEET_ID)
                                    .getSheetByName('Action_Recommendations');
    
    const data = actionSheet.getDataRange().getValues();
    const headers = data[0];
    
    // 查找对应的行动记录
    const actionIdCol = headers.indexOf('action_id');
    let targetRow = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][actionIdCol] === progressData.actionId) {
        targetRow = i + 1;
        break;
      }
    }
    
    if (targetRow === -1) {
      throw new Error('未找到对应的行动记录');
    }
    
    // 更新进度相关字段
    const progressCol = headers.indexOf('progress_percentage');
    const statusCol = headers.indexOf('status');
    const notesCol = headers.indexOf('progress_notes');
    const budgetSpentCol = headers.indexOf('budget_spent');
    const updatedAtCol = headers.indexOf('updated_at');
    const updatedByCol = headers.indexOf('updated_by');
    
    actionSheet.getRange(targetRow, progressCol + 1).setValue(progressData.progressPercentage);
    actionSheet.getRange(targetRow, statusCol + 1).setValue(progressData.statusUpdate);
    actionSheet.getRange(targetRow, notesCol + 1).setValue(progressData.progressNotes);
    actionSheet.getRange(targetRow, budgetSpentCol + 1).setValue(progressData.budgetSpent);
    actionSheet.getRange(targetRow, updatedAtCol + 1).setValue(progressData.updatedAt);
    actionSheet.getRange(targetRow, updatedByCol + 1).setValue(progressData.updatedBy);
    
    // 记录进度历史
    recordProgressHistory(progressData);
    
    // 更新里程碑状态
    if (progressData.milestonesStatus) {
      updateMilestonesStatus(progressData.actionId, progressData.milestonesStatus);
    }
    
    // 如果行动完成，更新相关洞察状态
    if (progressData.statusUpdate === 'completed') {
      updateRelatedInsightStatus(progressData.actionId, 'action_completed');
    }
    
    return {
      success: true,
      actionId: progressData.actionId,
      message: '进度更新成功'
    };
    
  } catch (error) {
    console.error('更新行动进度失败:', error);
    throw new Error(`更新失败: ${error.message}`);
  }
}

// 记录进度历史
function recordProgressHistory(progressData) {
  try {
    // 获取或创建进度历史表
    const historySheet = getOrCreateProgressHistorySheet();
    
    const historyData = [
      generateProgressHistoryId(),
      progressData.actionId,
      progressData.progressPercentage,
      progressData.statusUpdate,
      progressData.progressNotes,
      progressData.nextSteps,
      progressData.risksIssues,
      progressData.updatedBy,
      progressData.updatedAt
    ];
    
    historySheet.appendRow(historyData);
    
  } catch (error) {
    console.error('记录进度历史失败:', error);
    // 历史记录失败不应该影响主流程
  }
}


// 获取或创建进度历史表
function getOrCreateProgressHistorySheet() {
  const spreadsheet = SpreadsheetApp.openById(ACTION_RECOMMENDATIONS_SHEET_ID);
  let historySheet = spreadsheet.getSheetByName('Progress_History');
  
  if (!historySheet) {
    historySheet = spreadsheet.insertSheet('Progress_History');
    const headers = [
      'history_id', 'action_id', 'progress_percentage', 'status',
      'progress_notes', 'next_steps', 'risks_issues', 'updated_by', 'updated_at'
    ];
    historySheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }
  
  return historySheet;
}

// 生成进度历史ID
function generateProgressHistoryId() {
  const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').substring(0, 14);
  const random = Math.random().toString(36).substring(2, 4).toUpperCase();
  return `PH${timestamp}${random}`;
}
```

这个完善版本的设计文档现在包含了：

1. **全系统数字点击展开功能** - 所有页面的数字指标都支持点击展开，统一的交互规范和样式
2. **高价值线索行动输入功能** - 完整的行动计划输入界面，支持详细的行动规划和数据库写入
3. **行动进度跟踪和更新** - 支持行动执行过程中的进度更新、状态变更和历史记录
4. **数据库集成** - 完整的后端服务，支持数据的读取、写入和更新操作
5. **通知和提醒机制** - 行动分配通知、进度提醒等功能

整个系统设计确保了从技术洞察发现到行动执行的完整闭环管理，为决策者提供了强大的技术情报分析和行动管理能力。
